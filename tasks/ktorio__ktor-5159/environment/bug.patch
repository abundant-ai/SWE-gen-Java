diff --git a/ktor-client/ktor-client-core/common/src/io/ktor/client/plugins/HttpRequestRetry.kt b/ktor-client/ktor-client-core/common/src/io/ktor/client/plugins/HttpRequestRetry.kt
index 6554a9ea2..25f097182 100644
--- a/ktor-client/ktor-client-core/common/src/io/ktor/client/plugins/HttpRequestRetry.kt
+++ b/ktor-client/ktor-client-core/common/src/io/ktor/client/plugins/HttpRequestRetry.kt
@@ -325,11 +325,6 @@ public val HttpRequestRetry: ClientPlugin<HttpRequestRetryConfig> = createClient
         return subRequest
     }
 
-    onRequest { request, _ ->
-        val maxRetriesValue = request.attributes.getOrNull(MaxRetriesPerRequestAttributeKey) ?: maxRetries
-        request.attributes.put(MaxRetriesPerRequestAttributeKey, maxRetriesValue)
-    }
-
     on(Send) { request ->
         var retryCount = 0
         val shouldRetry = request.attributes.getOrNull(ShouldRetryPerRequestAttributeKey) ?: shouldRetry
@@ -381,8 +376,8 @@ public val HttpRequestRetry: ClientPlugin<HttpRequestRetryConfig> = createClient
 }
 
 /**
- * A context for [HttpRequestRetryConfig.shouldRetry]
- * and [HttpRequestRetryConfig.shouldRetryOnException]
+ * A context for [HttpRequestRetry.Configuration.shouldRetry]
+ * and [HttpRequestRetry.Configuration.shouldRetryOnException]
  *
  * [Report a problem](https://ktor.io/feedback/?fqname=io.ktor.client.plugins.HttpRetryShouldRetryContext)
  */
@@ -394,7 +389,7 @@ public class HttpRetryShouldRetryContext(
 )
 
 /**
- * A context for [HttpRequestRetryConfig.delayMillis].
+ * A context for [HttpRequestRetry.Configuration.delayMillis].
  * Contains a non-null [response] or [cause] but not both.
  *
  * [Report a problem](https://ktor.io/feedback/?fqname=io.ktor.client.plugins.HttpRetryDelayContext)
@@ -406,7 +401,7 @@ public class HttpRetryDelayContext internal constructor(
 )
 
 /**
- * A context for [HttpRequestRetryConfig.modifyRequest].
+ * A context for [HttpRequestRetry.Configuration.modifyRequest].
  * Contains a non-null [response] or [cause] but not both.
  *
  * [Report a problem](https://ktor.io/feedback/?fqname=io.ktor.client.plugins.HttpRetryModifyRequestContext)
@@ -450,7 +445,8 @@ public fun HttpRequestBuilder.retry(block: HttpRequestRetryConfig.() -> Unit) {
     attributes.put(ModifyRequestPerRequestAttributeKey, configuration.modifyRequest)
 }
 
-internal val MaxRetriesPerRequestAttributeKey = AttributeKey<Int>("MaxRetriesPerRequestAttributeKey")
+private val MaxRetriesPerRequestAttributeKey =
+    AttributeKey<Int>("MaxRetriesPerRequestAttributeKey")
 
 private val ShouldRetryPerRequestAttributeKey =
     AttributeKey<HttpRetryShouldRetryContext.(HttpRequest, HttpResponse) -> Boolean>(
diff --git a/ktor-client/ktor-client-core/common/src/io/ktor/client/plugins/HttpSend.kt b/ktor-client/ktor-client-core/common/src/io/ktor/client/plugins/HttpSend.kt
index ed90b3383..163940eb0 100644
--- a/ktor-client/ktor-client-core/common/src/io/ktor/client/plugins/HttpSend.kt
+++ b/ktor-client/ktor-client-core/common/src/io/ktor/client/plugins/HttpSend.kt
@@ -11,7 +11,7 @@ import io.ktor.http.*
 import io.ktor.http.content.*
 import io.ktor.util.*
 import io.ktor.utils.io.*
-import kotlinx.coroutines.cancel
+import kotlinx.coroutines.*
 
 /**
  * HttpSend pipeline interceptor function
@@ -89,13 +89,8 @@ public class HttpSend private constructor(
                         .trimMargin()
                 }
                 context.setBody(content)
-                val maxRetriesFromRetryPlugin = context.attributes.getOrNull(MaxRetriesPerRequestAttributeKey)
-                val maxRetries = if (maxRetriesFromRetryPlugin != null) {
-                    maxRetriesFromRetryPlugin + 1 // +1 for the initial request
-                } else {
-                    plugin.maxSendCount
-                }
-                val realSender: Sender = DefaultSender(maxRetries, scope)
+
+                val realSender: Sender = DefaultSender(plugin.maxSendCount, scope)
                 var interceptedSender = realSender
                 for (interceptor in plugin.interceptors.reversed()) {
                     interceptedSender = InterceptedSender(interceptor, interceptedSender)
diff --git a/ktor-client/ktor-client-tests/common/test/io/ktor/client/tests/HttpRequestRetryTest.kt b/ktor-client/ktor-client-tests/common/test/io/ktor/client/tests/HttpRequestRetryTest.kt
index 99151008e..ec7ff475c 100644
--- a/ktor-client/ktor-client-tests/common/test/io/ktor/client/tests/HttpRequestRetryTest.kt
+++ b/ktor-client/ktor-client-tests/common/test/io/ktor/client/tests/HttpRequestRetryTest.kt
@@ -516,35 +516,4 @@ class HttpRequestRetryTest {
             assertEquals(HttpStatusCode.OK, response.status)
         }
     }
-
-    @Test
-    fun testRetryHasPriorityOverHttpSend() = testWithEngine(MockEngine) {
-        val maxRetriesCount = 5
-        var counter = 1
-        config {
-            engine {
-                addHandler {
-                    if (counter < maxRetriesCount) {
-                        counter++
-                        respondError(HttpStatusCode.InternalServerError)
-                    } else {
-                        respondOk()
-                    }
-                }
-            }
-
-            install(HttpRequestRetry) {
-                retryOnServerErrors(maxRetriesCount)
-                delayMillis { 0L }
-            }
-            install(HttpSend) {
-                maxSendCount = 1
-            }
-        }
-
-        test { client ->
-            assertEquals(HttpStatusCode.OK, client.get("/").status)
-            assertEquals(maxRetriesCount, counter)
-        }
-    }
 }
diff --git a/ktor-server/ktor-server-core/common/src/io/ktor/server/routing/RoutingNode.kt b/ktor-server/ktor-server-core/common/src/io/ktor/server/routing/RoutingNode.kt
index 4449276c1..64e586892 100644
--- a/ktor-server/ktor-server-core/common/src/io/ktor/server/routing/RoutingNode.kt
+++ b/ktor-server/ktor-server-core/common/src/io/ktor/server/routing/RoutingNode.kt
@@ -357,7 +357,7 @@ private fun RoutingNode.getAllRoutes(endpoints: MutableList<RoutingNode>) {
 public val RoutingNode.path: String
     get() = path()
 
-private fun RoutingNode.path(): String {
+internal fun RoutingNode.path(): String {
     val parentPath = parent?.path()
     val selectorElement = selector.toPathElement()
     return when {
@@ -368,16 +368,9 @@ private fun RoutingNode.path(): String {
     }
 }
 
-private fun RouteSelector.toPathElement(): String = when (this) {
-    is PathSegmentConstantRouteSelector,
-    is PathSegmentParameterRouteSelector,
-    is PathSegmentOptionalParameterRouteSelector,
-    is PathSegmentTailcardRouteSelector,
-    is PathSegmentWildcardRouteSelector,
-    is PathSegmentRegexRouteSelector -> toString()
-
-    is TrailingSlashRouteSelector -> "/"
-
+private fun RouteSelector.toPathElement(): String = when {
+    isPathElement() -> toString()
+    this is TrailingSlashRouteSelector -> "/"
     else -> ""
 }
 
diff --git a/ktor-server/ktor-server-core/common/src/io/ktor/server/routing/RoutingResolveResult.kt b/ktor-server/ktor-server-core/common/src/io/ktor/server/routing/RoutingResolveResult.kt
index 35ba31b55..3bc163312 100644
--- a/ktor-server/ktor-server-core/common/src/io/ktor/server/routing/RoutingResolveResult.kt
+++ b/ktor-server/ktor-server-core/common/src/io/ktor/server/routing/RoutingResolveResult.kt
@@ -39,7 +39,8 @@ public sealed class RoutingResolveResult(public val route: RoutingNode) {
         )
         public constructor(route: RoutingNode, parameters: Parameters) : this(route, parameters, 0.0)
 
-        override fun toString(): String = "SUCCESS${if (parameters.isEmpty()) "" else "; $parameters"} @ $route"
+        override fun toString(): String =
+            "SUCCESS${if (parameters.isEmpty()) "" else "; $parameters"} @ ${route.render()}"
     }
 
     /**
@@ -64,6 +65,6 @@ public sealed class RoutingResolveResult(public val route: RoutingNode) {
         override val parameters: Nothing
             get() = throw UnsupportedOperationException("Parameters are available only when routing resolve succeeds")
 
-        override fun toString(): String = "FAILURE \"$reason\" @ $route"
+        override fun toString(): String = "FAILURE \"$reason\" @ ${route.render()}"
     }
 }
diff --git a/ktor-server/ktor-server-core/common/src/io/ktor/server/routing/RoutingResolveTrace.kt b/ktor-server/ktor-server-core/common/src/io/ktor/server/routing/RoutingResolveTrace.kt
index b1784dc01..04fdb97ac 100644
--- a/ktor-server/ktor-server-core/common/src/io/ktor/server/routing/RoutingResolveTrace.kt
+++ b/ktor-server/ktor-server-core/common/src/io/ktor/server/routing/RoutingResolveTrace.kt
@@ -45,7 +45,7 @@ public open class RoutingResolveTraceEntry(
         children?.forEach { it.buildText(builder, indent + 1) }
     }
 
-    override fun toString(): String = "$route, segment:$segmentIndex -> $result"
+    override fun toString(): String = "${route.render()}, segment:$segmentIndex -> $result"
 }
 
 /**
@@ -168,3 +168,34 @@ private class Stack<E> {
         return tower.last()
     }
 }
+
+internal fun RoutingNode.render(): String {
+    val path = path.ifEmpty { "/" }
+    val constraints = buildConstraints()
+    return if (constraints.isEmpty()) path else "$path [$constraints]"
+}
+
+private fun RoutingNode.buildConstraints(): String {
+    val parentConstraints = parent?.buildConstraints()
+    if (selector.isPathElement()) {
+        return parentConstraints ?: ""
+    }
+
+    val selectorElement = selector.toString()
+    return when {
+        parentConstraints == null || parentConstraints.isEmpty() -> selectorElement
+        selectorElement.isEmpty() -> parentConstraints
+        else -> "$parentConstraints, $selectorElement"
+    }
+}
+
+internal fun RouteSelector.isPathElement(): Boolean = when (this) {
+    is PathSegmentConstantRouteSelector,
+    is PathSegmentParameterRouteSelector,
+    is PathSegmentOptionalParameterRouteSelector,
+    is PathSegmentTailcardRouteSelector,
+    is PathSegmentWildcardRouteSelector,
+    is PathSegmentRegexRouteSelector -> true
+
+    else -> false
+}
diff --git a/ktor-server/ktor-server-tests/common/test/io/ktor/tests/server/routing/RoutingTracingTest.kt b/ktor-server/ktor-server-tests/common/test/io/ktor/tests/server/routing/RoutingTracingTest.kt
index 30f5425b8..ba0580ddc 100644
--- a/ktor-server/ktor-server-tests/common/test/io/ktor/tests/server/routing/RoutingTracingTest.kt
+++ b/ktor-server/ktor-server-tests/common/test/io/ktor/tests/server/routing/RoutingTracingTest.kt
@@ -23,16 +23,17 @@ class RoutingTracingTest {
     Trace for [bar]
     /, segment:0 -> SUCCESS @ /
       /bar, segment:1 -> SUCCESS @ /bar
-        /bar/(method:GET), segment:1 -> SUCCESS @ /bar/(method:GET)
+        /bar [(method:GET)], segment:1 -> SUCCESS @ /bar [(method:GET)]
       /baz, segment:0 -> FAILURE "Selector didn't match" @ /baz
       /{param}, segment:0 -> FAILURE "Better match was already found" @ /{param}
       /*, segment:0 -> FAILURE "Better match was already found" @ /*
-      /(header:a = x), segment:0 -> FAILURE "Selector didn't match" @ /(header:a = x)
-      /(header:b = x), segment:0 -> FAILURE "Selector didn't match" @ /(header:b = x)
+      / [(header:a = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:a = x)]
+      / [(header:b = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:b = x)]
+      /route, segment:0 -> FAILURE "Selector didn't match" @ /route
     Matched routes:
       "" -> "bar" -> "(method:GET)"
     Routing resolve result:
-      SUCCESS @ /bar/(method:GET)
+      SUCCESS @ /bar [(method:GET)]
             """.trimIndent(),
             trace()
         )
@@ -47,20 +48,21 @@ class RoutingTracingTest {
     Trace for [bar, x]
     /, segment:0 -> SUCCESS @ /
       /bar, segment:1 -> SUCCESS @ /bar
-        /bar/(method:GET), segment:1 -> FAILURE "Not all segments matched" @ /bar/(method:GET)
+        /bar [(method:GET)], segment:1 -> FAILURE "Not all segments matched" @ /bar [(method:GET)]
       /baz, segment:0 -> FAILURE "Selector didn't match" @ /baz
       /{param}, segment:1 -> SUCCESS; Parameters [param=[bar]] @ /{param}
-        /{param}/(method:GET), segment:1 -> FAILURE "Not all segments matched" @ /{param}/(method:GET)
+        /{param} [(method:GET)], segment:1 -> FAILURE "Not all segments matched" @ /{param} [(method:GET)]
         /{param}/x, segment:2 -> SUCCESS @ /{param}/x
-          /{param}/x/(method:GET), segment:2 -> SUCCESS @ /{param}/x/(method:GET)
+          /{param}/x [(method:GET)], segment:2 -> SUCCESS @ /{param}/x [(method:GET)]
           /{param}/x/z, segment:2 -> FAILURE "Selector didn't match" @ /{param}/x/z
       /*, segment:0 -> FAILURE "Better match was already found" @ /*
-      /(header:a = x), segment:0 -> FAILURE "Selector didn't match" @ /(header:a = x)
-      /(header:b = x), segment:0 -> FAILURE "Selector didn't match" @ /(header:b = x)
+      / [(header:a = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:a = x)]
+      / [(header:b = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:b = x)]
+      /route, segment:0 -> FAILURE "Selector didn't match" @ /route
     Matched routes:
       "" -> "{param}" -> "x" -> "(method:GET)"
     Routing resolve result:
-      SUCCESS; Parameters [param=[bar]] @ /{param}/x/(method:GET)
+      SUCCESS; Parameters [param=[bar]] @ /{param}/x [(method:GET)]
             """.trimIndent(),
             trace()
         )
@@ -76,19 +78,20 @@ class RoutingTracingTest {
     /, segment:0 -> SUCCESS @ /
       /bar, segment:0 -> FAILURE "Selector didn't match" @ /bar
       /baz, segment:1 -> SUCCESS @ /baz
-        /baz/(method:GET), segment:1 -> FAILURE "Not all segments matched" @ /baz/(method:GET)
+        /baz [(method:GET)], segment:1 -> FAILURE "Not all segments matched" @ /baz [(method:GET)]
         /baz/x, segment:2 -> SUCCESS @ /baz/x
-          /baz/x/(method:GET), segment:2 -> SUCCESS @ /baz/x/(method:GET)
+          /baz/x [(method:GET)], segment:2 -> SUCCESS @ /baz/x [(method:GET)]
           /baz/x/{optional?}, segment:2 -> FAILURE "Better match was already found" @ /baz/x/{optional?}
         /baz/{y}, segment:1 -> FAILURE "Better match was already found" @ /baz/{y}
       /{param}, segment:0 -> FAILURE "Better match was already found" @ /{param}
       /*, segment:0 -> FAILURE "Better match was already found" @ /*
-      /(header:a = x), segment:0 -> FAILURE "Selector didn't match" @ /(header:a = x)
-      /(header:b = x), segment:0 -> FAILURE "Selector didn't match" @ /(header:b = x)
+      / [(header:a = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:a = x)]
+      / [(header:b = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:b = x)]
+      /route, segment:0 -> FAILURE "Selector didn't match" @ /route
     Matched routes:
       "" -> "baz" -> "x" -> "(method:GET)"
     Routing resolve result:
-      SUCCESS @ /baz/x/(method:GET)
+      SUCCESS @ /baz/x [(method:GET)]
             """.trimIndent(),
             trace()
         )
@@ -104,19 +107,20 @@ class RoutingTracingTest {
     /, segment:0 -> SUCCESS @ /
       /bar, segment:0 -> FAILURE "Selector didn't match" @ /bar
       /baz, segment:1 -> SUCCESS @ /baz
-        /baz/(method:GET), segment:1 -> FAILURE "Not all segments matched" @ /baz/(method:GET)
+        /baz [(method:GET)], segment:1 -> FAILURE "Not all segments matched" @ /baz [(method:GET)]
         /baz/x, segment:1 -> FAILURE "Selector didn't match" @ /baz/x
         /baz/{y}, segment:2 -> SUCCESS; Parameters [y=[doo]] @ /baz/{y}
-          /baz/{y}/(method:GET), segment:2 -> SUCCESS @ /baz/{y}/(method:GET)
+          /baz/{y} [(method:GET)], segment:2 -> SUCCESS @ /baz/{y} [(method:GET)]
           /baz/{y}/value, segment:2 -> FAILURE "Selector didn't match" @ /baz/{y}/value
       /{param}, segment:0 -> FAILURE "Better match was already found" @ /{param}
       /*, segment:0 -> FAILURE "Better match was already found" @ /*
-      /(header:a = x), segment:0 -> FAILURE "Selector didn't match" @ /(header:a = x)
-      /(header:b = x), segment:0 -> FAILURE "Selector didn't match" @ /(header:b = x)
+      / [(header:a = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:a = x)]
+      / [(header:b = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:b = x)]
+      /route, segment:0 -> FAILURE "Selector didn't match" @ /route
     Matched routes:
       "" -> "baz" -> "{y}" -> "(method:GET)"
     Routing resolve result:
-      SUCCESS; Parameters [y=[doo]] @ /baz/{y}/(method:GET)
+      SUCCESS; Parameters [y=[doo]] @ /baz/{y} [(method:GET)]
             """.trimIndent(),
             trace()
         )
@@ -132,20 +136,21 @@ class RoutingTracingTest {
     /, segment:0 -> SUCCESS @ /
       /bar, segment:0 -> FAILURE "Selector didn't match" @ /bar
       /baz, segment:1 -> SUCCESS @ /baz
-        /baz/(method:GET), segment:1 -> FAILURE "Not all segments matched" @ /baz/(method:GET)
+        /baz [(method:GET)], segment:1 -> FAILURE "Not all segments matched" @ /baz [(method:GET)]
         /baz/x, segment:2 -> SUCCESS @ /baz/x
-          /baz/x/(method:GET), segment:2 -> FAILURE "Not all segments matched" @ /baz/x/(method:GET)
+          /baz/x [(method:GET)], segment:2 -> FAILURE "Not all segments matched" @ /baz/x [(method:GET)]
           /baz/x/{optional?}, segment:3 -> SUCCESS; Parameters [optional=[z]] @ /baz/x/{optional?}
-            /baz/x/{optional?}/(method:GET), segment:3 -> SUCCESS @ /baz/x/{optional?}/(method:GET)
+            /baz/x/{optional?} [(method:GET)], segment:3 -> SUCCESS @ /baz/x/{optional?} [(method:GET)]
         /baz/{y}, segment:1 -> FAILURE "Better match was already found" @ /baz/{y}
       /{param}, segment:0 -> FAILURE "Better match was already found" @ /{param}
       /*, segment:0 -> FAILURE "Better match was already found" @ /*
-      /(header:a = x), segment:0 -> FAILURE "Selector didn't match" @ /(header:a = x)
-      /(header:b = x), segment:0 -> FAILURE "Selector didn't match" @ /(header:b = x)
+      / [(header:a = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:a = x)]
+      / [(header:b = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:b = x)]
+      /route, segment:0 -> FAILURE "Selector didn't match" @ /route
     Matched routes:
       "" -> "baz" -> "x" -> "{optional?}" -> "(method:GET)"
     Routing resolve result:
-      SUCCESS; Parameters [optional=[z]] @ /baz/x/{optional?}/(method:GET)
+      SUCCESS; Parameters [optional=[z]] @ /baz/x/{optional?} [(method:GET)]
             """.trimIndent(),
             trace()
         )
@@ -161,20 +166,21 @@ class RoutingTracingTest {
     /, segment:0 -> SUCCESS @ /
       /bar, segment:0 -> FAILURE "Selector didn't match" @ /bar
       /baz, segment:1 -> SUCCESS @ /baz
-        /baz/(method:GET), segment:1 -> FAILURE "Not all segments matched" @ /baz/(method:GET)
+        /baz [(method:GET)], segment:1 -> FAILURE "Not all segments matched" @ /baz [(method:GET)]
         /baz/x, segment:2 -> SUCCESS @ /baz/x
-          /baz/x/(method:GET), segment:2 -> FAILURE "Not all segments matched" @ /baz/x/(method:GET)
+          /baz/x [(method:GET)], segment:2 -> FAILURE "Not all segments matched" @ /baz/x [(method:GET)]
           /baz/x/{optional?}, segment:3 -> SUCCESS; Parameters [optional=[value]] @ /baz/x/{optional?}
-            /baz/x/{optional?}/(method:GET), segment:3 -> SUCCESS @ /baz/x/{optional?}/(method:GET)
+            /baz/x/{optional?} [(method:GET)], segment:3 -> SUCCESS @ /baz/x/{optional?} [(method:GET)]
         /baz/{y}, segment:1 -> FAILURE "Better match was already found" @ /baz/{y}
       /{param}, segment:0 -> FAILURE "Better match was already found" @ /{param}
       /*, segment:0 -> FAILURE "Better match was already found" @ /*
-      /(header:a = x), segment:0 -> FAILURE "Selector didn't match" @ /(header:a = x)
-      /(header:b = x), segment:0 -> FAILURE "Selector didn't match" @ /(header:b = x)
+      / [(header:a = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:a = x)]
+      / [(header:b = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:b = x)]
+      /route, segment:0 -> FAILURE "Selector didn't match" @ /route
     Matched routes:
       "" -> "baz" -> "x" -> "{optional?}" -> "(method:GET)"
     Routing resolve result:
-      SUCCESS; Parameters [optional=[value]] @ /baz/x/{optional?}/(method:GET)
+      SUCCESS; Parameters [optional=[value]] @ /baz/x/{optional?} [(method:GET)]
             """.trimIndent(),
             trace()
         )
@@ -191,15 +197,16 @@ class RoutingTracingTest {
       /bar, segment:0 -> FAILURE "Selector didn't match" @ /bar
       /baz, segment:0 -> FAILURE "Selector didn't match" @ /baz
       /{param}, segment:1 -> SUCCESS; Parameters [param=[p]] @ /{param}
-        /{param}/(method:GET), segment:1 -> SUCCESS @ /{param}/(method:GET)
+        /{param} [(method:GET)], segment:1 -> SUCCESS @ /{param} [(method:GET)]
         /{param}/x, segment:1 -> FAILURE "Selector didn't match" @ /{param}/x
       /*, segment:0 -> FAILURE "Better match was already found" @ /*
-      /(header:a = x), segment:0 -> FAILURE "Selector didn't match" @ /(header:a = x)
-      /(header:b = x), segment:0 -> FAILURE "Selector didn't match" @ /(header:b = x)
+      / [(header:a = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:a = x)]
+      / [(header:b = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:b = x)]
+      /route, segment:0 -> FAILURE "Selector didn't match" @ /route
     Matched routes:
       "" -> "{param}" -> "(method:GET)"
     Routing resolve result:
-      SUCCESS; Parameters [param=[p]] @ /{param}/(method:GET)
+      SUCCESS; Parameters [param=[p]] @ /{param} [(method:GET)]
             """.trimIndent(),
             trace()
         )
@@ -216,17 +223,18 @@ class RoutingTracingTest {
       /bar, segment:0 -> FAILURE "Selector didn't match" @ /bar
       /baz, segment:0 -> FAILURE "Selector didn't match" @ /baz
       /{param}, segment:1 -> SUCCESS; Parameters [param=[p]] @ /{param}
-        /{param}/(method:GET), segment:1 -> FAILURE "Not all segments matched" @ /{param}/(method:GET)
+        /{param} [(method:GET)], segment:1 -> FAILURE "Not all segments matched" @ /{param} [(method:GET)]
         /{param}/x, segment:2 -> SUCCESS @ /{param}/x
-          /{param}/x/(method:GET), segment:2 -> SUCCESS @ /{param}/x/(method:GET)
+          /{param}/x [(method:GET)], segment:2 -> SUCCESS @ /{param}/x [(method:GET)]
           /{param}/x/z, segment:2 -> FAILURE "Selector didn't match" @ /{param}/x/z
       /*, segment:0 -> FAILURE "Better match was already found" @ /*
-      /(header:a = x), segment:0 -> FAILURE "Selector didn't match" @ /(header:a = x)
-      /(header:b = x), segment:0 -> FAILURE "Selector didn't match" @ /(header:b = x)
+      / [(header:a = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:a = x)]
+      / [(header:b = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:b = x)]
+      /route, segment:0 -> FAILURE "Selector didn't match" @ /route
     Matched routes:
       "" -> "{param}" -> "x" -> "(method:GET)"
     Routing resolve result:
-      SUCCESS; Parameters [param=[p]] @ /{param}/x/(method:GET)
+      SUCCESS; Parameters [param=[p]] @ /{param}/x [(method:GET)]
             """.trimIndent(),
             trace()
         )
@@ -250,15 +258,47 @@ class RoutingTracingTest {
       /baz, segment:0 -> FAILURE "Selector didn't match" @ /baz
       /{param}, segment:0 -> FAILURE "Selector didn't match" @ /{param}
       /*, segment:0 -> FAILURE "Selector didn't match" @ /*
-      /(header:a = x), segment:0 -> SUCCESS @ /(header:a = x)
-        /(header:a = x)/(method:GET), segment:0 -> SUCCESS @ /(header:a = x)/(method:GET)
-      /(header:b = x), segment:0 -> SUCCESS @ /(header:b = x)
-        /(header:b = x)/(method:GET), segment:0 -> SUCCESS @ /(header:b = x)/(method:GET)
+      / [(header:a = x)], segment:0 -> SUCCESS @ / [(header:a = x)]
+        / [(header:a = x), (method:GET)], segment:0 -> SUCCESS @ / [(header:a = x), (method:GET)]
+      / [(header:b = x)], segment:0 -> SUCCESS @ / [(header:b = x)]
+        / [(header:b = x), (method:GET)], segment:0 -> SUCCESS @ / [(header:b = x), (method:GET)]
+      /route, segment:0 -> FAILURE "Selector didn't match" @ /route
     Matched routes:
       "" -> "(header:a = x)" -> "(method:GET)"
       "" -> "(header:b = x)" -> "(method:GET)"
     Routing resolve result:
-      SUCCESS @ /(header:a = x)/(method:GET)
+      SUCCESS @ / [(header:a = x), (method:GET)]
+            """.trimIndent(),
+            trace()
+        )
+    }
+
+    @Test
+    fun testPathAndConditionSelectors() = tracingApplication { trace ->
+        val response = client.get("/route/port")
+        assertEquals("port", response.bodyAsText())
+
+        assertEquals(
+            $$"""
+    Trace for [route, port]
+    /, segment:0 -> SUCCESS @ /
+      /bar, segment:0 -> FAILURE "Selector didn't match" @ /bar
+      /baz, segment:0 -> FAILURE "Selector didn't match" @ /baz
+      /{param}, segment:1 -> SUCCESS; Parameters [param=[route]] @ /{param}
+        /{param} [(method:GET)], segment:1 -> FAILURE "Not all segments matched" @ /{param} [(method:GET)]
+        /{param}/x, segment:1 -> FAILURE "Selector didn't match" @ /{param}/x
+      /*, segment:1 -> SUCCESS @ /*
+        /*/extra, segment:1 -> FAILURE "Selector didn't match" @ /*/extra
+      / [(header:a = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:a = x)]
+      / [(header:b = x)], segment:0 -> FAILURE "Selector didn't match" @ / [(header:b = x)]
+      /route, segment:1 -> SUCCESS @ /route
+        /route [LocalPortRouteSelector(port=80)], segment:1 -> SUCCESS; Parameters [$LocalPort=[80]] @ /route [LocalPortRouteSelector(port=80)]
+          /route/port [LocalPortRouteSelector(port=80)], segment:2 -> SUCCESS @ /route/port [LocalPortRouteSelector(port=80)]
+            /route/port [LocalPortRouteSelector(port=80), (method:GET)], segment:2 -> SUCCESS @ /route/port [LocalPortRouteSelector(port=80), (method:GET)]
+    Matched routes:
+      "" -> "route" -> "LocalPortRouteSelector(port=80)" -> "port" -> "(method:GET)"
+    Routing resolve result:
+      SUCCESS; Parameters [$LocalPort=[80]] @ /route/port [LocalPortRouteSelector(port=80), (method:GET)]
             """.trimIndent(),
             trace()
         )
@@ -294,5 +334,6 @@ class RoutingTracingTest {
         get("/*/extra") { call.respond("/*/extra") }
         header("a", "x") { get { call.respond("a") } }
         header("b", "x") { get { call.respond("b") } }
+        route("/route") { localPort(80) { get("/port") { call.respond("port") } } }
     }
 }

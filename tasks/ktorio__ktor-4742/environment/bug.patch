diff --git a/ktor-server/ktor-server-plugins/ktor-server-di/api/ktor-server-di.api b/ktor-server/ktor-server-plugins/ktor-server-di/api/ktor-server-di.api
index fc7b1cca1..726a71d73 100644
--- a/ktor-server/ktor-server-plugins/ktor-server-di/api/ktor-server-di.api
+++ b/ktor-server/ktor-server-plugins/ktor-server-di/api/ktor-server-di.api
@@ -31,7 +31,6 @@ public abstract interface class io/ktor/server/plugins/di/DependencyConflictPoli
 
 public final class io/ktor/server/plugins/di/DependencyConflictPolicyKt {
 	public static final fun getDefaultConflictPolicy ()Lio/ktor/server/plugins/di/DependencyConflictPolicy;
-	public static final fun getLastEntryWinsPolicy ()Lio/ktor/server/plugins/di/DependencyConflictPolicy;
 }
 
 public abstract interface class io/ktor/server/plugins/di/DependencyConflictResult {
@@ -39,41 +38,23 @@ public abstract interface class io/ktor/server/plugins/di/DependencyConflictResu
 
 public final class io/ktor/server/plugins/di/DependencyConflictResult$Ambiguous : io/ktor/server/plugins/di/DependencyConflictResult {
 	public static final field INSTANCE Lio/ktor/server/plugins/di/DependencyConflictResult$Ambiguous;
-	public fun equals (Ljava/lang/Object;)Z
-	public fun hashCode ()I
-	public fun toString ()Ljava/lang/String;
 }
 
 public final class io/ktor/server/plugins/di/DependencyConflictResult$Conflict : io/ktor/server/plugins/di/DependencyConflictResult {
 	public static final field INSTANCE Lio/ktor/server/plugins/di/DependencyConflictResult$Conflict;
-	public fun equals (Ljava/lang/Object;)Z
-	public fun hashCode ()I
-	public fun toString ()Ljava/lang/String;
 }
 
 public final class io/ktor/server/plugins/di/DependencyConflictResult$KeepNew : io/ktor/server/plugins/di/DependencyConflictResult {
 	public static final field INSTANCE Lio/ktor/server/plugins/di/DependencyConflictResult$KeepNew;
-	public fun equals (Ljava/lang/Object;)Z
-	public fun hashCode ()I
-	public fun toString ()Ljava/lang/String;
 }
 
 public final class io/ktor/server/plugins/di/DependencyConflictResult$KeepPrevious : io/ktor/server/plugins/di/DependencyConflictResult {
 	public static final field INSTANCE Lio/ktor/server/plugins/di/DependencyConflictResult$KeepPrevious;
-	public fun equals (Ljava/lang/Object;)Z
-	public fun hashCode ()I
-	public fun toString ()Ljava/lang/String;
 }
 
 public final class io/ktor/server/plugins/di/DependencyConflictResult$Replace : io/ktor/server/plugins/di/DependencyConflictResult {
 	public fun <init> (Lio/ktor/server/plugins/di/DependencyCreateFunction;)V
-	public final fun component1 ()Lio/ktor/server/plugins/di/DependencyCreateFunction;
-	public final fun copy (Lio/ktor/server/plugins/di/DependencyCreateFunction;)Lio/ktor/server/plugins/di/DependencyConflictResult$Replace;
-	public static synthetic fun copy$default (Lio/ktor/server/plugins/di/DependencyConflictResult$Replace;Lio/ktor/server/plugins/di/DependencyCreateFunction;ILjava/lang/Object;)Lio/ktor/server/plugins/di/DependencyConflictResult$Replace;
-	public fun equals (Ljava/lang/Object;)Z
 	public final fun getFunction ()Lio/ktor/server/plugins/di/DependencyCreateFunction;
-	public fun hashCode ()I
-	public fun toString ()Ljava/lang/String;
 }
 
 public class io/ktor/server/plugins/di/DependencyConstructionException : java/lang/IllegalArgumentException {
@@ -255,8 +236,8 @@ public final class io/ktor/server/plugins/di/InvalidDependencyReferenceException
 
 public class io/ktor/server/plugins/di/MapDependencyProvider : io/ktor/server/plugins/di/DependencyProvider {
 	public fun <init> ()V
-	public fun <init> (Lio/ktor/server/plugins/di/DependencyKeyCovariance;Lio/ktor/server/plugins/di/DependencyConflictPolicy;Lkotlin/jvm/functions/Function1;Lorg/slf4j/Logger;)V
-	public synthetic fun <init> (Lio/ktor/server/plugins/di/DependencyKeyCovariance;Lio/ktor/server/plugins/di/DependencyConflictPolicy;Lkotlin/jvm/functions/Function1;Lorg/slf4j/Logger;ILkotlin/jvm/internal/DefaultConstructorMarker;)V
+	public fun <init> (Lio/ktor/server/plugins/di/DependencyKeyCovariance;Lio/ktor/server/plugins/di/DependencyConflictPolicy;Lkotlin/jvm/functions/Function1;)V
+	public synthetic fun <init> (Lio/ktor/server/plugins/di/DependencyKeyCovariance;Lio/ktor/server/plugins/di/DependencyConflictPolicy;Lkotlin/jvm/functions/Function1;ILkotlin/jvm/internal/DefaultConstructorMarker;)V
 	public final fun getConflictPolicy ()Lio/ktor/server/plugins/di/DependencyConflictPolicy;
 	public fun getDeclarations ()Ljava/util/Map;
 	public final fun getKeyMapping ()Lio/ktor/server/plugins/di/DependencyKeyCovariance;
diff --git a/ktor-server/ktor-server-plugins/ktor-server-di/api/ktor-server-di.klib.api b/ktor-server/ktor-server-plugins/ktor-server-di/api/ktor-server-di.klib.api
index 4f171d776..1aed5242d 100644
--- a/ktor-server/ktor-server-plugins/ktor-server-di/api/ktor-server-di.klib.api
+++ b/ktor-server/ktor-server-plugins/ktor-server-di/api/ktor-server-di.klib.api
@@ -47,37 +47,15 @@ sealed interface io.ktor.server.plugins.di/DependencyConflictResult { // io.ktor
 
         final val function // io.ktor.server.plugins.di/DependencyConflictResult.Replace.function|{}function[0]
             final fun <get-function>(): io.ktor.server.plugins.di/DependencyCreateFunction // io.ktor.server.plugins.di/DependencyConflictResult.Replace.function.<get-function>|<get-function>(){}[0]
-
-        final fun component1(): io.ktor.server.plugins.di/DependencyCreateFunction // io.ktor.server.plugins.di/DependencyConflictResult.Replace.component1|component1(){}[0]
-        final fun copy(io.ktor.server.plugins.di/DependencyCreateFunction = ...): io.ktor.server.plugins.di/DependencyConflictResult.Replace // io.ktor.server.plugins.di/DependencyConflictResult.Replace.copy|copy(io.ktor.server.plugins.di.DependencyCreateFunction){}[0]
-        final fun equals(kotlin/Any?): kotlin/Boolean // io.ktor.server.plugins.di/DependencyConflictResult.Replace.equals|equals(kotlin.Any?){}[0]
-        final fun hashCode(): kotlin/Int // io.ktor.server.plugins.di/DependencyConflictResult.Replace.hashCode|hashCode(){}[0]
-        final fun toString(): kotlin/String // io.ktor.server.plugins.di/DependencyConflictResult.Replace.toString|toString(){}[0]
     }
 
-    final object Ambiguous : io.ktor.server.plugins.di/DependencyConflictResult { // io.ktor.server.plugins.di/DependencyConflictResult.Ambiguous|null[0]
-        final fun equals(kotlin/Any?): kotlin/Boolean // io.ktor.server.plugins.di/DependencyConflictResult.Ambiguous.equals|equals(kotlin.Any?){}[0]
-        final fun hashCode(): kotlin/Int // io.ktor.server.plugins.di/DependencyConflictResult.Ambiguous.hashCode|hashCode(){}[0]
-        final fun toString(): kotlin/String // io.ktor.server.plugins.di/DependencyConflictResult.Ambiguous.toString|toString(){}[0]
-    }
+    final object Ambiguous : io.ktor.server.plugins.di/DependencyConflictResult // io.ktor.server.plugins.di/DependencyConflictResult.Ambiguous|null[0]
 
-    final object Conflict : io.ktor.server.plugins.di/DependencyConflictResult { // io.ktor.server.plugins.di/DependencyConflictResult.Conflict|null[0]
-        final fun equals(kotlin/Any?): kotlin/Boolean // io.ktor.server.plugins.di/DependencyConflictResult.Conflict.equals|equals(kotlin.Any?){}[0]
-        final fun hashCode(): kotlin/Int // io.ktor.server.plugins.di/DependencyConflictResult.Conflict.hashCode|hashCode(){}[0]
-        final fun toString(): kotlin/String // io.ktor.server.plugins.di/DependencyConflictResult.Conflict.toString|toString(){}[0]
-    }
+    final object Conflict : io.ktor.server.plugins.di/DependencyConflictResult // io.ktor.server.plugins.di/DependencyConflictResult.Conflict|null[0]
 
-    final object KeepNew : io.ktor.server.plugins.di/DependencyConflictResult { // io.ktor.server.plugins.di/DependencyConflictResult.KeepNew|null[0]
-        final fun equals(kotlin/Any?): kotlin/Boolean // io.ktor.server.plugins.di/DependencyConflictResult.KeepNew.equals|equals(kotlin.Any?){}[0]
-        final fun hashCode(): kotlin/Int // io.ktor.server.plugins.di/DependencyConflictResult.KeepNew.hashCode|hashCode(){}[0]
-        final fun toString(): kotlin/String // io.ktor.server.plugins.di/DependencyConflictResult.KeepNew.toString|toString(){}[0]
-    }
+    final object KeepNew : io.ktor.server.plugins.di/DependencyConflictResult // io.ktor.server.plugins.di/DependencyConflictResult.KeepNew|null[0]
 
-    final object KeepPrevious : io.ktor.server.plugins.di/DependencyConflictResult { // io.ktor.server.plugins.di/DependencyConflictResult.KeepPrevious|null[0]
-        final fun equals(kotlin/Any?): kotlin/Boolean // io.ktor.server.plugins.di/DependencyConflictResult.KeepPrevious.equals|equals(kotlin.Any?){}[0]
-        final fun hashCode(): kotlin/Int // io.ktor.server.plugins.di/DependencyConflictResult.KeepPrevious.hashCode|hashCode(){}[0]
-        final fun toString(): kotlin/String // io.ktor.server.plugins.di/DependencyConflictResult.KeepPrevious.toString|toString(){}[0]
-    }
+    final object KeepPrevious : io.ktor.server.plugins.di/DependencyConflictResult // io.ktor.server.plugins.di/DependencyConflictResult.KeepPrevious|null[0]
 }
 
 sealed interface io.ktor.server.plugins.di/DependencyCreateFunction { // io.ktor.server.plugins.di/DependencyCreateFunction|null[0]
@@ -274,7 +252,7 @@ open class io.ktor.server.plugins.di/DependencyReflectionDisabledException : io.
 }
 
 open class io.ktor.server.plugins.di/MapDependencyProvider : io.ktor.server.plugins.di/DependencyProvider { // io.ktor.server.plugins.di/MapDependencyProvider|null[0]
-    constructor <init>(io.ktor.server.plugins.di/DependencyKeyCovariance = ..., io.ktor.server.plugins.di/DependencyConflictPolicy = ..., kotlin/Function1<io.ktor.server.plugins.di/DependencyKey, kotlin/Unit> = ..., io.ktor.util.logging/Logger = ...) // io.ktor.server.plugins.di/MapDependencyProvider.<init>|<init>(io.ktor.server.plugins.di.DependencyKeyCovariance;io.ktor.server.plugins.di.DependencyConflictPolicy;kotlin.Function1<io.ktor.server.plugins.di.DependencyKey,kotlin.Unit>;io.ktor.util.logging.Logger){}[0]
+    constructor <init>(io.ktor.server.plugins.di/DependencyKeyCovariance = ..., io.ktor.server.plugins.di/DependencyConflictPolicy = ..., kotlin/Function1<io.ktor.server.plugins.di/DependencyKey, kotlin/Unit> = ...) // io.ktor.server.plugins.di/MapDependencyProvider.<init>|<init>(io.ktor.server.plugins.di.DependencyKeyCovariance;io.ktor.server.plugins.di.DependencyConflictPolicy;kotlin.Function1<io.ktor.server.plugins.di.DependencyKey,kotlin.Unit>){}[0]
 
     final val conflictPolicy // io.ktor.server.plugins.di/MapDependencyProvider.conflictPolicy|{}conflictPolicy[0]
         final fun <get-conflictPolicy>(): io.ktor.server.plugins.di/DependencyConflictPolicy // io.ktor.server.plugins.di/MapDependencyProvider.conflictPolicy.<get-conflictPolicy>|<get-conflictPolicy>(){}[0]
@@ -302,8 +280,6 @@ final val io.ktor.server.plugins.di/DefaultReflection // io.ktor.server.plugins.
     final fun <get-DefaultReflection>(): io.ktor.server.plugins.di/DependencyReflection // io.ktor.server.plugins.di/DefaultReflection.<get-DefaultReflection>|<get-DefaultReflection>(){}[0]
 final val io.ktor.server.plugins.di/DependencyRegistryKey // io.ktor.server.plugins.di/DependencyRegistryKey|{}DependencyRegistryKey[0]
     final fun <get-DependencyRegistryKey>(): io.ktor.util/AttributeKey<io.ktor.server.plugins.di/DependencyRegistry> // io.ktor.server.plugins.di/DependencyRegistryKey.<get-DependencyRegistryKey>|<get-DependencyRegistryKey>(){}[0]
-final val io.ktor.server.plugins.di/LastEntryWinsPolicy // io.ktor.server.plugins.di/LastEntryWinsPolicy|{}LastEntryWinsPolicy[0]
-    final fun <get-LastEntryWinsPolicy>(): io.ktor.server.plugins.di/DependencyConflictPolicy // io.ktor.server.plugins.di/LastEntryWinsPolicy.<get-LastEntryWinsPolicy>|<get-LastEntryWinsPolicy>(){}[0]
 final val io.ktor.server.plugins.di/Supertypes // io.ktor.server.plugins.di/Supertypes|{}Supertypes[0]
     final fun <get-Supertypes>(): io.ktor.server.plugins.di/DependencyKeyCovariance // io.ktor.server.plugins.di/Supertypes.<get-Supertypes>|<get-Supertypes>(){}[0]
 final val io.ktor.server.plugins.di/Unnamed // io.ktor.server.plugins.di/Unnamed|{}Unnamed[0]
diff --git a/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyConflictPolicy.kt b/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyConflictPolicy.kt
index dba87ce7d..28604c6e3 100644
--- a/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyConflictPolicy.kt
+++ b/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyConflictPolicy.kt
@@ -47,11 +47,11 @@ public fun interface DependencyConflictPolicy {
  * - `Replace`: Replace the existing dependency with a specific creation function.
  */
 public sealed interface DependencyConflictResult {
-    public data object KeepPrevious : DependencyConflictResult
-    public data object KeepNew : DependencyConflictResult
-    public data object Ambiguous : DependencyConflictResult
-    public data object Conflict : DependencyConflictResult
-    public data class Replace(public val function: DependencyCreateFunction) : DependencyConflictResult
+    public object KeepPrevious : DependencyConflictResult
+    public object KeepNew : DependencyConflictResult
+    public object Ambiguous : DependencyConflictResult
+    public object Conflict : DependencyConflictResult
+    public class Replace(public val function: DependencyCreateFunction) : DependencyConflictResult
 }
 
 /**
@@ -68,16 +68,3 @@ public val DefaultConflictPolicy: DependencyConflictPolicy = DependencyConflictP
         is ExplicitCreateFunction -> current.ifImplicit { KeepPrevious } ?: Conflict
     }
 }
-
-/**
- * During testing, we simply override previously declared values.
- * This allows for replacing base implementations with mock values.
- */
-public val LastEntryWinsPolicy: DependencyConflictPolicy = DependencyConflictPolicy { prev, current ->
-    require(current !is AmbiguousCreateFunction) { "Unexpected ambiguous function supplied" }
-    when (prev) {
-        is AmbiguousCreateFunction,
-        is ImplicitCreateFunction -> KeepNew
-        is ExplicitCreateFunction -> current.ifImplicit { KeepPrevious } ?: KeepNew
-    }
-}
diff --git a/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyInjection.kt b/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyInjection.kt
index 99865810f..d8f681649 100644
--- a/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyInjection.kt
+++ b/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyInjection.kt
@@ -5,7 +5,6 @@
 package io.ktor.server.plugins.di
 
 import io.ktor.server.application.ApplicationPlugin
-import io.ktor.server.application.PluginBuilder
 import io.ktor.server.application.createApplicationPlugin
 import io.ktor.server.plugins.di.utils.ClasspathReference
 import io.ktor.server.plugins.di.utils.installReference
@@ -62,16 +61,10 @@ public val DI: ApplicationPlugin<DependencyInjectionConfig> =
                 ?.map { ClasspathReference(it) }
                 .orEmpty()
 
-        val provider = if (isTestEngine() && !pluginConfig.providerChanged) {
-            MapDependencyProvider(conflictPolicy = LastEntryWinsPolicy)
-        } else {
-            pluginConfig.provider
-        }
-
         application.attributes.put(
             DependencyRegistryKey,
             DependencyRegistryImpl(
-                provider,
+                pluginConfig.provider,
                 pluginConfig.resolution,
                 pluginConfig.reflection,
             ).also { registry ->
@@ -82,9 +75,6 @@ public val DI: ApplicationPlugin<DependencyInjectionConfig> =
         )
     }
 
-private fun PluginBuilder<*>.isTestEngine(): Boolean =
-    application.engine::class.simpleName == "TestApplicationEngine"
-
 public val DependencyRegistryKey: AttributeKey<DependencyRegistry> =
     AttributeKey<DependencyRegistry>("DependencyRegistry")
 
@@ -121,13 +111,8 @@ public object NoReflection : DependencyReflection {
  * @see MapDependencyProvider
  */
 public class DependencyInjectionConfig {
-    internal var providerChanged = false
     public var reflection: DependencyReflection = DefaultReflection
     public var provider: DependencyProvider = MapDependencyProvider()
-        set(value) {
-            field = value
-            providerChanged = true
-        }
     public var resolution: DependencyResolution = DefaultDependencyResolution
 
     /**
diff --git a/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyProvider.kt b/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyProvider.kt
index 339205d7a..260c35fcd 100644
--- a/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyProvider.kt
+++ b/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyProvider.kt
@@ -9,9 +9,6 @@ import io.ktor.server.plugins.di.DependencyConflictResult.Conflict
 import io.ktor.server.plugins.di.DependencyConflictResult.KeepNew
 import io.ktor.server.plugins.di.DependencyConflictResult.KeepPrevious
 import io.ktor.server.plugins.di.DependencyConflictResult.Replace
-import io.ktor.util.logging.KtorSimpleLogger
-import io.ktor.util.logging.Logger
-import io.ktor.util.logging.trace
 import io.ktor.util.reflect.*
 import io.ktor.utils.io.*
 
@@ -142,8 +139,7 @@ public fun <T> DependencyCreateFunction.ifImplicit(block: (ImplicitCreateFunctio
 public open class MapDependencyProvider(
     public val keyMapping: DependencyKeyCovariance = Supertypes,
     public val conflictPolicy: DependencyConflictPolicy = DefaultConflictPolicy,
-    public val onConflict: (DependencyKey) -> Unit = { throw DuplicateDependencyException(it) },
-    private val log: Logger = KtorSimpleLogger("io.ktor.server.plugins.di.MapDependencyProvider"),
+    public val onConflict: (DependencyKey) -> Unit = { throw DuplicateDependencyException(it) }
 ) : DependencyProvider {
     private val map = mutableMapOf<DependencyKey, DependencyCreateFunction>()
 
@@ -160,7 +156,7 @@ public open class MapDependencyProvider(
         when (val previous = map[key]) {
             null -> map[key] = newFunction
             else -> {
-                map[key] = when (val result = resolveConflict(previous, newFunction)) {
+                map[key] = when (val result = conflictPolicy.resolve(previous, newFunction)) {
                     Ambiguous -> AmbiguousCreateFunction(key, previous, newFunction)
                     Conflict -> throw DuplicateDependencyException(key)
                     KeepNew -> newFunction
@@ -171,23 +167,12 @@ public open class MapDependencyProvider(
         }
     }
 
-    private fun resolveConflict(
-        previous: DependencyCreateFunction,
-        newFunction: DependencyCreateFunction
-    ): DependencyConflictResult {
-        val result = conflictPolicy.resolve(previous, newFunction)
-        log.trace { "Conflicting keys: (${previous.key}, ${newFunction.key}) -> $result" }
-        return result
-    }
-
     private fun insertCovariantKeys(
         createFunction: ExplicitCreateFunction,
         key: DependencyKey
     ) {
         val implicitCreateFunction = createFunction.derived()
-        val covariantKeys = keyMapping.map(key)
-        log.trace { "Register keys $key: $covariantKeys" }
-        for (implicitKey in covariantKeys) {
+        for (implicitKey in keyMapping.map(key)) {
             trySet(implicitKey, implicitCreateFunction)
         }
     }
diff --git a/ktor-server/ktor-server-plugins/ktor-server-di/common/test/io/ktor/server/plugins/di/DependencyInjectionTest.kt b/ktor-server/ktor-server-plugins/ktor-server-di/common/test/io/ktor/server/plugins/di/DependencyInjectionTest.kt
index a86d0759e..eb8023a6d 100644
--- a/ktor-server/ktor-server-plugins/ktor-server-di/common/test/io/ktor/server/plugins/di/DependencyInjectionTest.kt
+++ b/ktor-server/ktor-server-plugins/ktor-server-di/common/test/io/ktor/server/plugins/di/DependencyInjectionTest.kt
@@ -4,7 +4,6 @@
 
 package io.ktor.server.plugins.di
 
-import io.ktor.server.application.*
 import io.ktor.server.testing.*
 import io.ktor.util.reflect.*
 import kotlin.reflect.KClass
@@ -54,146 +53,155 @@ data class PaidWork(val requiredExperience: WorkExperience)
 class DependencyInjectionTest {
 
     @Test
-    fun missing() = testDI {
-        assertFailsWith<MissingDependencyException> {
-            val service: GreetingService by dependencies
-            fail("Should fail but found $service")
+    fun missing() = testApplication {
+        application {
+            assertFailsWith<MissingDependencyException> {
+                val service: GreetingService by dependencies
+                fail("Should fail but found $service")
+            }
         }
     }
 
     @Test
-    fun `resolution out of order`() = testDI {
-        assertFailsWith<OutOfOrderDependencyException> {
-            dependencies { provide<GreetingService> { GreetingServiceImpl() } }
-            assertNotNull(dependencies.resolve<GreetingService>())
-            dependencies { provide<String> { "Hello" } }
+    fun `resolution out of order`() = testApplication {
+        application {
+            assertFailsWith<OutOfOrderDependencyException> {
+                dependencies { provide<GreetingService> { GreetingServiceImpl() } }
+                assertNotNull(dependencies.resolve<GreetingService>())
+                dependencies { provide<String> { "Hello" } }
+            }
         }
     }
 
     @Test
-    fun `conflicting declarations`() = testDI {
-        assertFailsWith<DuplicateDependencyException> {
-            dependencies { provide<GreetingService> { GreetingServiceImpl() } }
-            dependencies { provide<GreetingService> { BankGreetingService() } }
+    fun `conflicting declarations`() = testApplication {
+        application {
+            assertFailsWith<DuplicateDependencyException> {
+                dependencies { provide<GreetingService> { GreetingServiceImpl() } }
+                dependencies { provide<GreetingService> { BankGreetingService() } }
+            }
         }
     }
 
     @Test
-    fun `last entry wins for tests`() = testApplication {
+    fun `circular dependencies`() = testApplication {
         application {
-            dependencies { provide<GreetingService> { GreetingServiceImpl() } }
-            dependencies { provide<GreetingService> { BankGreetingService() } }
-
-            val service: GreetingService by dependencies
-            assertEquals(HELLO_CUSTOMER, service.hello())
+            assertFailsWith<CircularDependencyException> {
+                dependencies {
+                    provide<WorkExperience> { WorkExperience(resolve()) }
+                    provide<PaidWork> { PaidWork(resolve()) }
+                    provide<List<PaidWork>> { listOf(resolve()) }
+                }
+                val eligibleJobs: List<PaidWork> by dependencies
+                fail("This should fail but returned $eligibleJobs")
+            }
         }
     }
 
     @Test
-    fun `circular dependencies`() = testDI {
-        assertFailsWith<CircularDependencyException> {
+    fun basic() = testApplication {
+        application {
             dependencies {
-                provide<WorkExperience> { WorkExperience(resolve()) }
-                provide<PaidWork> { PaidWork(resolve()) }
-                provide<List<PaidWork>> { listOf(resolve()) }
+                provide<GreetingService> { GreetingServiceImpl() }
             }
-            val eligibleJobs: List<PaidWork> by dependencies
-            fail("This should fail but returned $eligibleJobs")
-        }
-    }
 
-    @Test
-    fun basic() = testDI {
-        dependencies {
-            provide<GreetingService> { GreetingServiceImpl() }
+            val service: GreetingService by dependencies
+            assertEquals(HELLO, service.hello())
         }
-
-        val service: GreetingService by dependencies
-        assertEquals(HELLO, service.hello())
     }
 
     @Test
-    fun caching() = testDI {
-        var callCount = 0
-        dependencies {
-            provide<GreetingService> {
-                callCount++
-                GreetingServiceImpl()
+    fun caching() = testApplication {
+        application {
+            var callCount = 0
+            dependencies {
+                provide<GreetingService> {
+                    callCount++
+                    GreetingServiceImpl()
+                }
             }
-        }
 
-        val delegatedService: GreetingService by dependencies
-        assertEquals(0, callCount, "Delegated properties should be lazily resolved")
-        assertEquals(HELLO, delegatedService.hello())
-        assertEquals(1, callCount)
-        assertEquals(HELLO, dependencies.resolve<GreetingService>().hello())
-        assertEquals(HELLO, dependencies.resolve<GreetingService>().hello())
-        assertEquals(1, callCount)
+            val delegatedService: GreetingService by dependencies
+            assertEquals(0, callCount, "Delegated properties should be lazily resolved")
+            assertEquals(HELLO, delegatedService.hello())
+            assertEquals(1, callCount)
+            assertEquals(HELLO, dependencies.resolve<GreetingService>().hello())
+            assertEquals(HELLO, dependencies.resolve<GreetingService>().hello())
+            assertEquals(1, callCount)
+        }
     }
 
     @Test
-    fun `basic with qualifier`() = testDI {
-        dependencies {
-            provide<GreetingService>(name = "test") { GreetingServiceImpl() }
-        }
+    fun `basic with qualifier`() = testApplication {
+        application {
+            dependencies {
+                provide<GreetingService>(name = "test") { GreetingServiceImpl() }
+            }
 
-        val service: GreetingService by dependencies.named("test")
-        assertEquals(HELLO, service.hello())
+            val service: GreetingService by dependencies.named("test")
+            assertEquals(HELLO, service.hello())
+        }
     }
 
     @Test
-    fun lambdas() = testDI {
-        dependencies {
-            provide<() -> GreetingService> { { GreetingServiceImpl() } }
-        }
+    fun lambdas() = testApplication {
+        application {
+            dependencies {
+                provide<() -> GreetingService> { { GreetingServiceImpl() } }
+            }
 
-        val service: () -> GreetingService by dependencies
-        assertEquals(HELLO, service().hello())
+            val service: () -> GreetingService by dependencies
+            assertEquals(HELLO, service().hello())
+        }
     }
 
     @Test
-    fun parameterized() = testDI {
-        dependencies {
-            provide<GreetingService> { GreetingServiceImpl() }
-            provide<List<GreetingService>> { listOf(resolve(), resolve()) }
-        }
+    fun parameterized() = testApplication {
+        application {
+            dependencies {
+                provide<GreetingService> { GreetingServiceImpl() }
+                provide<List<GreetingService>> { listOf(resolve(), resolve()) }
+            }
 
-        val services: List<GreetingService> by dependencies
-        for (service in services) {
-            assertEquals(HELLO, service.hello())
-            assertFailsWith<MissingDependencyException> {
-                dependencies.resolve<List<BankService>>()
+            val services: List<GreetingService> by dependencies
+            for (service in services) {
+                assertEquals(HELLO, service.hello())
+                assertFailsWith<MissingDependencyException> {
+                    dependencies.resolve<List<BankService>>()
+                }
             }
         }
     }
 
     @Test
-    fun arguments() = testDI {
-        var expectedStringList = listOf("one", "two")
+    fun arguments() = testApplication {
+        application {
+            var expectedStringList = listOf("one", "two")
 
-        dependencies {
-            provide<GreetingService> { GreetingServiceImpl() }
-            provide<List<String>>("my-strings") {
-                expectedStringList
-            }
-            provide<List<Any>>("my-list") {
-                listOf(
-                    resolve<GreetingService>(),
-                    resolve<List<String>>("my-strings"),
-                )
+            dependencies {
+                provide<GreetingService> { GreetingServiceImpl() }
+                provide<List<String>>("my-strings") {
+                    expectedStringList
+                }
+                provide<List<Any>>("my-list") {
+                    listOf(
+                        resolve<GreetingService>(),
+                        resolve<List<String>>("my-strings"),
+                    )
+                }
             }
-        }
 
-        val service: GreetingService by dependencies
-        val stringList: List<String> by dependencies.named("my-strings")
-        val anyList: List<Any> by dependencies.named("my-list")
+            val service: GreetingService by dependencies
+            val stringList: List<String> by dependencies.named("my-strings")
+            val anyList: List<Any> by dependencies.named("my-list")
 
-        assertEquals(HELLO, service.hello())
-        assertEquals(expectedStringList, stringList)
-        val (first, second) = anyList
-        assertIs<GreetingService>(first)
-        assertEquals(HELLO, first.hello())
-        assertEquals(expectedStringList, second)
+            assertEquals(HELLO, service.hello())
+            assertEquals(expectedStringList, stringList)
+            val (first, second) = anyList
+            assertIs<GreetingService>(first)
+            assertEquals(HELLO, first.hello())
+            assertEquals(expectedStringList, second)
+        }
     }
 
     @Test
@@ -221,49 +229,39 @@ class DependencyInjectionTest {
 
     @Suppress("UNCHECKED_CAST")
     @Test
-    fun `custom reflection`() = testDI({
-        reflection = object : DependencyReflection {
-            override fun <T : Any> create(
-                kClass: KClass<T>,
-                init: (DependencyKey) -> Any
-            ): T = when (kClass) {
-                GreetingService::class -> GreetingServiceImpl() as T
-                else -> fail("Unexpected class $kClass")
+    fun `custom reflection`() = testApplication {
+        install(DI) {
+            reflection = object : DependencyReflection {
+                override fun <T : Any> create(
+                    kClass: KClass<T>,
+                    init: (DependencyKey) -> Any
+                ): T = when (kClass) {
+                    GreetingService::class -> GreetingServiceImpl() as T
+                    else -> fail("Unexpected class $kClass")
+                }
             }
         }
-    }) {
-        val service: GreetingService = dependencies.create()
-        assertEquals(HELLO, service.hello())
-    }
-
-    @Test
-    fun `unnamed key mapping`() = testDI({
-        provider {
-            keyMapping = Unnamed
-        }
-    }) {
-        dependencies {
-            provide<GreetingService>("bank") { BankGreetingService() }
+        application {
+            val service: GreetingService = dependencies.create()
+            assertEquals(HELLO, service.hello())
         }
-        val named: GreetingService by dependencies.named("bank")
-        val unnamed: GreetingService by dependencies
-        assertEquals(HELLO_CUSTOMER, named.hello())
-        assertEquals(HELLO_CUSTOMER, unnamed.hello())
     }
 
-    // Use default DI configuration (not test mode)
-    private fun testDI(
-        pluginInstall: DependencyInjectionConfig.() -> Unit = {},
-        block: Application.() -> Unit
-    ) = testApplication {
+    @Test
+    fun `unnamed key mapping`() = testApplication {
         install(DI) {
-            pluginInstall()
-            if (!providerChanged) {
-                provider = MapDependencyProvider()
+            provider {
+                keyMapping = Unnamed
             }
         }
         application {
-            block()
+            dependencies {
+                provide<GreetingService>("bank") { BankGreetingService() }
+            }
+            val named: GreetingService by dependencies.named("bank")
+            val unnamed: GreetingService by dependencies
+            assertEquals(HELLO_CUSTOMER, named.hello())
+            assertEquals(HELLO_CUSTOMER, unnamed.hello())
         }
     }
 }
diff --git a/ktor-server/ktor-server-plugins/ktor-server-di/jvm/test/io/ktor/server/plugins/di/DependencyInjectionJvmTest.kt b/ktor-server/ktor-server-plugins/ktor-server-di/jvm/test/io/ktor/server/plugins/di/DependencyInjectionJvmTest.kt
index 9754825fb..c8fbeda7c 100644
--- a/ktor-server/ktor-server-plugins/ktor-server-di/jvm/test/io/ktor/server/plugins/di/DependencyInjectionJvmTest.kt
+++ b/ktor-server/ktor-server-plugins/ktor-server-di/jvm/test/io/ktor/server/plugins/di/DependencyInjectionJvmTest.kt
@@ -109,9 +109,6 @@ class DependencyInjectionJvmTest {
 
     @Test
     fun `covariant ambiguity`() = testApplication {
-        install(DI) {
-            provider = MapDependencyProvider()
-        }
         application {
             dependencies {
                 provide(GreetingServiceImpl::class)

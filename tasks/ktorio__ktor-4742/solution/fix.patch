diff --git a/ktor-server/ktor-server-plugins/ktor-server-di/api/ktor-server-di.api b/ktor-server/ktor-server-plugins/ktor-server-di/api/ktor-server-di.api
index 726a71d73..fc7b1cca1 100644
--- a/ktor-server/ktor-server-plugins/ktor-server-di/api/ktor-server-di.api
+++ b/ktor-server/ktor-server-plugins/ktor-server-di/api/ktor-server-di.api
@@ -31,6 +31,7 @@ public abstract interface class io/ktor/server/plugins/di/DependencyConflictPoli
 
 public final class io/ktor/server/plugins/di/DependencyConflictPolicyKt {
 	public static final fun getDefaultConflictPolicy ()Lio/ktor/server/plugins/di/DependencyConflictPolicy;
+	public static final fun getLastEntryWinsPolicy ()Lio/ktor/server/plugins/di/DependencyConflictPolicy;
 }
 
 public abstract interface class io/ktor/server/plugins/di/DependencyConflictResult {
@@ -38,23 +39,41 @@ public abstract interface class io/ktor/server/plugins/di/DependencyConflictResu
 
 public final class io/ktor/server/plugins/di/DependencyConflictResult$Ambiguous : io/ktor/server/plugins/di/DependencyConflictResult {
 	public static final field INSTANCE Lio/ktor/server/plugins/di/DependencyConflictResult$Ambiguous;
+	public fun equals (Ljava/lang/Object;)Z
+	public fun hashCode ()I
+	public fun toString ()Ljava/lang/String;
 }
 
 public final class io/ktor/server/plugins/di/DependencyConflictResult$Conflict : io/ktor/server/plugins/di/DependencyConflictResult {
 	public static final field INSTANCE Lio/ktor/server/plugins/di/DependencyConflictResult$Conflict;
+	public fun equals (Ljava/lang/Object;)Z
+	public fun hashCode ()I
+	public fun toString ()Ljava/lang/String;
 }
 
 public final class io/ktor/server/plugins/di/DependencyConflictResult$KeepNew : io/ktor/server/plugins/di/DependencyConflictResult {
 	public static final field INSTANCE Lio/ktor/server/plugins/di/DependencyConflictResult$KeepNew;
+	public fun equals (Ljava/lang/Object;)Z
+	public fun hashCode ()I
+	public fun toString ()Ljava/lang/String;
 }
 
 public final class io/ktor/server/plugins/di/DependencyConflictResult$KeepPrevious : io/ktor/server/plugins/di/DependencyConflictResult {
 	public static final field INSTANCE Lio/ktor/server/plugins/di/DependencyConflictResult$KeepPrevious;
+	public fun equals (Ljava/lang/Object;)Z
+	public fun hashCode ()I
+	public fun toString ()Ljava/lang/String;
 }
 
 public final class io/ktor/server/plugins/di/DependencyConflictResult$Replace : io/ktor/server/plugins/di/DependencyConflictResult {
 	public fun <init> (Lio/ktor/server/plugins/di/DependencyCreateFunction;)V
+	public final fun component1 ()Lio/ktor/server/plugins/di/DependencyCreateFunction;
+	public final fun copy (Lio/ktor/server/plugins/di/DependencyCreateFunction;)Lio/ktor/server/plugins/di/DependencyConflictResult$Replace;
+	public static synthetic fun copy$default (Lio/ktor/server/plugins/di/DependencyConflictResult$Replace;Lio/ktor/server/plugins/di/DependencyCreateFunction;ILjava/lang/Object;)Lio/ktor/server/plugins/di/DependencyConflictResult$Replace;
+	public fun equals (Ljava/lang/Object;)Z
 	public final fun getFunction ()Lio/ktor/server/plugins/di/DependencyCreateFunction;
+	public fun hashCode ()I
+	public fun toString ()Ljava/lang/String;
 }
 
 public class io/ktor/server/plugins/di/DependencyConstructionException : java/lang/IllegalArgumentException {
@@ -236,8 +255,8 @@ public final class io/ktor/server/plugins/di/InvalidDependencyReferenceException
 
 public class io/ktor/server/plugins/di/MapDependencyProvider : io/ktor/server/plugins/di/DependencyProvider {
 	public fun <init> ()V
-	public fun <init> (Lio/ktor/server/plugins/di/DependencyKeyCovariance;Lio/ktor/server/plugins/di/DependencyConflictPolicy;Lkotlin/jvm/functions/Function1;)V
-	public synthetic fun <init> (Lio/ktor/server/plugins/di/DependencyKeyCovariance;Lio/ktor/server/plugins/di/DependencyConflictPolicy;Lkotlin/jvm/functions/Function1;ILkotlin/jvm/internal/DefaultConstructorMarker;)V
+	public fun <init> (Lio/ktor/server/plugins/di/DependencyKeyCovariance;Lio/ktor/server/plugins/di/DependencyConflictPolicy;Lkotlin/jvm/functions/Function1;Lorg/slf4j/Logger;)V
+	public synthetic fun <init> (Lio/ktor/server/plugins/di/DependencyKeyCovariance;Lio/ktor/server/plugins/di/DependencyConflictPolicy;Lkotlin/jvm/functions/Function1;Lorg/slf4j/Logger;ILkotlin/jvm/internal/DefaultConstructorMarker;)V
 	public final fun getConflictPolicy ()Lio/ktor/server/plugins/di/DependencyConflictPolicy;
 	public fun getDeclarations ()Ljava/util/Map;
 	public final fun getKeyMapping ()Lio/ktor/server/plugins/di/DependencyKeyCovariance;
diff --git a/ktor-server/ktor-server-plugins/ktor-server-di/api/ktor-server-di.klib.api b/ktor-server/ktor-server-plugins/ktor-server-di/api/ktor-server-di.klib.api
index 1aed5242d..4f171d776 100644
--- a/ktor-server/ktor-server-plugins/ktor-server-di/api/ktor-server-di.klib.api
+++ b/ktor-server/ktor-server-plugins/ktor-server-di/api/ktor-server-di.klib.api
@@ -47,15 +47,37 @@ sealed interface io.ktor.server.plugins.di/DependencyConflictResult { // io.ktor
 
         final val function // io.ktor.server.plugins.di/DependencyConflictResult.Replace.function|{}function[0]
             final fun <get-function>(): io.ktor.server.plugins.di/DependencyCreateFunction // io.ktor.server.plugins.di/DependencyConflictResult.Replace.function.<get-function>|<get-function>(){}[0]
+
+        final fun component1(): io.ktor.server.plugins.di/DependencyCreateFunction // io.ktor.server.plugins.di/DependencyConflictResult.Replace.component1|component1(){}[0]
+        final fun copy(io.ktor.server.plugins.di/DependencyCreateFunction = ...): io.ktor.server.plugins.di/DependencyConflictResult.Replace // io.ktor.server.plugins.di/DependencyConflictResult.Replace.copy|copy(io.ktor.server.plugins.di.DependencyCreateFunction){}[0]
+        final fun equals(kotlin/Any?): kotlin/Boolean // io.ktor.server.plugins.di/DependencyConflictResult.Replace.equals|equals(kotlin.Any?){}[0]
+        final fun hashCode(): kotlin/Int // io.ktor.server.plugins.di/DependencyConflictResult.Replace.hashCode|hashCode(){}[0]
+        final fun toString(): kotlin/String // io.ktor.server.plugins.di/DependencyConflictResult.Replace.toString|toString(){}[0]
     }
 
-    final object Ambiguous : io.ktor.server.plugins.di/DependencyConflictResult // io.ktor.server.plugins.di/DependencyConflictResult.Ambiguous|null[0]
+    final object Ambiguous : io.ktor.server.plugins.di/DependencyConflictResult { // io.ktor.server.plugins.di/DependencyConflictResult.Ambiguous|null[0]
+        final fun equals(kotlin/Any?): kotlin/Boolean // io.ktor.server.plugins.di/DependencyConflictResult.Ambiguous.equals|equals(kotlin.Any?){}[0]
+        final fun hashCode(): kotlin/Int // io.ktor.server.plugins.di/DependencyConflictResult.Ambiguous.hashCode|hashCode(){}[0]
+        final fun toString(): kotlin/String // io.ktor.server.plugins.di/DependencyConflictResult.Ambiguous.toString|toString(){}[0]
+    }
 
-    final object Conflict : io.ktor.server.plugins.di/DependencyConflictResult // io.ktor.server.plugins.di/DependencyConflictResult.Conflict|null[0]
+    final object Conflict : io.ktor.server.plugins.di/DependencyConflictResult { // io.ktor.server.plugins.di/DependencyConflictResult.Conflict|null[0]
+        final fun equals(kotlin/Any?): kotlin/Boolean // io.ktor.server.plugins.di/DependencyConflictResult.Conflict.equals|equals(kotlin.Any?){}[0]
+        final fun hashCode(): kotlin/Int // io.ktor.server.plugins.di/DependencyConflictResult.Conflict.hashCode|hashCode(){}[0]
+        final fun toString(): kotlin/String // io.ktor.server.plugins.di/DependencyConflictResult.Conflict.toString|toString(){}[0]
+    }
 
-    final object KeepNew : io.ktor.server.plugins.di/DependencyConflictResult // io.ktor.server.plugins.di/DependencyConflictResult.KeepNew|null[0]
+    final object KeepNew : io.ktor.server.plugins.di/DependencyConflictResult { // io.ktor.server.plugins.di/DependencyConflictResult.KeepNew|null[0]
+        final fun equals(kotlin/Any?): kotlin/Boolean // io.ktor.server.plugins.di/DependencyConflictResult.KeepNew.equals|equals(kotlin.Any?){}[0]
+        final fun hashCode(): kotlin/Int // io.ktor.server.plugins.di/DependencyConflictResult.KeepNew.hashCode|hashCode(){}[0]
+        final fun toString(): kotlin/String // io.ktor.server.plugins.di/DependencyConflictResult.KeepNew.toString|toString(){}[0]
+    }
 
-    final object KeepPrevious : io.ktor.server.plugins.di/DependencyConflictResult // io.ktor.server.plugins.di/DependencyConflictResult.KeepPrevious|null[0]
+    final object KeepPrevious : io.ktor.server.plugins.di/DependencyConflictResult { // io.ktor.server.plugins.di/DependencyConflictResult.KeepPrevious|null[0]
+        final fun equals(kotlin/Any?): kotlin/Boolean // io.ktor.server.plugins.di/DependencyConflictResult.KeepPrevious.equals|equals(kotlin.Any?){}[0]
+        final fun hashCode(): kotlin/Int // io.ktor.server.plugins.di/DependencyConflictResult.KeepPrevious.hashCode|hashCode(){}[0]
+        final fun toString(): kotlin/String // io.ktor.server.plugins.di/DependencyConflictResult.KeepPrevious.toString|toString(){}[0]
+    }
 }
 
 sealed interface io.ktor.server.plugins.di/DependencyCreateFunction { // io.ktor.server.plugins.di/DependencyCreateFunction|null[0]
@@ -252,7 +274,7 @@ open class io.ktor.server.plugins.di/DependencyReflectionDisabledException : io.
 }
 
 open class io.ktor.server.plugins.di/MapDependencyProvider : io.ktor.server.plugins.di/DependencyProvider { // io.ktor.server.plugins.di/MapDependencyProvider|null[0]
-    constructor <init>(io.ktor.server.plugins.di/DependencyKeyCovariance = ..., io.ktor.server.plugins.di/DependencyConflictPolicy = ..., kotlin/Function1<io.ktor.server.plugins.di/DependencyKey, kotlin/Unit> = ...) // io.ktor.server.plugins.di/MapDependencyProvider.<init>|<init>(io.ktor.server.plugins.di.DependencyKeyCovariance;io.ktor.server.plugins.di.DependencyConflictPolicy;kotlin.Function1<io.ktor.server.plugins.di.DependencyKey,kotlin.Unit>){}[0]
+    constructor <init>(io.ktor.server.plugins.di/DependencyKeyCovariance = ..., io.ktor.server.plugins.di/DependencyConflictPolicy = ..., kotlin/Function1<io.ktor.server.plugins.di/DependencyKey, kotlin/Unit> = ..., io.ktor.util.logging/Logger = ...) // io.ktor.server.plugins.di/MapDependencyProvider.<init>|<init>(io.ktor.server.plugins.di.DependencyKeyCovariance;io.ktor.server.plugins.di.DependencyConflictPolicy;kotlin.Function1<io.ktor.server.plugins.di.DependencyKey,kotlin.Unit>;io.ktor.util.logging.Logger){}[0]
 
     final val conflictPolicy // io.ktor.server.plugins.di/MapDependencyProvider.conflictPolicy|{}conflictPolicy[0]
         final fun <get-conflictPolicy>(): io.ktor.server.plugins.di/DependencyConflictPolicy // io.ktor.server.plugins.di/MapDependencyProvider.conflictPolicy.<get-conflictPolicy>|<get-conflictPolicy>(){}[0]
@@ -280,6 +302,8 @@ final val io.ktor.server.plugins.di/DefaultReflection // io.ktor.server.plugins.
     final fun <get-DefaultReflection>(): io.ktor.server.plugins.di/DependencyReflection // io.ktor.server.plugins.di/DefaultReflection.<get-DefaultReflection>|<get-DefaultReflection>(){}[0]
 final val io.ktor.server.plugins.di/DependencyRegistryKey // io.ktor.server.plugins.di/DependencyRegistryKey|{}DependencyRegistryKey[0]
     final fun <get-DependencyRegistryKey>(): io.ktor.util/AttributeKey<io.ktor.server.plugins.di/DependencyRegistry> // io.ktor.server.plugins.di/DependencyRegistryKey.<get-DependencyRegistryKey>|<get-DependencyRegistryKey>(){}[0]
+final val io.ktor.server.plugins.di/LastEntryWinsPolicy // io.ktor.server.plugins.di/LastEntryWinsPolicy|{}LastEntryWinsPolicy[0]
+    final fun <get-LastEntryWinsPolicy>(): io.ktor.server.plugins.di/DependencyConflictPolicy // io.ktor.server.plugins.di/LastEntryWinsPolicy.<get-LastEntryWinsPolicy>|<get-LastEntryWinsPolicy>(){}[0]
 final val io.ktor.server.plugins.di/Supertypes // io.ktor.server.plugins.di/Supertypes|{}Supertypes[0]
     final fun <get-Supertypes>(): io.ktor.server.plugins.di/DependencyKeyCovariance // io.ktor.server.plugins.di/Supertypes.<get-Supertypes>|<get-Supertypes>(){}[0]
 final val io.ktor.server.plugins.di/Unnamed // io.ktor.server.plugins.di/Unnamed|{}Unnamed[0]
diff --git a/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyConflictPolicy.kt b/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyConflictPolicy.kt
index 28604c6e3..dba87ce7d 100644
--- a/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyConflictPolicy.kt
+++ b/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyConflictPolicy.kt
@@ -47,11 +47,11 @@ public fun interface DependencyConflictPolicy {
  * - `Replace`: Replace the existing dependency with a specific creation function.
  */
 public sealed interface DependencyConflictResult {
-    public object KeepPrevious : DependencyConflictResult
-    public object KeepNew : DependencyConflictResult
-    public object Ambiguous : DependencyConflictResult
-    public object Conflict : DependencyConflictResult
-    public class Replace(public val function: DependencyCreateFunction) : DependencyConflictResult
+    public data object KeepPrevious : DependencyConflictResult
+    public data object KeepNew : DependencyConflictResult
+    public data object Ambiguous : DependencyConflictResult
+    public data object Conflict : DependencyConflictResult
+    public data class Replace(public val function: DependencyCreateFunction) : DependencyConflictResult
 }
 
 /**
@@ -68,3 +68,16 @@ public val DefaultConflictPolicy: DependencyConflictPolicy = DependencyConflictP
         is ExplicitCreateFunction -> current.ifImplicit { KeepPrevious } ?: Conflict
     }
 }
+
+/**
+ * During testing, we simply override previously declared values.
+ * This allows for replacing base implementations with mock values.
+ */
+public val LastEntryWinsPolicy: DependencyConflictPolicy = DependencyConflictPolicy { prev, current ->
+    require(current !is AmbiguousCreateFunction) { "Unexpected ambiguous function supplied" }
+    when (prev) {
+        is AmbiguousCreateFunction,
+        is ImplicitCreateFunction -> KeepNew
+        is ExplicitCreateFunction -> current.ifImplicit { KeepPrevious } ?: KeepNew
+    }
+}
diff --git a/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyInjection.kt b/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyInjection.kt
index d8f681649..99865810f 100644
--- a/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyInjection.kt
+++ b/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyInjection.kt
@@ -5,6 +5,7 @@
 package io.ktor.server.plugins.di
 
 import io.ktor.server.application.ApplicationPlugin
+import io.ktor.server.application.PluginBuilder
 import io.ktor.server.application.createApplicationPlugin
 import io.ktor.server.plugins.di.utils.ClasspathReference
 import io.ktor.server.plugins.di.utils.installReference
@@ -61,10 +62,16 @@ public val DI: ApplicationPlugin<DependencyInjectionConfig> =
                 ?.map { ClasspathReference(it) }
                 .orEmpty()
 
+        val provider = if (isTestEngine() && !pluginConfig.providerChanged) {
+            MapDependencyProvider(conflictPolicy = LastEntryWinsPolicy)
+        } else {
+            pluginConfig.provider
+        }
+
         application.attributes.put(
             DependencyRegistryKey,
             DependencyRegistryImpl(
-                pluginConfig.provider,
+                provider,
                 pluginConfig.resolution,
                 pluginConfig.reflection,
             ).also { registry ->
@@ -75,6 +82,9 @@ public val DI: ApplicationPlugin<DependencyInjectionConfig> =
         )
     }
 
+private fun PluginBuilder<*>.isTestEngine(): Boolean =
+    application.engine::class.simpleName == "TestApplicationEngine"
+
 public val DependencyRegistryKey: AttributeKey<DependencyRegistry> =
     AttributeKey<DependencyRegistry>("DependencyRegistry")
 
@@ -111,8 +121,13 @@ public object NoReflection : DependencyReflection {
  * @see MapDependencyProvider
  */
 public class DependencyInjectionConfig {
+    internal var providerChanged = false
     public var reflection: DependencyReflection = DefaultReflection
     public var provider: DependencyProvider = MapDependencyProvider()
+        set(value) {
+            field = value
+            providerChanged = true
+        }
     public var resolution: DependencyResolution = DefaultDependencyResolution
 
     /**
diff --git a/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyProvider.kt b/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyProvider.kt
index 260c35fcd..339205d7a 100644
--- a/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyProvider.kt
+++ b/ktor-server/ktor-server-plugins/ktor-server-di/common/src/io/ktor/server/plugins/di/DependencyProvider.kt
@@ -9,6 +9,9 @@ import io.ktor.server.plugins.di.DependencyConflictResult.Conflict
 import io.ktor.server.plugins.di.DependencyConflictResult.KeepNew
 import io.ktor.server.plugins.di.DependencyConflictResult.KeepPrevious
 import io.ktor.server.plugins.di.DependencyConflictResult.Replace
+import io.ktor.util.logging.KtorSimpleLogger
+import io.ktor.util.logging.Logger
+import io.ktor.util.logging.trace
 import io.ktor.util.reflect.*
 import io.ktor.utils.io.*
 
@@ -139,7 +142,8 @@ public fun <T> DependencyCreateFunction.ifImplicit(block: (ImplicitCreateFunctio
 public open class MapDependencyProvider(
     public val keyMapping: DependencyKeyCovariance = Supertypes,
     public val conflictPolicy: DependencyConflictPolicy = DefaultConflictPolicy,
-    public val onConflict: (DependencyKey) -> Unit = { throw DuplicateDependencyException(it) }
+    public val onConflict: (DependencyKey) -> Unit = { throw DuplicateDependencyException(it) },
+    private val log: Logger = KtorSimpleLogger("io.ktor.server.plugins.di.MapDependencyProvider"),
 ) : DependencyProvider {
     private val map = mutableMapOf<DependencyKey, DependencyCreateFunction>()
 
@@ -156,7 +160,7 @@ public open class MapDependencyProvider(
         when (val previous = map[key]) {
             null -> map[key] = newFunction
             else -> {
-                map[key] = when (val result = conflictPolicy.resolve(previous, newFunction)) {
+                map[key] = when (val result = resolveConflict(previous, newFunction)) {
                     Ambiguous -> AmbiguousCreateFunction(key, previous, newFunction)
                     Conflict -> throw DuplicateDependencyException(key)
                     KeepNew -> newFunction
@@ -167,12 +171,23 @@ public open class MapDependencyProvider(
         }
     }
 
+    private fun resolveConflict(
+        previous: DependencyCreateFunction,
+        newFunction: DependencyCreateFunction
+    ): DependencyConflictResult {
+        val result = conflictPolicy.resolve(previous, newFunction)
+        log.trace { "Conflicting keys: (${previous.key}, ${newFunction.key}) -> $result" }
+        return result
+    }
+
     private fun insertCovariantKeys(
         createFunction: ExplicitCreateFunction,
         key: DependencyKey
     ) {
         val implicitCreateFunction = createFunction.derived()
-        for (implicitKey in keyMapping.map(key)) {
+        val covariantKeys = keyMapping.map(key)
+        log.trace { "Register keys $key: $covariantKeys" }
+        for (implicitKey in covariantKeys) {
             trySet(implicitKey, implicitCreateFunction)
         }
     }

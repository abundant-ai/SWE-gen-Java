diff --git a/gradle/libs.versions.toml b/gradle/libs.versions.toml
index 3348b69c6..2061a60f6 100644
--- a/gradle/libs.versions.toml
+++ b/gradle/libs.versions.toml
@@ -5,6 +5,7 @@ com-squareup-moshi = "1.14.0"
 com-squareup-okio = "3.3.0"
 de-mannodermaus-junit5 = "1.3.0"
 graalvm = "22.3.2"
+kotlinx-serialization = "1.5.0"
 org-bouncycastle = "1.72"
 org-conscrypt = "2.5.2"
 org-jetbrains-coroutines = "1.6.4"
@@ -41,6 +42,7 @@ gradlePlugin-dokka = "org.jetbrains.dokka:dokka-gradle-plugin:1.8.10"
 gradlePlugin-errorprone = "net.ltgt.gradle:gradle-errorprone-plugin:3.0.1"
 gradlePlugin-graal = "com.palantir.graal:gradle-graal:0.12.0"
 gradlePlugin-kotlin = { module = "org.jetbrains.kotlin:kotlin-gradle-plugin", version.ref = "org-jetbrains-kotlin" }
+gradlePlugin-kotlinSerialization = { module = "org.jetbrains.kotlin:kotlin-serialization", version.ref = "org-jetbrains-kotlin" }
 gradlePlugin-mavenPublish = "com.vanniktech:gradle-maven-publish-plugin:0.24.0"
 gradlePlugin-shadow = "gradle.plugin.com.github.johnrengelman:shadow:7.1.2"
 gradlePlugin-spotless = "com.diffplug.spotless:spotless-plugin-gradle:6.18.0"
@@ -69,6 +71,8 @@ kotlin-test-js = { module = "org.jetbrains.kotlin:kotlin-test-js", version.ref =
 kotlin-test-junit = { module = "org.jetbrains.kotlin:kotlin-test-junit", version.ref = "org-jetbrains-kotlin" }
 kotlinx-coroutines-core = { module = "org.jetbrains.kotlinx:kotlinx-coroutines-core", version.ref = "org-jetbrains-coroutines" }
 kotlinx-coroutines-test = { module = "org.jetbrains.kotlinx:kotlinx-coroutines-test", version.ref = "org-jetbrains-coroutines" }
+kotlinx-serialization-core = { module = "org.jetbrains.kotlinx:kotlinx-serialization-core", version.ref = "kotlinx-serialization" }
+kotlinx-serialization-json = { module = "org.jetbrains.kotlinx:kotlinx-serialization-json", version.ref = "kotlinx-serialization" }
 nativeImageSvm = { module = "org.graalvm.nativeimage:svm", version.ref = "graalvm" }
 openjsse = "org.openjsse:openjsse:1.1.12"
 playservices-safetynet = "com.google.android.gms:play-services-safetynet:18.0.1"
@@ -82,3 +86,4 @@ squareup-okhttp-icu = "com.squareup.okhttpicu:okhttp-icu:0.2.0"
 squareup-kotlinPoet = "com.squareup:kotlinpoet:1.13.1"
 squareup-okio = { module = "com.squareup.okio:okio", version.ref = "com-squareup-okio" }
 squareup-okio-fakefilesystem = { module = "com.squareup.okio:okio-fakefilesystem", version.ref = "com-squareup-okio" }
+squareup-okio-nodefilesystem = { module = "com.squareup.okio:okio-nodefilesystem", version.ref = "com-squareup-okio" }
diff --git a/okhttp-testing-support/build.gradle.kts b/okhttp-testing-support/build.gradle.kts
index aee44af4e..fe8915e5e 100644
--- a/okhttp-testing-support/build.gradle.kts
+++ b/okhttp-testing-support/build.gradle.kts
@@ -7,8 +7,23 @@ kotlin {
   jvm {
     withJava()
   }
+  if (kmpJsEnabled) {
+    js(IR) {
+      nodejs()
+    }
+  }
 
   sourceSets {
+    val commonMain by getting {
+      dependencies {
+        api(libs.squareup.okio)
+      }
+    }
+    val jsMain by getting {
+      dependencies {
+        implementation(libs.squareup.okio.nodefilesystem)
+      }
+    }
     val jvmMain by getting {
       dependencies {
         api(projects.okhttp)
diff --git a/okhttp-testing-support/src/commonMain/kotlin/okhttp3/TestUtilCommon.kt b/okhttp-testing-support/src/commonMain/kotlin/okhttp3/TestUtilCommon.kt
new file mode 100644
index 000000000..678f31e2b
--- /dev/null
+++ b/okhttp-testing-support/src/commonMain/kotlin/okhttp3/TestUtilCommon.kt
@@ -0,0 +1,29 @@
+/*
+ * Copyright (C) 2023 Square, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package okhttp3
+
+import okio.FileSystem
+import okio.Path
+import okio.Path.Companion.toPath
+
+val okHttpRoot: Path
+  get() = getEnv("OKHTTP_ROOT")!!.toPath()
+
+expect val SYSTEM_FILE_SYSTEM: FileSystem
+
+expect fun getEnv(name: String): String?
+
+expect val isJvm: Boolean
diff --git a/okhttp-testing-support/src/jsMain/kotlin/okhttp3/TestUtilJs.kt b/okhttp-testing-support/src/jsMain/kotlin/okhttp3/TestUtilJs.kt
new file mode 100644
index 000000000..f77acbd22
--- /dev/null
+++ b/okhttp-testing-support/src/jsMain/kotlin/okhttp3/TestUtilJs.kt
@@ -0,0 +1,25 @@
+/*
+ * Copyright (C) 2023 Square, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package okhttp3
+
+import okio.FileSystem
+import okio.NodeJsFileSystem
+
+actual fun getEnv(name: String) = js("globalThis.process.env[name]") as String?
+
+actual val SYSTEM_FILE_SYSTEM: FileSystem = NodeJsFileSystem
+
+actual val isJvm = false
diff --git a/okhttp-testing-support/src/jvmMain/kotlin/okhttp3/TestUtilJvm.kt b/okhttp-testing-support/src/jvmMain/kotlin/okhttp3/TestUtilJvm.kt
new file mode 100644
index 000000000..47d58233e
--- /dev/null
+++ b/okhttp-testing-support/src/jvmMain/kotlin/okhttp3/TestUtilJvm.kt
@@ -0,0 +1,131 @@
+/*
+ * Copyright (C) 2018 Square, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package okhttp3
+
+import java.io.File
+import java.net.InetAddress
+import java.net.InetSocketAddress
+import java.net.UnknownHostException
+import java.util.Arrays
+import okhttp3.internal.http2.Header
+import okio.Buffer
+import okio.FileSystem
+import org.junit.jupiter.api.Assumptions.assumeFalse
+import org.junit.jupiter.api.Assumptions.assumeTrue
+
+object TestUtil {
+  @JvmField
+  val UNREACHABLE_ADDRESS_IPV4 = InetSocketAddress("198.51.100.1", 8080)
+  val UNREACHABLE_ADDRESS_IPV6 = InetSocketAddress("::ffff:198.51.100.1", 8080)
+
+  /** See `org.graalvm.nativeimage.ImageInfo`. */
+  @JvmStatic val isGraalVmImage = System.getProperty("org.graalvm.nativeimage.imagecode") != null
+
+  @JvmStatic
+  fun headerEntries(vararg elements: String?): List<Header> {
+    return List(elements.size / 2) { Header(elements[it * 2]!!, elements[it * 2 + 1]!!) }
+  }
+
+  @JvmStatic
+  fun repeat(
+    c: Char,
+    count: Int
+  ): String {
+    val array = CharArray(count)
+    Arrays.fill(array, c)
+    return String(array)
+  }
+
+  /**
+   * Okio buffers are internally implemented as a linked list of arrays. Usually this implementation
+   * detail is invisible to the caller, but subtle use of certain APIs may depend on these internal
+   * structures.
+   *
+   * We make such subtle calls in [okhttp3.internal.ws.MessageInflater] because we try to read a
+   * compressed stream that is terminated in a web socket frame even though the DEFLATE stream is
+   * not terminated.
+   *
+   * Use this method to create a degenerate Okio Buffer where each byte is in a separate segment of
+   * the internal list.
+   */
+  @JvmStatic
+  fun fragmentBuffer(buffer: Buffer): Buffer {
+    // Write each byte into a new buffer, then clone it so that the segments are shared.
+    // Shared segments cannot be compacted so we'll get a long chain of short segments.
+    val result = Buffer()
+    while (!buffer.exhausted()) {
+      val box = Buffer()
+      box.write(buffer, 1)
+      result.write(box.copy(), 1)
+    }
+    return result
+  }
+
+  tailrec fun File.isDescendentOf(directory: File): Boolean {
+    val parentFile = parentFile ?: return false
+    if (parentFile == directory) return true
+    return parentFile.isDescendentOf(directory)
+  }
+
+  /**
+   * See FinalizationTester for discussion on how to best trigger GC in tests.
+   * https://android.googlesource.com/platform/libcore/+/master/support/src/test/java/libcore/
+   * java/lang/ref/FinalizationTester.java
+   */
+  @Throws(Exception::class)
+  @JvmStatic
+  fun awaitGarbageCollection() {
+    Runtime.getRuntime().gc()
+    Thread.sleep(100)
+    System.runFinalization()
+  }
+
+  @JvmStatic
+  fun assumeNetwork() {
+    try {
+      InetAddress.getByName("www.google.com")
+    } catch (uhe: UnknownHostException) {
+      assumeTrue(false, "requires network")
+    }
+  }
+
+  @JvmStatic
+  fun assumeNotWindows() {
+    assumeFalse(windows, "This test fails on Windows.")
+  }
+
+  @JvmStatic
+  val windows: Boolean
+    get() = System.getProperty("os.name", "?").startsWith("Windows")
+
+  /**
+   * Make assertions about the suppressed exceptions on this. Prefer this over making direct calls
+   * so tests pass on GraalVM, where suppressed exceptions are silently discarded.
+   *
+   * https://github.com/oracle/graal/issues/3008
+   */
+  @JvmStatic
+  fun Throwable.assertSuppressed(block: (List<@JvmSuppressWildcards Throwable>) -> Unit) {
+    if (isGraalVmImage) return
+    block(suppressed.toList())
+  }
+}
+
+actual fun getEnv(name: String) = System.getenv(name)
+
+actual val SYSTEM_FILE_SYSTEM = FileSystem.SYSTEM
+
+actual val isJvm = true
diff --git a/okhttp/build.gradle.kts b/okhttp/build.gradle.kts
index 26e8a479c..fe04b8a70 100644
--- a/okhttp/build.gradle.kts
+++ b/okhttp/build.gradle.kts
@@ -4,6 +4,7 @@ import org.jetbrains.kotlin.gradle.dsl.KotlinCompile
 
 plugins {
   kotlin("multiplatform")
+  kotlin("plugin.serialization")
   id("org.jetbrains.dokka")
   id("com.vanniktech.maven.publish.base")
   id("binary-compatibility-validator")
@@ -29,8 +30,6 @@ kotlin {
           }
         }
       }
-      browser {
-      }
     }
   }
 
@@ -43,9 +42,12 @@ kotlin {
     }
     val commonTest by getting {
       dependencies {
-        implementation(libs.kotlin.test.common)
+        implementation(projects.okhttpTestingSupport)
+        implementation(libs.assertk)
         implementation(libs.kotlin.test.annotations)
-        api(libs.assertk)
+        implementation(libs.kotlin.test.common)
+        implementation(libs.kotlinx.serialization.core)
+        implementation(libs.kotlinx.serialization.json)
       }
     }
     val nonJvmMain = create("nonJvmMain") {
@@ -83,7 +85,6 @@ kotlin {
       kotlin.srcDir("$buildDir/generated/sources/idnaMappingTable")
       dependencies {
         dependsOn(commonTest)
-        implementation(projects.okhttpTestingSupport)
         implementation(projects.okhttpTls)
         implementation(projects.okhttpUrlconnection)
         implementation(projects.mockwebserver3)
@@ -112,6 +113,7 @@ kotlin {
       }
 
       getByName("jsMain") {
+        kotlin.srcDir("$buildDir/generated/sources/idnaMappingTable")
         dependencies {
           dependsOn(nonJvmMain)
           api(libs.squareup.okio)
diff --git a/okhttp/src/commonTest/kotlin/okhttp3/WebPlatformToAsciiData.kt b/okhttp/src/commonTest/kotlin/okhttp3/WebPlatformToAsciiData.kt
new file mode 100644
index 000000000..ac1f3019e
--- /dev/null
+++ b/okhttp/src/commonTest/kotlin/okhttp3/WebPlatformToAsciiData.kt
@@ -0,0 +1,43 @@
+/*
+ * Copyright (C) 2023 Block, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package okhttp3
+
+import kotlinx.serialization.Serializable
+import kotlinx.serialization.decodeFromString
+import kotlinx.serialization.json.Json
+
+/**
+ * A test from the [Web Platform To ASCII](https://github.com/web-platform-tests/wpt/blob/master/url/resources/toascii.json).
+ *
+ * Each test is a line of the file `toascii.json`.
+ */
+@Serializable
+class WebPlatformToAsciiData {
+  var input: String? = null
+  var output: String? = null
+  var comment: String? = null
+
+  override fun toString() = "input=$input output=$output"
+
+  companion object {
+    fun load(): List<WebPlatformToAsciiData> {
+      val path = okHttpRoot / "okhttp/src/commonTest/resources/web-platform-test-toascii.json"
+      return SYSTEM_FILE_SYSTEM.read(path) {
+        Json.decodeFromString<List<WebPlatformToAsciiData>>(readUtf8())
+      }
+    }
+  }
+}
diff --git a/okhttp/src/commonTest/resources/web-platform-test-toascii.json b/okhttp/src/commonTest/resources/web-platform-test-toascii.json
new file mode 100644
index 000000000..152d9dc87
--- /dev/null
+++ b/okhttp/src/commonTest/resources/web-platform-test-toascii.json
@@ -0,0 +1,192 @@
+[
+  {
+    "comment": "Label with hyphens in 3rd and 4th position",
+    "input": "aa--",
+    "output": "aa--"
+  },
+  {
+    "input": "a†--",
+    "output": "xn--a---kp0a"
+  },
+  {
+    "input": "ab--c",
+    "output": "ab--c"
+  },
+  {
+    "comment": "Label with leading hyphen",
+    "input": "-x",
+    "output": "-x"
+  },
+  {
+    "input": "-†",
+    "output": "xn----xhn"
+  },
+  {
+    "input": "-x.xn--zca",
+    "output": "-x.xn--zca"
+  },
+  {
+    "input": "-x.ß",
+    "output": "-x.xn--zca"
+  },
+  {
+    "comment": "Label with trailing hyphen",
+    "input": "x-.xn--zca",
+    "output": "x-.xn--zca"
+  },
+  {
+    "input": "x-.ß",
+    "output": "x-.xn--zca"
+  },
+  {
+    "comment": "Empty labels",
+    "input": "x..xn--zca",
+    "output": "x..xn--zca"
+  },
+  {
+    "input": "x..ß",
+    "output": "x..xn--zca"
+  },
+  {
+    "comment": "Invalid Punycode",
+    "input": "xn--a",
+    "output": null
+  },
+  {
+    "input": "xn--a.xn--zca",
+    "output": null
+  },
+  {
+    "input": "xn--a.ß",
+    "output": null
+  },
+  {
+    "input": "xn--ls8h=",
+    "output": null
+  },
+  {
+    "comment": "Invalid Punycode (contains non-ASCII character)",
+    "input": "xn--tešla",
+    "output": null
+  },
+  {
+    "comment": "Valid Punycode",
+    "input": "xn--zca.xn--zca",
+    "output": "xn--zca.xn--zca"
+  },
+  {
+    "comment": "Mixed",
+    "input": "xn--zca.ß",
+    "output": "xn--zca.xn--zca"
+  },
+  {
+    "input": "ab--c.xn--zca",
+    "output": "ab--c.xn--zca"
+  },
+  {
+    "input": "ab--c.ß",
+    "output": "ab--c.xn--zca"
+  },
+  {
+    "comment": "CheckJoiners is true",
+    "input": "\u200D.example",
+    "output": null
+  },
+  {
+    "input": "xn--1ug.example",
+    "output": null
+  },
+  {
+    "comment": "CheckBidi is true",
+    "input": "يa",
+    "output": null
+  },
+  {
+    "input": "xn--a-yoc",
+    "output": null
+  },
+  {
+    "comment": "processing_option is Nontransitional_Processing",
+    "input": "ශ්‍රී",
+    "output": "xn--10cl1a0b660p"
+  },
+  {
+    "input": "نامه‌ای",
+    "output": "xn--mgba3gch31f060k"
+  },
+  {
+    "comment": "U+FFFD",
+    "input": "\uFFFD.com",
+    "output": null
+  },
+  {
+    "comment": "U+FFFD character encoded in Punycode",
+    "input": "xn--zn7c.com",
+    "output": null
+  },
+  {
+    "comment": "Label longer than 63 code points",
+    "input": "x01234567890123456789012345678901234567890123456789012345678901x",
+    "output": "x01234567890123456789012345678901234567890123456789012345678901x"
+  },
+  {
+    "input": "x01234567890123456789012345678901234567890123456789012345678901†",
+    "output": "xn--x01234567890123456789012345678901234567890123456789012345678901-6963b"
+  },
+  {
+    "input": "x01234567890123456789012345678901234567890123456789012345678901x.xn--zca",
+    "output": "x01234567890123456789012345678901234567890123456789012345678901x.xn--zca"
+  },
+  {
+    "input": "x01234567890123456789012345678901234567890123456789012345678901x.ß",
+    "output": "x01234567890123456789012345678901234567890123456789012345678901x.xn--zca"
+  },
+  {
+    "comment": "Domain excluding TLD longer than 253 code points",
+    "input": "01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.0123456789012345678901234567890123456789012345678.x",
+    "output": "01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.0123456789012345678901234567890123456789012345678.x"
+  },
+  {
+    "input": "01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.0123456789012345678901234567890123456789012345678.xn--zca",
+    "output": "01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.0123456789012345678901234567890123456789012345678.xn--zca"
+  },
+  {
+    "input": "01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.0123456789012345678901234567890123456789012345678.ß",
+    "output": "01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.01234567890123456789012345678901234567890123456789.0123456789012345678901234567890123456789012345678.xn--zca"
+  },
+  {
+    "comment": "IDNA ignored code points",
+    "input": "a\u00ADb",
+    "output": "ab"
+  },
+  {
+    "input": "a%C2%ADb",
+    "output": "ab"
+  },
+  {
+    "comment": "Empty host after domain to ASCII",
+    "input": "\u00AD",
+    "output": null
+  },
+  {
+    "input": "%C2%AD",
+    "output": null
+  },
+  {
+    "input": "xn--",
+    "output": null
+  },
+  {
+    "comment": "Interesting UseSTD3ASCIIRules=false cases",
+    "input": "≠",
+    "output": "xn--1ch"
+  },
+  {
+    "input": "≮",
+    "output": "xn--gdh"
+  },
+  {
+    "input": "≯",
+    "output": "xn--hdh"
+  }
+]
diff --git a/okhttp/src/nonJvmMain/kotlin/okhttp3/internal/-HostnamesNonJvm.kt b/okhttp/src/nonJvmMain/kotlin/okhttp3/internal/-HostnamesNonJvm.kt
index 8d011b2dc..10abc50cb 100644
--- a/okhttp/src/nonJvmMain/kotlin/okhttp3/internal/-HostnamesNonJvm.kt
+++ b/okhttp/src/nonJvmMain/kotlin/okhttp3/internal/-HostnamesNonJvm.kt
@@ -16,8 +16,27 @@
 package okhttp3.internal
 
 import com.squareup.okhttpicu.SYSTEM_NORMALIZER
+import okhttp3.internal.idn.IDNA_MAPPING_TABLE
+import okio.Buffer
 
 internal actual fun idnToAscii(host: String): String {
-  // TODO implement properly
-  return SYSTEM_NORMALIZER.normalizeNfc(host).lowercase()
+  val bufferA = Buffer().writeUtf8(host)
+  val bufferB = Buffer()
+
+  // 1. Map, from bufferA to bufferB.
+  while (!bufferA.exhausted()) {
+    val codePoint = bufferA.readUtf8CodePoint()
+    require(IDNA_MAPPING_TABLE.map(codePoint, bufferB)) {
+      "disallowed code point: $codePoint"
+    }
+  }
+
+  // 2. Normalize, from bufferB to bufferA.
+  val normalized = SYSTEM_NORMALIZER.normalizeNfc(bufferB.readUtf8())
+  bufferA.writeUtf8(normalized)
+
+  // 3. For each label, convert/validate Punycode.
+  // TODO.
+
+  return bufferA.readUtf8()
 }

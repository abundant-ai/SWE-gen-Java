diff --git a/.github/workflows/build.yml b/.github/workflows/build.yml
index b1fefa134..6cd888310 100644
--- a/.github/workflows/build.yml
+++ b/.github/workflows/build.yml
@@ -28,6 +28,13 @@ jobs:
           distribution: 'adopt'
           java-version: 11
 
+      - uses: actions/cache@v2
+        with:
+          path: |
+            ~/.gradle/caches
+            ~/.gradle/wrapper
+          key: ${{ runner.os }}-gradle-${{ hashFiles('**/**.gradle.kts', '**/gradle/wrapper/gradle-wrapper.properties', '**/libs.versions.toml') }}
+
       - name: Upload Artifacts
         run: |
           ./gradlew clean publish --stacktrace
@@ -52,6 +59,13 @@ jobs:
           distribution: 'adopt'
           java-version: 11
 
+      - uses: actions/cache@v2
+        with:
+          path: |
+            ~/.gradle/caches
+            ~/.gradle/wrapper
+          key: ${{ runner.os }}-gradle-${{ hashFiles('**/**.gradle.kts', '**/gradle/wrapper/gradle-wrapper.properties', '**/libs.versions.toml') }}
+
       - name: Run Checks
         run: ./gradlew check -x test
 
@@ -71,6 +85,13 @@ jobs:
           distribution: 'adopt'
           java-version: 11
 
+      - uses: actions/cache@v2
+        with:
+          path: |
+            ~/.gradle/caches
+            ~/.gradle/wrapper
+          key: ${{ runner.os }}-gradle-${{ hashFiles('**/**.gradle.kts', '**/gradle/wrapper/gradle-wrapper.properties', '**/libs.versions.toml') }}
+
       - name: Run Checks
         run: ./gradlew jvmTest -Dtest.java.version=11
 
@@ -96,6 +117,13 @@ jobs:
           distribution: 'adopt'
           java-version: 11
 
+      - uses: actions/cache@v2
+        with:
+          path: |
+            ~/.gradle/caches
+            ~/.gradle/wrapper
+          key: ${{ runner.os }}-gradle-${{ hashFiles('**/**.gradle.kts', '**/gradle/wrapper/gradle-wrapper.properties', '**/libs.versions.toml') }}
+
       - name: Run Checks
         run: ./gradlew jsTest
 
@@ -122,6 +150,13 @@ jobs:
           distribution: 'zulu'
           java-version: 11
 
+      - uses: actions/cache@v2
+        with:
+          path: |
+            ~/.gradle/caches
+            ~/.gradle/wrapper
+          key: ${{ runner.os }}-gradle-${{ hashFiles('**/**.gradle.kts', '**/gradle/wrapper/gradle-wrapper.properties', '**/libs.versions.toml') }}
+
       - name: Run Checks
         run: ./gradlew jvmTest -Dtest.java.version=11
 
@@ -142,6 +177,13 @@ jobs:
           distribution: 'adopt'
           java-version: 11
 
+      - uses: actions/cache@v2
+        with:
+          path: |
+            ~/.gradle/caches
+            ~/.gradle/wrapper
+          key: ${{ runner.os }}-gradle-${{ hashFiles('**/**.gradle.kts', '**/gradle/wrapper/gradle-wrapper.properties', '**/libs.versions.toml') }}
+
       - name: Run Checks
         run: ./gradlew jvmTest -Dtest.java.version=8
 
@@ -168,6 +210,13 @@ jobs:
           distribution: 'adopt'
           java-version: 11
 
+      - uses: actions/cache@v2
+        with:
+          path: |
+            ~/.gradle/caches
+            ~/.gradle/wrapper
+          key: ${{ runner.os }}-gradle-${{ hashFiles('**/**.gradle.kts', '**/gradle/wrapper/gradle-wrapper.properties', '**/libs.versions.toml') }}
+
       - name: Run Checks
         run: ./gradlew jvmTest -Dtest.java.version=8 -Dokhttp.platform=jdk8alpn -Dalpn.boot.version=8.1.13.v20181017 -Dorg.gradle.java.installations.paths=/opt/hostedtoolcache/Java_Adopt_jdk/8.0.242-8.1/x64
 
@@ -188,6 +237,13 @@ jobs:
           distribution: 'adopt'
           java-version: 11
 
+      - uses: actions/cache@v2
+        with:
+          path: |
+            ~/.gradle/caches
+            ~/.gradle/wrapper
+          key: ${{ runner.os }}-gradle-${{ hashFiles('**/**.gradle.kts', '**/gradle/wrapper/gradle-wrapper.properties', '**/libs.versions.toml') }}
+
       - name: Run Checks
         run: ./gradlew jvmTest -Dtest.java.version=8 -Dokhttp.platform=openjsse
 
@@ -208,6 +264,13 @@ jobs:
           distribution: 'adopt'
           java-version: 11
 
+      - uses: actions/cache@v2
+        with:
+          path: |
+            ~/.gradle/caches
+            ~/.gradle/wrapper
+          key: ${{ runner.os }}-gradle-${{ hashFiles('**/**.gradle.kts', '**/gradle/wrapper/gradle-wrapper.properties', '**/libs.versions.toml') }}
+
       - name: Run Checks
         run: ./gradlew jvmTest -Dokhttp.platform=conscrypt
 
@@ -228,6 +291,13 @@ jobs:
           distribution: 'adopt'
           java-version: 11
 
+      - uses: actions/cache@v2
+        with:
+          path: |
+            ~/.gradle/caches
+            ~/.gradle/wrapper
+          key: ${{ runner.os }}-gradle-${{ hashFiles('**/**.gradle.kts', '**/gradle/wrapper/gradle-wrapper.properties', '**/libs.versions.toml') }}
+
       - name: Run Checks
         run: ./gradlew jvmTest -Dokhttp.platform=bouncycastle
 
@@ -249,6 +319,13 @@ jobs:
           distribution: 'adopt'
           java-version: 11
 
+      - uses: actions/cache@v2
+        with:
+          path: |
+            ~/.gradle/caches
+            ~/.gradle/wrapper
+          key: ${{ runner.os }}-gradle-${{ hashFiles('**/**.gradle.kts', '**/gradle/wrapper/gradle-wrapper.properties', '**/libs.versions.toml') }}
+
       - name: Run Checks
         run: ./gradlew jvmTest -Dokhttp.platform=corretto
 
@@ -269,6 +346,13 @@ jobs:
           distribution: 'adopt'
           java-version: 11
 
+      - uses: actions/cache@v2
+        with:
+          path: |
+            ~/.gradle/caches
+            ~/.gradle/wrapper
+          key: ${{ runner.os }}-gradle-${{ hashFiles('**/**.gradle.kts', '**/gradle/wrapper/gradle-wrapper.properties', '**/libs.versions.toml') }}
+
       - name: Run Checks
         run: ./gradlew jvmTest -Dtest.java.version=17
 
@@ -290,6 +374,13 @@ jobs:
           distribution: 'adopt'
           java-version: 11
 
+      - uses: actions/cache@v2
+        with:
+          path: |
+            ~/.gradle/caches
+            ~/.gradle/wrapper
+          key: ${{ runner.os }}-gradle-${{ hashFiles('**/**.gradle.kts', '**/gradle/wrapper/gradle-wrapper.properties', '**/libs.versions.toml') }}
+
       - name: Test
         run: |
           ./gradlew jvmTest
@@ -312,6 +403,13 @@ jobs:
           distribution: 'adopt'
           java-version: 11
 
+      - uses: actions/cache@v2
+        with:
+          path: |
+            ~/.gradle/caches
+            ~/.gradle/wrapper
+          key: ${{ runner.os }}-gradle-${{ hashFiles('**/**.gradle.kts', '**/gradle/wrapper/gradle-wrapper.properties', '**/libs.versions.toml') }}
+
       - name: Build okcurl
         run: ./gradlew okcurl:nativeImage
 
@@ -346,6 +444,32 @@ jobs:
           distribution: 'adopt'
           java-version: 11
 
+      - uses: actions/cache@v2
+        with:
+          path: |
+            ~/.gradle/caches
+            ~/.gradle/wrapper
+          key: ${{ runner.os }}-gradle-${{ hashFiles('**/**.gradle.kts', '**/gradle/wrapper/gradle-wrapper.properties', '**/libs.versions.toml') }}
+
+      - name: AVD cache
+        uses: actions/cache@v2
+        id: avd-cache
+        with:
+          path: |
+            ~/.android/avd/*
+            ~/.android/adb*
+          key: avd-${{ matrix.api-level }}
+
+      - name: Create AVD and generate snapshot for caching
+        if: steps.avd-cache.outputs.cache-hit != 'true'
+        uses: reactivecircus/android-emulator-runner@v2
+        with:
+          api-level: ${{ matrix.api-level }}
+          force-avd-creation: false
+          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
+          disable-animations: false
+          script: echo "Generated AVD snapshot for caching."
+
       - name: Run Tests
         uses: reactivecircus/android-emulator-runner@v2
         with:
@@ -379,6 +503,32 @@ jobs:
           distribution: 'adopt'
           java-version: 11
 
+      - uses: actions/cache@v2
+        with:
+          path: |
+            ~/.gradle/caches
+            ~/.gradle/wrapper
+          key: ${{ runner.os }}-gradle-${{ hashFiles('**/**.gradle.kts', '**/gradle/wrapper/gradle-wrapper.properties', '**/libs.versions.toml') }}
+
+      - name: AVD cache
+        uses: actions/cache@v2
+        id: avd-cache
+        with:
+          path: |
+            ~/.android/avd/*
+            ~/.android/adb*
+          key: avd-${{ matrix.api-level }}
+
+      - name: Create AVD and generate snapshot for caching
+        if: steps.avd-cache.outputs.cache-hit != 'true'
+        uses: reactivecircus/android-emulator-runner@v2
+        with:
+          api-level: ${{ matrix.api-level }}
+          force-avd-creation: false
+          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
+          disable-animations: false
+          script: echo "Generated AVD snapshot for caching."
+
       - name: Run Tests
         uses: reactivecircus/android-emulator-runner@v2
         with:
diff --git a/android-test/build.gradle.kts b/android-test/build.gradle.kts
index 029c58acb..ef1204f61 100644
--- a/android-test/build.gradle.kts
+++ b/android-test/build.gradle.kts
@@ -46,8 +46,8 @@ android {
 }
 
 dependencies {
-  implementation(Dependencies.kotlinReflect)
-  implementation(Dependencies.playServicesSafetynet)
+  implementation(libs.kotlin.reflect)
+  implementation(libs.playservices.safetynet)
   implementation(projects.okhttp)
 
   androidTestImplementation(projects.okhttpTestingSupport) {
@@ -55,25 +55,24 @@ dependencies {
     exclude("org.conscrypt", "conscrypt-openjdk-uber")
     exclude("software.amazon.cryptools", "AmazonCorrettoCryptoProvider")
   }
-  androidTestImplementation(Dependencies.bouncycastle)
-  androidTestImplementation(Dependencies.bouncycastletls)
-  androidTestImplementation(Dependencies.conscryptAndroid)
+  androidTestImplementation(libs.bouncycastle.bcprov)
+  androidTestImplementation(libs.bouncycastle.bctls)
+  androidTestImplementation(libs.conscrypt.android)
   androidTestImplementation(projects.mockwebserver3Junit5)
   androidTestImplementation(projects.okhttpBrotli)
   androidTestImplementation(projects.okhttpDnsoverhttps)
   androidTestImplementation(projects.loggingInterceptor)
   androidTestImplementation(projects.okhttpSse)
-  androidTestImplementation(projects.okhttpTestingSupport)
   androidTestImplementation(projects.okhttpTls)
-  androidTestImplementation(Dependencies.androidxExtJunit)
-  androidTestImplementation(Dependencies.androidxEspressoCore)
-  androidTestImplementation(Dependencies.httpclient5)
-  androidTestImplementation(Dependencies.moshi)
-  androidTestImplementation(Dependencies.moshiKotlin)
-  androidTestImplementation(Dependencies.okioFakeFileSystem)
+  androidTestImplementation(libs.androidx.junit)
+  androidTestImplementation(libs.androidx.espresso.core)
+  androidTestImplementation(libs.httpClient5)
+  androidTestImplementation(libs.squareup.moshi)
+  androidTestImplementation(libs.squareup.moshi.kotlin)
+  androidTestImplementation(libs.squareup.okio.fakefilesystem)
 
-  androidTestImplementation(Dependencies.androidxTestRunner)
-  androidTestImplementation(Dependencies.junit5Api)
-  androidTestImplementation(Dependencies.junit5AndroidCore)
-  androidTestRuntimeOnly(Dependencies.junit5AndroidRunner)
+  androidTestImplementation(libs.androidx.test.runner)
+  androidTestImplementation(libs.junit.jupiter.api)
+  androidTestImplementation(libs.junit5android.core)
+  androidTestRuntimeOnly(libs.junit5android.runner)
 }
diff --git a/build.gradle.kts b/build.gradle.kts
index a6e9e05cc..662f2875b 100644
--- a/build.gradle.kts
+++ b/build.gradle.kts
@@ -3,23 +3,24 @@ import com.vanniktech.maven.publish.SonatypeHost
 import java.net.URL
 import org.gradle.api.tasks.testing.logging.TestExceptionFormat
 import org.jetbrains.dokka.gradle.DokkaTask
+import org.jetbrains.kotlin.gradle.targets.js.nodejs.NodeJsRootPlugin
 import org.jetbrains.kotlin.gradle.tasks.KotlinCompile
 import ru.vyarus.gradle.plugin.animalsniffer.AnimalSnifferExtension
 
 buildscript {
   dependencies {
-    classpath(Dependencies.kotlinPlugin)
-    classpath(Dependencies.dokkaPlugin)
-    classpath(Dependencies.androidPlugin)
-    classpath(Dependencies.androidJunit5Plugin)
-    classpath(Dependencies.graalPlugin)
-    classpath(Dependencies.bndPlugin)
-    classpath(Dependencies.shadowPlugin)
-    classpath(Dependencies.japicmpPlugin)
-    classpath(Dependencies.animalsnifferPlugin)
-    classpath(Dependencies.errorpronePlugin)
-    classpath(Dependencies.spotlessPlugin)
-    classpath(Dependencies.vanniktechPublishPlugin)
+    classpath(libs.gradlePlugin.dokka)
+    classpath(libs.gradlePlugin.kotlin)
+    classpath(libs.gradlePlugin.androidJunit5)
+    classpath(libs.gradlePlugin.android)
+    classpath(libs.gradlePlugin.graal)
+    classpath(libs.gradlePlugin.bnd)
+    classpath(libs.gradlePlugin.shadow)
+    classpath(libs.gradlePlugin.japicmp)
+    classpath(libs.gradlePlugin.animalsniffer)
+    classpath(libs.gradlePlugin.errorprone)
+    classpath(libs.gradlePlugin.spotless)
+    classpath(libs.gradlePlugin.mavenPublish)
   }
 
   repositories {
@@ -87,30 +88,31 @@ subprojects {
     exclude("**/CipherSuite.java")
   }
 
-  val checkstyleConfig: Configuration by configurations.creating
-  dependencies {
-    checkstyleConfig(Dependencies.checkStyle) {
-      isTransitive = false
+  afterEvaluate {
+    val checkstyleConfig: Configuration by configurations.creating
+    dependencies {
+      checkstyleConfig(libs.checkStyle) {
+        isTransitive = false
+      }
     }
-  }
 
-  afterEvaluate {
     configure<CheckstyleExtension> {
       config = resources.text.fromArchiveEntry(checkstyleConfig, "google_checks.xml")
-      toolVersion = Versions.checkStyle
+      toolVersion = libs.versions.checkStyle.get()
       sourceSets = listOf(project.sourceSets["main"])
     }
-  }
 
-  // Animal Sniffer confirms we generally don't use APIs not on Java 8.
-  configure<AnimalSnifferExtension> {
-    annotation = "okhttp3.internal.SuppressSignatureCheck"
-    sourceSets = listOf(project.sourceSets["main"])
-  }
-  val signature: Configuration by configurations.getting
-  dependencies {
-    signature(Dependencies.signatureAndroid21)
-    signature(Dependencies.signatureJava18)
+    // Animal Sniffer confirms we generally don't use APIs not on Java 8.
+    configure<AnimalSnifferExtension> {
+      annotation = "okhttp3.internal.SuppressSignatureCheck"
+      sourceSets = listOf(project.sourceSets["main"])
+    }
+
+    val signature: Configuration by configurations.getting
+    dependencies {
+      signature(libs.signature.android.apilevel21)
+      signature(libs.codehaus.signature.java18)
+    }
   }
 
   tasks.withType<KotlinCompile> {
@@ -127,9 +129,12 @@ subprojects {
   val testJavaVersion = System.getProperty("test.java.version", "11").toInt()
 
   val testRuntimeOnly: Configuration by configurations.getting
-  dependencies {
-    testRuntimeOnly(Dependencies.junit5JupiterEngine)
-    testRuntimeOnly(Dependencies.junit5VintageEngine)
+
+  afterEvaluate {
+    dependencies {
+      testRuntimeOnly(libs.junit.jupiter.engine)
+      testRuntimeOnly(libs.junit.vintage.engine)
+    }
   }
 
   tasks.withType<Test> {
@@ -166,11 +171,11 @@ subprojects {
     }
   } else if (platform == "conscrypt") {
     dependencies {
-      testRuntimeOnly(Dependencies.conscrypt)
+      testRuntimeOnly(libs.conscrypt)
     }
   } else if (platform == "openjsse") {
     dependencies {
-      testRuntimeOnly(Dependencies.openjsse)
+      testRuntimeOnly(libs.openjsse)
     }
   }
 
@@ -241,3 +246,9 @@ subprojects {
 tasks.wrapper {
   distributionType = Wrapper.DistributionType.ALL
 }
+
+// Fix until 1.6.20 https://youtrack.jetbrains.com/issue/KT-49109
+rootProject.plugins.withType(NodeJsRootPlugin::class.java) {
+  rootProject.the<org.jetbrains.kotlin.gradle.targets.js.nodejs.NodeJsRootExtension>().nodeVersion =
+    "16.13.0"
+}
diff --git a/buildSrc/src/main/kotlin/artifacts.kt b/buildSrc/src/main/kotlin/artifacts.kt
index fc6846deb..889e74758 100644
--- a/buildSrc/src/main/kotlin/artifacts.kt
+++ b/buildSrc/src/main/kotlin/artifacts.kt
@@ -45,7 +45,7 @@ private fun Project.applyOsgi(
   val osgi = project.sourceSets.create("osgi")
   val osgiApi = project.configurations.getByName(osgiApiConfigurationName)
   project.dependencies {
-    osgiApi(Dependencies.kotlinStdlibOsgi)
+    osgiApi("org.jetbrains.kotlin:kotlin-osgi-bundle:1.6.10")
   }
 
   val jarTask = tasks.getByName<Jar>(jarTaskName)
diff --git a/buildSrc/src/main/kotlin/deps.kt b/buildSrc/src/main/kotlin/deps.kt
index f445621be..e6ace9d03 100644
--- a/buildSrc/src/main/kotlin/deps.kt
+++ b/buildSrc/src/main/kotlin/deps.kt
@@ -17,84 +17,3 @@
 // If false - JS targets will not be configured in multiplatform projects.
 val kmpJsEnabled = System.getProperty("kjs", "true").toBoolean()
 
-object Versions {
-  const val bnd = "6.1.0"
-  const val bouncyCastle = "1.70"
-  const val checkStyle = "9.2"
-  const val conscrypt = "2.5.2"
-  const val junit5 = "5.8.2"
-  const val junit5Android = "1.3.0"
-  const val kotlin = "1.6.10"
-  const val moshi = "1.13.0"
-  const val okio = "3.0.0"
-  const val picocli = "4.6.2"
-  const val graal = "22.0.0.2"
-}
-
-object Dependencies {
-  const val kotlinPlugin = "org.jetbrains.kotlin:kotlin-gradle-plugin:${Versions.kotlin}"
-  const val dokkaPlugin = "org.jetbrains.dokka:dokka-gradle-plugin:1.6.0"
-  const val androidPlugin = "com.android.tools.build:gradle:7.0.4"
-  const val androidJunit5Plugin = "de.mannodermaus.gradle.plugins:android-junit5:1.8.0.0"
-  const val graalPlugin = "gradle.plugin.com.palantir.graal:gradle-graal:0.10.0"
-  const val bndPlugin = "biz.aQute.bnd:biz.aQute.bnd.gradle:${Versions.bnd}"
-  const val shadowPlugin = "gradle.plugin.com.github.johnrengelman:shadow:7.1.0"
-  const val japicmpPlugin = "me.champeau.gradle:japicmp-gradle-plugin:0.3.0"
-  const val animalsnifferPlugin = "ru.vyarus:gradle-animalsniffer-plugin:1.5.4"
-  const val errorpronePlugin = "net.ltgt.gradle:gradle-errorprone-plugin:2.0.2"
-  const val spotlessPlugin = "com.diffplug.spotless:spotless-plugin-gradle:6.0.4"
-  const val vanniktechPublishPlugin = "com.vanniktech:gradle-maven-publish-plugin:0.18.0"
-
-  const val android = "org.robolectric:android-all:12-robolectric-7732740"
-  const val animalSniffer = "org.codehaus.mojo:animal-sniffer-annotations:1.20"
-  const val assertj = "org.assertj:assertj-core:3.21.0"
-  const val bndResolve = "biz.aQute.bnd:biz.aQute.resolve:${Versions.bnd}"
-  const val bouncycastle = "org.bouncycastle:bcprov-jdk15to18:${Versions.bouncyCastle}"
-  const val bouncycastlepkix = "org.bouncycastle:bcpkix-jdk15to18:${Versions.bouncyCastle}"
-  const val bouncycastletls = "org.bouncycastle:bctls-jdk15to18:${Versions.bouncyCastle}"
-  const val brotli = "org.brotli:dec:0.1.2"
-  const val conscrypt = "org.conscrypt:conscrypt-openjdk-uber:${Versions.conscrypt}"
-  const val conscryptAndroid = "org.conscrypt:conscrypt-android:${Versions.conscrypt}"
-  const val corretto = "software.amazon.cryptools:AmazonCorrettoCryptoProvider:1.6.1:linux-x86_64"
-  const val equinox = "org.eclipse.platform:org.eclipse.osgi:3.17.100"
-  const val guava = "com.google.guava:guava:31.0.1-jre"
-  const val hamcrest = "org.hamcrest:hamcrest-library:2.2"
-  const val jnrUnixsocket = "com.github.jnr:jnr-unixsocket:0.38.15"
-  const val jsoup = "org.jsoup:jsoup:1.14.3"
-  const val jsr305 = "com.google.code.findbugs:jsr305:3.0.2"
-  const val junit = "junit:junit:4.13.2"
-  const val junit5Api = "org.junit.jupiter:junit-jupiter-api:${Versions.junit5}"
-  const val junit5JupiterEngine = "org.junit.jupiter:junit-jupiter-engine:${Versions.junit5}"
-  const val junit5JupiterParams = "org.junit.jupiter:junit-jupiter-params:${Versions.junit5}"
-  const val junit5VintageEngine = "org.junit.vintage:junit-vintage-engine:${Versions.junit5}"
-  const val junit5AndroidCore = "de.mannodermaus.junit5:android-test-core:${Versions.junit5Android}"
-  const val junit5AndroidRunner = "de.mannodermaus.junit5:android-test-runner:${Versions.junit5Android}"
-  const val junitPlatformConsole = "org.junit.platform:junit-platform-console:1.7.2"
-  const val kotlinStdlib = "org.jetbrains.kotlin:kotlin-stdlib:${Versions.kotlin}"
-  const val kotlinReflect = "org.jetbrains.kotlin:kotlin-reflect:${Versions.kotlin}"
-  const val kotlinStdlibOsgi = "org.jetbrains.kotlin:kotlin-osgi-bundle:${Versions.kotlin}"
-  const val kotlinJunit5 = "org.jetbrains.kotlin:kotlin-test-junit5:${Versions.kotlin}"
-  const val kotlinTest = "org.jetbrains.kotlin:kotlin-test-common:${Versions.kotlin}"
-  const val kotlinTestAnnotations ="org.jetbrains.kotlin:kotlin-test-annotations-common:${Versions.kotlin}"
-  const val kotlinTestJunit ="org.jetbrains.kotlin:kotlin-test-junit:${Versions.kotlin}"
-  const val kotlinTestJs ="org.jetbrains.kotlin:kotlin-test-js:${Versions.kotlin}"
-  const val moshi = "com.squareup.moshi:moshi:${Versions.moshi}"
-  const val moshiKotlin = "com.squareup.moshi:moshi-kotlin:${Versions.moshi}"
-  const val moshiCompiler = "com.squareup.moshi:moshi-kotlin-codegen:${Versions.moshi}"
-  const val okio = "com.squareup.okio:okio:${Versions.okio}"
-  const val okioFakeFileSystem = "com.squareup.okio:okio-fakefilesystem:${Versions.okio}"
-  const val openjsse = "org.openjsse:openjsse:1.1.8"
-  const val picocli = "info.picocli:picocli:${Versions.picocli}"
-  const val picocliCompiler = "info.picocli:picocli-codegen:${Versions.picocli}"
-  const val playServicesSafetynet = "com.google.android.gms:play-services-safetynet:17.0.1"
-  const val androidxExtJunit = "androidx.test.ext:junit:1.1.3"
-  const val androidxEspressoCore = "androidx.test.espresso:espresso-core:3.4.0"
-  const val androidxTestRunner = "androidx.test:runner:1.4.0"
-  const val httpclient5 = "org.apache.httpcomponents.client5:httpclient5:5.0"
-  const val nativeImageSvm = "org.graalvm.nativeimage:svm:${Versions.graal}"
-  const val jettyClient = "org.eclipse.jetty:jetty-client:9.4.27.v20200227"
-  const val checkStyle = "com.puppycrawl.tools:checkstyle:${Versions.checkStyle}"
-  const val signatureAndroid21 = "net.sf.androidscents.signature:android-api-level-21:5.0.1_r2@signature"
-  const val signatureJava18 = "org.codehaus.mojo.signature:java18:1.0@signature"
-  const val assertk = "com.willowtreeapps.assertk:assertk:0.25"
-}
diff --git a/docs/recipes.md b/docs/recipes.md
index 19df7b677..9ac3c4bed 100644
--- a/docs/recipes.md
+++ b/docs/recipes.md
@@ -7,7 +7,7 @@ description: A collection of common/useful code examples for Kotlin and Java
 # Recipes
 
 We've written some recipes that demonstrate how to solve common problems with OkHttp. Read through them to learn about how everything works together. Cut-and-paste these examples freely; that's what they're for.
- 
+
 ### Synchronous Get ([.kt][SynchronousGetKotlin], [.java][SynchronousGetJava])
 
 Download a file, print its headers, and print its response body as a string.
@@ -17,19 +17,19 @@ The `string()` method on response body is convenient and efficient for small doc
 === ":material-language-kotlin: Kotlin"
     ```kotlin
       private val client = OkHttpClient()
-      
+
       fun run() {
         val request = Request.Builder()
             .url("https://publicobject.com/helloworld.txt")
             .build()
-        
+
         client.newCall(request).execute().use { response ->
           if (!response.isSuccessful) throw IOException("Unexpected code $response")
-          
+
           for ((name, value) in response.headers) {
             println("$name: $value")
           }
-          
+
           println(response.body!!.string())
         }
       }
@@ -37,25 +37,25 @@ The `string()` method on response body is convenient and efficient for small doc
 === ":material-language-java: Java"
     ```java
       private final OkHttpClient client = new OkHttpClient();
-      
+
       public void run() throws Exception {
         Request request = new Request.Builder()
             .url("https://publicobject.com/helloworld.txt")
             .build();
-        
+
         try (Response response = client.newCall(request).execute()) {
           if (!response.isSuccessful()) throw new IOException("Unexpected code " + response);
-          
+
           Headers responseHeaders = response.headers();
           for (int i = 0; i < responseHeaders.size(); i++) {
             System.out.println(responseHeaders.name(i) + ": " + responseHeaders.value(i));
           }
-          
+
           System.out.println(response.body().string());
         }
       }
     ```
- 
+
 ### Asynchronous Get ([.kt][AsynchronousGetKotlin], [.java][AsynchronousGetJava])
 
 Download a file on a worker thread, and get called back when the response is readable. The callback is made after the response headers are ready. Reading the response body may still block. OkHttp doesn't currently offer asynchronous APIs to receive a response body in parts.
@@ -63,25 +63,25 @@ Download a file on a worker thread, and get called back when the response is rea
 === ":material-language-kotlin: Kotlin"
     ```kotlin
       private val client = OkHttpClient()
-      
+
       fun run() {
         val request = Request.Builder()
             .url("http://publicobject.com/helloworld.txt")
             .build()
-        
+
         client.newCall(request).enqueue(object : Callback {
           override fun onFailure(call: Call, e: IOException) {
             e.printStackTrace()
           }
-          
+
           override fun onResponse(call: Call, response: Response) {
             response.use {
               if (!response.isSuccessful) throw IOException("Unexpected code $response")
-              
+
               for ((name, value) in response.headers) {
                 println("$name: $value")
               }
-              
+
               println(response.body!!.string())
             }
           }
@@ -91,33 +91,33 @@ Download a file on a worker thread, and get called back when the response is rea
 === ":material-language-java: Java"
     ```java
       private final OkHttpClient client = new OkHttpClient();
-      
+
       public void run() throws Exception {
         Request request = new Request.Builder()
             .url("http://publicobject.com/helloworld.txt")
             .build();
-        
+
         client.newCall(request).enqueue(new Callback() {
           @Override public void onFailure(Call call, IOException e) {
             e.printStackTrace();
           }
-          
+
           @Override public void onResponse(Call call, Response response) throws IOException {
             try (ResponseBody responseBody = response.body()) {
               if (!response.isSuccessful()) throw new IOException("Unexpected code " + response);
-              
+
               Headers responseHeaders = response.headers();
               for (int i = 0, size = responseHeaders.size(); i < size; i++) {
                 System.out.println(responseHeaders.name(i) + ": " + responseHeaders.value(i));
               }
-              
+
               System.out.println(responseBody.string());
             }
           }
         });
       }
     ```
- 
+
 ### Accessing Headers ([.kt][AccessHeadersKotlin], [.java][AccessHeadersJava])
 
 Typically HTTP headers work like a `Map<String, String>`: each field has one value or none. But some headers permit multiple values, like Guava's [Multimap](https://guava.dev/releases/23.0/api/docs/com/google/common/collect/Multimap.html). For example, it's legal and common for an HTTP response to supply multiple `Vary` headers. OkHttp's APIs attempt to make both cases comfortable.
@@ -131,7 +131,7 @@ To visit all headers, use the `Headers` class which supports access by index.
 === ":material-language-kotlin: Kotlin"
     ```kotlin
       private val client = OkHttpClient()
-      
+
       fun run() {
         val request = Request.Builder()
             .url("https://api.github.com/repos/square/okhttp/issues")
@@ -139,21 +139,21 @@ To visit all headers, use the `Headers` class which supports access by index.
             .addHeader("Accept", "application/json; q=0.5")
             .addHeader("Accept", "application/vnd.github.v3+json")
             .build()
-        
+
         client.newCall(request).execute().use { response ->
           if (!response.isSuccessful) throw IOException("Unexpected code $response")
-          
+
           println("Server: ${response.header("Server")}")
           println("Date: ${response.header("Date")}")
           println("Vary: ${response.headers("Vary")}")
         }
       }
     ```
-    
+
 === ":material-language-java: Java"
     ```java
       private final OkHttpClient client = new OkHttpClient();
-      
+
       public void run() throws Exception {
         Request request = new Request.Builder()
             .url("https://api.github.com/repos/square/okhttp/issues")
@@ -161,17 +161,17 @@ To visit all headers, use the `Headers` class which supports access by index.
             .addHeader("Accept", "application/json; q=0.5")
             .addHeader("Accept", "application/vnd.github.v3+json")
             .build();
-        
+
         try (Response response = client.newCall(request).execute()) {
           if (!response.isSuccessful()) throw new IOException("Unexpected code " + response);
-          
+
           System.out.println("Server: " + response.header("Server"));
           System.out.println("Date: " + response.header("Date"));
           System.out.println("Vary: " + response.headers("Vary"));
         }
       }
     ```
- 
+
 ### Posting a String ([.kt][PostStringKotlin], [.java][PostStringJava])
 
 Use an HTTP POST to send a request body to a service. This example posts a markdown document to a web service that renders markdown as HTML. Because the entire request body is in memory simultaneously, avoid posting large (greater than 1 MiB) documents using this API.
@@ -179,7 +179,7 @@ Use an HTTP POST to send a request body to a service. This example posts a markd
 === ":material-language-kotlin: Kotlin"
     ```kotlin
       private val client = OkHttpClient()
-      
+
       fun run() {
         val postBody = """
             |Releases
@@ -189,19 +189,19 @@ Use an HTTP POST to send a request body to a service. This example posts a markd
             | * _1.1_ June 15, 2013
             | * _1.2_ August 11, 2013
             |""".trimMargin()
-        
+
         val request = Request.Builder()
             .url("https://api.github.com/markdown/raw")
             .post(postBody.toRequestBody(MEDIA_TYPE_MARKDOWN))
             .build()
-        
+
         client.newCall(request).execute().use { response ->
           if (!response.isSuccessful) throw IOException("Unexpected code $response")
-          
+
           println(response.body!!.string())
         }
       }
-      
+
       companion object {
         val MEDIA_TYPE_MARKDOWN = "text/x-markdown; charset=utf-8".toMediaType()
       }
@@ -210,9 +210,9 @@ Use an HTTP POST to send a request body to a service. This example posts a markd
     ```java
       public static final MediaType MEDIA_TYPE_MARKDOWN
           = MediaType.parse("text/x-markdown; charset=utf-8");
-      
+
       private final OkHttpClient client = new OkHttpClient();
-      
+
       public void run() throws Exception {
         String postBody = ""
             + "Releases\n"
@@ -221,32 +221,32 @@ Use an HTTP POST to send a request body to a service. This example posts a markd
             + " * _1.0_ May 6, 2013\n"
             + " * _1.1_ June 15, 2013\n"
             + " * _1.2_ August 11, 2013\n";
-        
+
         Request request = new Request.Builder()
             .url("https://api.github.com/markdown/raw")
             .post(RequestBody.create(MEDIA_TYPE_MARKDOWN, postBody))
             .build();
-        
+
         try (Response response = client.newCall(request).execute()) {
           if (!response.isSuccessful()) throw new IOException("Unexpected code " + response);
-          
+
           System.out.println(response.body().string());
         }
       }
     ```
- 
+
 ### Post Streaming ([.kt][PostStreamingKotlin], [.java][PostStreamingJava])
- 
+
 Here we `POST` a request body as a stream. The content of this request body is being generated as it's being written. This example streams directly into the [Okio](https://github.com/square/okio) buffered sink. Your programs may prefer an `OutputStream`, which you can get from `BufferedSink.outputStream()`.
 
 === ":material-language-kotlin: Kotlin"
     ```kotlin
       private val client = OkHttpClient()
-    
+
       fun run() {
         val requestBody = object : RequestBody() {
           override fun contentType() = MEDIA_TYPE_MARKDOWN
-    
+
           override fun writeTo(sink: BufferedSink) {
             sink.writeUtf8("Numbers\n")
             sink.writeUtf8("-------\n")
@@ -254,7 +254,7 @@ Here we `POST` a request body as a stream. The content of this request body is b
               sink.writeUtf8(String.format(" * $i = ${factor(i)}\n"))
             }
           }
-    
+
           private fun factor(n: Int): String {
             for (i in 2 until n) {
               val x = n / i
@@ -263,19 +263,19 @@ Here we `POST` a request body as a stream. The content of this request body is b
             return n.toString()
           }
         }
-    
+
         val request = Request.Builder()
             .url("https://api.github.com/markdown/raw")
             .post(requestBody)
             .build()
-    
+
         client.newCall(request).execute().use { response ->
           if (!response.isSuccessful) throw IOException("Unexpected code $response")
-    
+
           println(response.body!!.string())
         }
       }
-    
+
       companion object {
         val MEDIA_TYPE_MARKDOWN = "text/x-markdown; charset=utf-8".toMediaType()
       }
@@ -284,15 +284,15 @@ Here we `POST` a request body as a stream. The content of this request body is b
     ```java
       public static final MediaType MEDIA_TYPE_MARKDOWN
           = MediaType.parse("text/x-markdown; charset=utf-8");
-    
+
       private final OkHttpClient client = new OkHttpClient();
-    
+
       public void run() throws Exception {
         RequestBody requestBody = new RequestBody() {
           @Override public MediaType contentType() {
             return MEDIA_TYPE_MARKDOWN;
           }
-    
+
           @Override public void writeTo(BufferedSink sink) throws IOException {
             sink.writeUtf8("Numbers\n");
             sink.writeUtf8("-------\n");
@@ -300,7 +300,7 @@ Here we `POST` a request body as a stream. The content of this request body is b
               sink.writeUtf8(String.format(" * %s = %s\n", i, factor(i)));
             }
           }
-    
+
           private String factor(int n) {
             for (int i = 2; i < n; i++) {
               int x = n / i;
@@ -309,20 +309,20 @@ Here we `POST` a request body as a stream. The content of this request body is b
             return Integer.toString(n);
           }
         };
-    
+
         Request request = new Request.Builder()
             .url("https://api.github.com/markdown/raw")
             .post(requestBody)
             .build();
-    
+
         try (Response response = client.newCall(request).execute()) {
           if (!response.isSuccessful()) throw new IOException("Unexpected code " + response);
-    
+
           System.out.println(response.body().string());
         }
       }
     ```
- 
+
 ### Posting a File ([.kt][PostFileKotlin], [.java][PostFileJava])
 
 It's easy to use a file as a request body.
@@ -330,22 +330,22 @@ It's easy to use a file as a request body.
 === ":material-language-kotlin: Kotlin"
     ```kotlin
       private val client = OkHttpClient()
-    
+
       fun run() {
         val file = File("README.md")
-    
+
         val request = Request.Builder()
             .url("https://api.github.com/markdown/raw")
             .post(file.asRequestBody(MEDIA_TYPE_MARKDOWN))
             .build()
-    
+
         client.newCall(request).execute().use { response ->
           if (!response.isSuccessful) throw IOException("Unexpected code $response")
-    
+
           println(response.body!!.string())
         }
       }
-    
+
       companion object {
         val MEDIA_TYPE_MARKDOWN = "text/x-markdown; charset=utf-8".toMediaType()
       }
@@ -354,25 +354,25 @@ It's easy to use a file as a request body.
     ```java
       public static final MediaType MEDIA_TYPE_MARKDOWN
           = MediaType.parse("text/x-markdown; charset=utf-8");
-    
+
       private final OkHttpClient client = new OkHttpClient();
-    
+
       public void run() throws Exception {
         File file = new File("README.md");
-    
+
         Request request = new Request.Builder()
             .url("https://api.github.com/markdown/raw")
             .post(RequestBody.create(MEDIA_TYPE_MARKDOWN, file))
             .build();
-    
+
         try (Response response = client.newCall(request).execute()) {
           if (!response.isSuccessful()) throw new IOException("Unexpected code " + response);
-    
+
           System.out.println(response.body().string());
         }
       }
     ```
- 
+
 ### Posting form parameters ([.kt][PostFormKotlin], [.java][PostFormJava])
 
 Use `FormBody.Builder` to build a request body that works like an HTML `<form>` tag. Names and values will be encoded using an HTML-compatible form URL encoding.
@@ -380,7 +380,7 @@ Use `FormBody.Builder` to build a request body that works like an HTML `<form>`
 === ":material-language-kotlin: Kotlin"
     ```kotlin
       private val client = OkHttpClient()
-    
+
       fun run() {
         val formBody = FormBody.Builder()
             .add("search", "Jurassic Park")
@@ -389,10 +389,10 @@ Use `FormBody.Builder` to build a request body that works like an HTML `<form>`
             .url("https://en.wikipedia.org/w/index.php")
             .post(formBody)
             .build()
-    
+
         client.newCall(request).execute().use { response ->
           if (!response.isSuccessful) throw IOException("Unexpected code $response")
-    
+
           println(response.body!!.string())
         }
       }
@@ -400,7 +400,7 @@ Use `FormBody.Builder` to build a request body that works like an HTML `<form>`
 === ":material-language-java: Java"
     ```java
       private final OkHttpClient client = new OkHttpClient();
-    
+
       public void run() throws Exception {
         RequestBody formBody = new FormBody.Builder()
             .add("search", "Jurassic Park")
@@ -409,15 +409,15 @@ Use `FormBody.Builder` to build a request body that works like an HTML `<form>`
             .url("https://en.wikipedia.org/w/index.php")
             .post(formBody)
             .build();
-    
+
         try (Response response = client.newCall(request).execute()) {
           if (!response.isSuccessful()) throw new IOException("Unexpected code " + response);
-    
+
           System.out.println(response.body().string());
         }
       }
     ```
- 
+
 ### Posting a multipart request ([.kt][PostMultipartKotlin], [.java][PostMultipartJava])
 
 `MultipartBody.Builder` can build sophisticated request bodies compatible with HTML file upload forms. Each part of a multipart request body is itself a request body, and can define its own headers. If present, these headers should describe the part body, such as its `Content-Disposition`. The `Content-Length` and `Content-Type` headers are added automatically if they're available.
@@ -425,7 +425,7 @@ Use `FormBody.Builder` to build a request body that works like an HTML `<form>`
 === ":material-language-kotlin: Kotlin"
     ```kotlin
       private val client = OkHttpClient()
-    
+
       fun run() {
         // Use the imgur image upload API as documented at https://api.imgur.com/endpoints/image
         val requestBody = MultipartBody.Builder()
@@ -434,20 +434,20 @@ Use `FormBody.Builder` to build a request body that works like an HTML `<form>`
             .addFormDataPart("image", "logo-square.png",
                 File("docs/images/logo-square.png").asRequestBody(MEDIA_TYPE_PNG))
             .build()
-    
+
         val request = Request.Builder()
             .header("Authorization", "Client-ID $IMGUR_CLIENT_ID")
             .url("https://api.imgur.com/3/image")
             .post(requestBody)
             .build()
-    
+
         client.newCall(request).execute().use { response ->
           if (!response.isSuccessful) throw IOException("Unexpected code $response")
-    
+
           println(response.body!!.string())
         }
       }
-    
+
       companion object {
         /**
          * The imgur client ID for OkHttp recipes. If you're using imgur for anything other than running
@@ -465,9 +465,9 @@ Use `FormBody.Builder` to build a request body that works like an HTML `<form>`
        */
       private static final String IMGUR_CLIENT_ID = "...";
       private static final MediaType MEDIA_TYPE_PNG = MediaType.parse("image/png");
-    
+
       private final OkHttpClient client = new OkHttpClient();
-    
+
       public void run() throws Exception {
         // Use the imgur image upload API as documented at https://api.imgur.com/endpoints/image
         RequestBody requestBody = new MultipartBody.Builder()
@@ -476,23 +476,23 @@ Use `FormBody.Builder` to build a request body that works like an HTML `<form>`
             .addFormDataPart("image", "logo-square.png",
                 RequestBody.create(MEDIA_TYPE_PNG, new File("website/static/logo-square.png")))
             .build();
-    
+
         Request request = new Request.Builder()
             .header("Authorization", "Client-ID " + IMGUR_CLIENT_ID)
             .url("https://api.imgur.com/3/image")
             .post(requestBody)
             .build();
-    
+
         try (Response response = client.newCall(request).execute()) {
           if (!response.isSuccessful()) throw new IOException("Unexpected code " + response);
-    
+
           System.out.println(response.body().string());
         }
       }
     ```
- 
+
 ### Parse a JSON Response With Moshi ([.kt][ParseResponseWithMoshiKotlin], [.java][ParseResponseWithMoshiJava])
-  
+
 [Moshi](https://github.com/square/moshi) is a handy API for converting between JSON and Java objects. Here we're using it to decode a JSON response from a GitHub API.
 
 Note that `ResponseBody.charStream()` uses the `Content-Type` response header to select which charset to use when decoding the response body. It defaults to `UTF-8` if no charset is specified.
@@ -502,26 +502,26 @@ Note that `ResponseBody.charStream()` uses the `Content-Type` response header to
       private val client = OkHttpClient()
       private val moshi = Moshi.Builder().build()
       private val gistJsonAdapter = moshi.adapter(Gist::class.java)
-    
+
       fun run() {
         val request = Request.Builder()
             .url("https://api.github.com/gists/c2a7c39532239ff261be")
             .build()
         client.newCall(request).execute().use { response ->
           if (!response.isSuccessful) throw IOException("Unexpected code $response")
-    
+
           val gist = gistJsonAdapter.fromJson(response.body!!.source())
-    
+
           for ((key, value) in gist!!.files!!) {
             println(key)
             println(value.content)
           }
         }
       }
-    
+
       @JsonClass(generateAdapter = true)
       data class Gist(var files: Map<String, GistFile>?)
-    
+
       @JsonClass(generateAdapter = true)
       data class GistFile(var content: String?)
     ```
@@ -530,32 +530,32 @@ Note that `ResponseBody.charStream()` uses the `Content-Type` response header to
       private final OkHttpClient client = new OkHttpClient();
       private final Moshi moshi = new Moshi.Builder().build();
       private final JsonAdapter<Gist> gistJsonAdapter = moshi.adapter(Gist.class);
-    
+
       public void run() throws Exception {
         Request request = new Request.Builder()
             .url("https://api.github.com/gists/c2a7c39532239ff261be")
             .build();
         try (Response response = client.newCall(request).execute()) {
           if (!response.isSuccessful()) throw new IOException("Unexpected code " + response);
-    
+
           Gist gist = gistJsonAdapter.fromJson(response.body().source());
-    
+
           for (Map.Entry<String, GistFile> entry : gist.files.entrySet()) {
             System.out.println(entry.getKey());
             System.out.println(entry.getValue().content);
           }
         }
       }
-    
+
       static class Gist {
         Map<String, GistFile> files;
       }
-    
+
       static class GistFile {
         String content;
       }
     ```
- 
+
 ### Response Caching ([.kt][CacheResponseKotlin], [.java][CacheResponseJava])
 
 To cache responses, you'll need a cache directory that you can read and write to, and a limit on the cache's size. The cache directory should be private, and untrusted applications should not be able to read its contents!
@@ -572,78 +572,78 @@ Response caching uses HTTP headers for all configuration. You can add request he
               maxSize = 10L * 1024L * 1024L // 10 MiB
           ))
           .build()
-    
+
       fun run() {
         val request = Request.Builder()
             .url("http://publicobject.com/helloworld.txt")
             .build()
-    
+
         val response1Body = client.newCall(request).execute().use {
           if (!it.isSuccessful) throw IOException("Unexpected code $it")
-    
+
           println("Response 1 response:          $it")
           println("Response 1 cache response:    ${it.cacheResponse}")
           println("Response 1 network response:  ${it.networkResponse}")
           return@use it.body!!.string()
         }
-    
+
         val response2Body = client.newCall(request).execute().use {
           if (!it.isSuccessful) throw IOException("Unexpected code $it")
-    
+
           println("Response 2 response:          $it")
           println("Response 2 cache response:    ${it.cacheResponse}")
           println("Response 2 network response:  ${it.networkResponse}")
           return@use it.body!!.string()
         }
-    
+
         println("Response 2 equals Response 1? " + (response1Body == response2Body))
       }
     ```
 === ":material-language-java: Java"
     ```java
       private final OkHttpClient client;
-    
+
       public CacheResponse(File cacheDirectory) throws Exception {
         int cacheSize = 10 * 1024 * 1024; // 10 MiB
         Cache cache = new Cache(cacheDirectory, cacheSize);
-    
+
         client = new OkHttpClient.Builder()
             .cache(cache)
             .build();
       }
-    
+
       public void run() throws Exception {
         Request request = new Request.Builder()
             .url("http://publicobject.com/helloworld.txt")
             .build();
-    
+
         String response1Body;
         try (Response response1 = client.newCall(request).execute()) {
           if (!response1.isSuccessful()) throw new IOException("Unexpected code " + response1);
-    
+
           response1Body = response1.body().string();
           System.out.println("Response 1 response:          " + response1);
           System.out.println("Response 1 cache response:    " + response1.cacheResponse());
           System.out.println("Response 1 network response:  " + response1.networkResponse());
         }
-    
+
         String response2Body;
         try (Response response2 = client.newCall(request).execute()) {
           if (!response2.isSuccessful()) throw new IOException("Unexpected code " + response2);
-    
+
           response2Body = response2.body().string();
           System.out.println("Response 2 response:          " + response2);
           System.out.println("Response 2 cache response:    " + response2.cacheResponse());
           System.out.println("Response 2 network response:  " + response2.networkResponse());
         }
-    
+
         System.out.println("Response 2 equals Response 1? " + response1Body.equals(response2Body));
       }
     ```
 
 To prevent a response from using the cache, use [`CacheControl.FORCE_NETWORK`](http://square.github.io/okhttp/4.x/okhttp/okhttp3/-cache-control/-f-o-r-c-e_-n-e-t-w-o-r-k/). To prevent it from using the network, use [`CacheControl.FORCE_CACHE`](http://square.github.io/okhttp/4.x/okhttp/okhttp3/-cache-control/-f-o-r-c-e_-c-a-c-h-e/). Be warned: if you use `FORCE_CACHE` and the response requires the network, OkHttp will return a `504 Unsatisfiable Request` response.
 
- 
+
 ### Canceling a Call ([.kt][CancelCallKotlin], [.java][CancelCallJava])
 
 Use `Call.cancel()` to stop an ongoing call immediately. If a thread is currently writing a request or reading a response, it will receive an `IOException`. Use this to conserve the network when a call is no longer necessary; for example when your user navigates away from an application. Both synchronous and asynchronous calls can be canceled.
@@ -652,22 +652,22 @@ Use `Call.cancel()` to stop an ongoing call immediately. If a thread is currentl
     ```kotlin
       private val executor = Executors.newScheduledThreadPool(1)
       private val client = OkHttpClient()
-    
+
       fun run() {
         val request = Request.Builder()
             .url("http://httpbin.org/delay/2") // This URL is served with a 2 second delay.
             .build()
-    
+
         val startNanos = System.nanoTime()
         val call = client.newCall(request)
-    
+
         // Schedule a job to cancel the call in 1 second.
         executor.schedule({
           System.out.printf("%.2f Canceling call.%n", (System.nanoTime() - startNanos) / 1e9f)
           call.cancel()
           System.out.printf("%.2f Canceled call.%n", (System.nanoTime() - startNanos) / 1e9f)
         }, 1, TimeUnit.SECONDS)
-    
+
         System.out.printf("%.2f Executing call.%n", (System.nanoTime() - startNanos) / 1e9f)
         try {
           call.execute().use { response ->
@@ -684,15 +684,15 @@ Use `Call.cancel()` to stop an ongoing call immediately. If a thread is currentl
     ```java
       private final ScheduledExecutorService executor = Executors.newScheduledThreadPool(1);
       private final OkHttpClient client = new OkHttpClient();
-    
+
       public void run() throws Exception {
         Request request = new Request.Builder()
             .url("http://httpbin.org/delay/2") // This URL is served with a 2 second delay.
             .build();
-    
+
         final long startNanos = System.nanoTime();
         final Call call = client.newCall(request);
-    
+
         // Schedule a job to cancel the call in 1 second.
         executor.schedule(new Runnable() {
           @Override public void run() {
@@ -701,7 +701,7 @@ Use `Call.cancel()` to stop an ongoing call immediately. If a thread is currentl
             System.out.printf("%.2f Canceled call.%n", (System.nanoTime() - startNanos) / 1e9f);
           }
         }, 1, TimeUnit.SECONDS);
-    
+
         System.out.printf("%.2f Executing call.%n", (System.nanoTime() - startNanos) / 1e9f);
         try (Response response = call.execute()) {
           System.out.printf("%.2f Call was expected to fail, but completed: %s%n",
@@ -712,7 +712,7 @@ Use `Call.cancel()` to stop an ongoing call immediately. If a thread is currentl
         }
       }
     ```
- 
+
 ### Timeouts ([.kt][ConfigureTimeoutsKotlin], [.java][ConfigureTimeoutsJava])
 
 Use timeouts to fail a call when its peer is unreachable. Network partitions can be due to client connectivity problems, server availability problems, or anything between. OkHttp supports connect, write, read, and full call timeouts.
@@ -725,12 +725,12 @@ Use timeouts to fail a call when its peer is unreachable. Network partitions can
           .readTimeout(5, TimeUnit.SECONDS)
           .callTimeout(10, TimeUnit.SECONDS)
           .build()
-    
+
       fun run() {
         val request = Request.Builder()
             .url("http://httpbin.org/delay/2") // This URL is served with a 2 second delay.
             .build()
-    
+
         client.newCall(request).execute().use { response ->
           println("Response completed: $response")
         }
@@ -739,7 +739,7 @@ Use timeouts to fail a call when its peer is unreachable. Network partitions can
 === ":material-language-java: Java"
     ```java
       private final OkHttpClient client;
-    
+
       public ConfigureTimeouts() throws Exception {
         client = new OkHttpClient.Builder()
             .connectTimeout(10, TimeUnit.SECONDS)
@@ -747,18 +747,18 @@ Use timeouts to fail a call when its peer is unreachable. Network partitions can
             .readTimeout(30, TimeUnit.SECONDS)
             .build();
       }
-    
+
       public void run() throws Exception {
         Request request = new Request.Builder()
             .url("http://httpbin.org/delay/2") // This URL is served with a 2 second delay.
             .build();
-    
+
         try (Response response = client.newCall(request).execute()) {
           System.out.println("Response completed: " + response);
         }
       }
     ```
- 
+
 ### Per-call Configuration ([.kt][PerCallSettingsKotlin], [.java][PerCallSettingsJava])
 
 All the HTTP client configuration lives in `OkHttpClient` including proxy settings, timeouts, and caches. When you need to change the configuration of a single call, call `OkHttpClient.newBuilder()`. This returns a builder that shares the same connection pool, dispatcher, and configuration with the original client. In the example below, we make one request with a 500 ms timeout and another with a 3000 ms timeout.
@@ -766,12 +766,12 @@ All the HTTP client configuration lives in `OkHttpClient` including proxy settin
 === ":material-language-kotlin: Kotlin"
     ```kotlin
       private val client = OkHttpClient()
-    
+
       fun run() {
         val request = Request.Builder()
             .url("http://httpbin.org/delay/1") // This URL is served with a 1 second delay.
             .build()
-    
+
         // Copy to customize OkHttp for this request.
         val client1 = client.newBuilder()
             .readTimeout(500, TimeUnit.MILLISECONDS)
@@ -783,7 +783,7 @@ All the HTTP client configuration lives in `OkHttpClient` including proxy settin
         } catch (e: IOException) {
           println("Response 1 failed: $e")
         }
-    
+
         // Copy to customize OkHttp for this request.
         val client2 = client.newBuilder()
             .readTimeout(3000, TimeUnit.MILLISECONDS)
@@ -800,12 +800,12 @@ All the HTTP client configuration lives in `OkHttpClient` including proxy settin
 === ":material-language-java: Java"
     ```java
       private final OkHttpClient client = new OkHttpClient();
-    
+
       public void run() throws Exception {
         Request request = new Request.Builder()
             .url("http://httpbin.org/delay/1") // This URL is served with a 1 second delay.
             .build();
-    
+
         // Copy to customize OkHttp for this request.
         OkHttpClient client1 = client.newBuilder()
             .readTimeout(500, TimeUnit.MILLISECONDS)
@@ -815,7 +815,7 @@ All the HTTP client configuration lives in `OkHttpClient` including proxy settin
         } catch (IOException e) {
           System.out.println("Response 1 failed: " + e);
         }
-    
+
         // Copy to customize OkHttp for this request.
         OkHttpClient client2 = client.newBuilder()
             .readTimeout(3000, TimeUnit.MILLISECONDS)
@@ -827,7 +827,7 @@ All the HTTP client configuration lives in `OkHttpClient` including proxy settin
         }
       }
     ```
- 
+
 ### Handling authentication ([.kt][AuthenticateKotlin], [.java][AuthenticateJava])
 
 OkHttp can automatically retry unauthenticated requests. When a response is `401 Not Authorized`, an `Authenticator` is asked to supply credentials. Implementations should build a new request that includes the missing credentials. If no credentials are available, return null to skip the retry.
@@ -843,7 +843,7 @@ Use `Response.challenges()` to get the schemes and realms of any authentication
               if (response.request.header("Authorization") != null) {
                 return null // Give up, we've already attempted to authenticate.
               }
-    
+
               println("Authenticating for response: $response")
               println("Challenges: ${response.challenges()}")
               val credential = Credentials.basic("jesse", "password1")
@@ -853,17 +853,40 @@ Use `Response.challenges()` to get the schemes and realms of any authentication
             }
           })
           .build()
-    
+
       fun run() {
         val request = Request.Builder()
             .url("http://publicobject.com/secrets/hellosecret.txt")
             .build()
       }
     ```
+
+    To avoid making many retries when authentication isn't working, you can return null to give up. For example, you may want to skip the retry when these exact credentials have already been attempted:
+
+    ```kotlin
+    if (credential == response.request.header("Authorization")) {
+      return null // If we already failed with these credentials, don't retry.
+     }
+    ```
+
+    You may also skip the retry when youve hit an application-defined attempt limit:
+
+    ```kotlin
+    if (response.responseCount >= 3) {
+      return null // If we've failed 3 times, give up.
+    }
+    ```
+
+    This above code relies on this `responseCount` extension val:
+
+    ```kotlin
+    val Response.responseCount: Int
+      get() = generateSequence(this) { it.priorResponse }.count()
+    ```
 === ":material-language-java: Java"
     ```java
       private final OkHttpClient client;
-    
+
       public Authenticate() {
         client = new OkHttpClient.Builder()
             .authenticator(new Authenticator() {
@@ -871,7 +894,7 @@ Use `Response.challenges()` to get the schemes and realms of any authentication
                 if (response.request().header("Authorization") != null) {
                   return null; // Give up, we've already attempted to authenticate.
                 }
-    
+
                 System.out.println("Authenticating for response: " + response);
                 System.out.println("Challenges: " + response.challenges());
                 String credential = Credentials.basic("jesse", "password1");
@@ -882,38 +905,38 @@ Use `Response.challenges()` to get the schemes and realms of any authentication
             })
             .build();
       }
-    
+
       public void run() throws Exception {
         Request request = new Request.Builder()
             .url("http://publicobject.com/secrets/hellosecret.txt")
             .build();
-    
+
         try (Response response = client.newCall(request).execute()) {
           if (!response.isSuccessful()) throw new IOException("Unexpected code " + response);
-    
+
           System.out.println(response.body().string());
         }
       }
     ```
-    
+
     To avoid making many retries when authentication isn't working, you can return null to give up. For example, you may want to skip the retry when these exact credentials have already been attempted:
-    
+
     ```java
       if (credential.equals(response.request().header("Authorization"))) {
         return null; // If we already failed with these credentials, don't retry.
        }
     ```
-    
+
     You may also skip the retry when youve hit an application-defined attempt limit:
-    
+
     ```java
       if (responseCount(response) >= 3) {
         return null; // If we've failed 3 times, give up.
       }
     ```
-    
+
     This above code relies on this `responseCount()` method:
-    
+
     ```java
       private int responseCount(Response response) {
         int result = 1;
@@ -924,31 +947,31 @@ Use `Response.challenges()` to get the schemes and realms of any authentication
       }
     ```
 
- [SynchronousGetJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/SynchronousGet.java 
+ [SynchronousGetJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/SynchronousGet.java
  [SynchronousGetKotlin]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/kt/SynchronousGet.kt
- [AsynchronousGetJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/AsynchronousGet.java 
+ [AsynchronousGetJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/AsynchronousGet.java
  [AsynchronousGetKotlin]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/kt/AsynchronousGet.kt
- [AccessHeadersJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/AccessHeaders.java 
+ [AccessHeadersJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/AccessHeaders.java
  [AccessHeadersKotlin]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/kt/AccessHeaders.kt
- [PostStringJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/PostString.java 
+ [PostStringJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/PostString.java
  [PostStringKotlin]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/kt/PostString.kt
- [PostStreamingJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/PostStreaming.java 
+ [PostStreamingJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/PostStreaming.java
  [PostStreamingKotlin]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/kt/PostStreaming.kt
- [PostFileJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/PostFile.java 
+ [PostFileJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/PostFile.java
  [PostFileKotlin]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/kt/PostFile.kt
- [PostFormJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/PostForm.java 
+ [PostFormJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/PostForm.java
  [PostFormKotlin]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/kt/PostForm.kt
- [PostMultipartJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/PostMultipart.java 
+ [PostMultipartJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/PostMultipart.java
  [PostMultipartKotlin]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/kt/PostMultipart.kt
- [ParseResponseWithMoshiJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/ParseResponseWithMoshi.java 
+ [ParseResponseWithMoshiJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/ParseResponseWithMoshi.java
  [ParseResponseWithMoshiKotlin]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/kt/ParseResponseWithMoshi.kt
- [CacheResponseJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/CacheResponse.java 
+ [CacheResponseJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/CacheResponse.java
  [CacheResponseKotlin]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/kt/CacheResponse.kt
- [CancelCallJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/CancelCall.java 
+ [CancelCallJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/CancelCall.java
  [CancelCallKotlin]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/kt/CancelCall.kt
- [ConfigureTimeoutsJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/ConfigureTimeouts.java 
+ [ConfigureTimeoutsJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/ConfigureTimeouts.java
  [ConfigureTimeoutsKotlin]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/kt/ConfigureTimeouts.kt
- [PerCallSettingsJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/PerCallSettings.java 
+ [PerCallSettingsJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/PerCallSettings.java
  [PerCallSettingsKotlin]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/kt/PerCallSettings.kt
- [AuthenticateJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/Authenticate.java 
+ [AuthenticateJava]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/Authenticate.java
  [AuthenticateKotlin]: https://github.com/square/okhttp/blob/master/samples/guide/src/main/java/okhttp3/recipes/kt/Authenticate.kt
diff --git a/gradle.properties b/gradle.properties
index b9993d06d..3ac951dc2 100644
--- a/gradle.properties
+++ b/gradle.properties
@@ -1,3 +1,5 @@
+org.gradle.caching=true
 org.gradle.jvmargs='-Dfile.encoding=UTF-8'
+org.gradle.parallel=true
 android.enableJetifier=true
 android.useAndroidX=true
diff --git a/gradle/libs.versions.toml b/gradle/libs.versions.toml
new file mode 100644
index 000000000..4d722819a
--- /dev/null
+++ b/gradle/libs.versions.toml
@@ -0,0 +1,78 @@
+[versions]
+biz-aQute-bnd = "6.1.0"
+checkStyle = "9.2"
+com-squareup-moshi = "1.13.0"
+com-squareup-okio = "3.0.0"
+de-mannodermaus-junit5 = "1.3.0"
+graalvm = "22.0.0.2"
+org-bouncycastle = "1.70"
+org-conscrypt = "2.5.2"
+org-jetbrains-kotlin = "1.6.10"
+org-junit-jupiter = "5.8.2"
+picocli = "4.6.3"
+
+[libraries]
+amazonCorretto = "software.amazon.cryptools:AmazonCorrettoCryptoProvider:1.6.1"
+androidx-espresso-core = "androidx.test.espresso:espresso-core:3.4.0"
+androidx-junit = "androidx.test.ext:junit:1.1.3"
+androidx-test-runner = "androidx.test:runner:1.4.0"
+animalsniffer-annotations = "org.codehaus.mojo:animal-sniffer-annotations:1.21"
+aqute-resolve = { module = "biz.aQute.bnd:biz.aQute.resolve", version.ref = "biz-aQute-bnd" }
+assertj-core = "org.assertj:assertj-core:3.22.0"
+assertk = "com.willowtreeapps.assertk:assertk:0.25"
+bouncycastle-bcpkix = { module = "org.bouncycastle:bcpkix-jdk15to18", version.ref = "org-bouncycastle" }
+bouncycastle-bcprov = { module = "org.bouncycastle:bcprov-jdk15to18", version.ref = "org-bouncycastle" }
+bouncycastle-bctls = { module = "org.bouncycastle:bctls-jdk15to18", version.ref = "org-bouncycastle" }
+brotli-dec = "org.brotli:dec:0.1.2"
+checkStyle = { module = "com.puppycrawl.tools:checkstyle", version.ref = "checkStyle" }
+codehaus-signature-java18 = "org.codehaus.mojo.signature:java18:1.0"
+conscrypt-android = { module = "org.conscrypt:conscrypt-android", version.ref = "org-conscrypt" }
+conscrypt-openjdk = { module = "org.conscrypt:conscrypt-openjdk-uber", version.ref = "org-conscrypt" }
+eclipseOsgi = "org.eclipse.platform:org.eclipse.osgi:3.17.100"
+findbugs-jsr305 = "com.google.code.findbugs:jsr305:3.0.2"
+nativeImageSvm = { module = "org.graalvm.nativeimage:svm", version.ref = "graalvm" }
+gradlePlugin-android = "com.android.tools.build:gradle:7.1.1"
+gradlePlugin-androidJunit5 = "de.mannodermaus.gradle.plugins:android-junit5:1.8.0.0"
+gradlePlugin-animalsniffer = "ru.vyarus:gradle-animalsniffer-plugin:1.5.4"
+gradlePlugin-bnd = { module = "biz.aQute.bnd:biz.aQute.bnd.gradle", version.ref = "biz-aQute-bnd" }
+gradlePlugin-dokka = "org.jetbrains.dokka:dokka-gradle-plugin:1.6.10"
+gradlePlugin-errorprone = "net.ltgt.gradle:gradle-errorprone-plugin:2.0.2"
+gradlePlugin-japicmp = "me.champeau.gradle:japicmp-gradle-plugin:0.3.0"
+gradlePlugin-shadow = "gradle.plugin.com.github.johnrengelman:shadow:7.1.2"
+gradlePlugin-kotlin = { module = "org.jetbrains.kotlin:kotlin-gradle-plugin", version.ref = "org-jetbrains-kotlin" }
+gradlePlugin-graal = "gradle.plugin.com.palantir.graal:gradle-graal:0.10.0"
+gradlePlugin-spotless = "com.diffplug.spotless:spotless-plugin-gradle:6.2.2"
+gradlePlugin-mavenPublish = "com.vanniktech:gradle-maven-publish-plugin:0.18.0"
+guava-jre = "com.google.guava:guava:31.0.1-jre"
+hamcrestLibrary = "org.hamcrest:hamcrest-library:2.2"
+httpClient5 = "org.apache.httpcomponents.client5:httpclient5:5.1.3"
+jettyClient = "org.eclipse.jetty:jetty-client:11.0.8"
+jnr-unixsocket = "com.github.jnr:jnr-unixsocket:0.38.17"
+jsoup = "org.jsoup:jsoup:1.14.3"
+junit = "junit:junit:4.13.2"
+junit-jupiter-api = { module = "org.junit.jupiter:junit-jupiter-api", version.ref = "org-junit-jupiter" }
+junit-jupiter-engine = { module = "org.junit.jupiter:junit-jupiter-engine", version.ref = "org-junit-jupiter" }
+junit-jupiter-params = { module = "org.junit.jupiter:junit-jupiter-params", version.ref = "org-junit-jupiter" }
+junit-platform-console = "org.junit.platform:junit-platform-console:1.7.2"
+junit-vintage-engine = "org.junit.vintage:junit-vintage-engine:5.8.2"
+junit5android-core = { module = "de.mannodermaus.junit5:android-test-core", version.ref = "de-mannodermaus-junit5" }
+junit5android-runner = { module = "de.mannodermaus.junit5:android-test-runner", version.ref = "de-mannodermaus-junit5" }
+kotlin-junit5 = { module = "org.jetbrains.kotlin:kotlin-test-junit5", version.ref = "org-jetbrains-kotlin" }
+kotlin-reflect = { module = "org.jetbrains.kotlin:kotlin-reflect", version.ref = "org-jetbrains-kotlin" }
+kotlin-stdlib = { module = "org.jetbrains.kotlin:kotlin-stdlib", version.ref = "org-jetbrains-kotlin" }
+kotlin-stdlib-osgi = { module = "org.jetbrains.kotlin:kotlin-osgi-bundle", version.ref = "org-jetbrains-kotlin" }
+kotlin-test-annotations = { module = "org.jetbrains.kotlin:kotlin-test-annotations-common", version.ref = "org-jetbrains-kotlin" }
+kotlin-test-common = { module = "org.jetbrains.kotlin:kotlin-test-common", version.ref = "org-jetbrains-kotlin" }
+kotlin-test-js = { module = "org.jetbrains.kotlin:kotlin-test-js", version.ref = "org-jetbrains-kotlin" }
+kotlin-test-junit = { module = "org.jetbrains.kotlin:kotlin-test-junit", version.ref = "org-jetbrains-kotlin" }
+openjsse = "org.openjsse:openjsse:1.1.9"
+picocli = { module = "info.picocli:picocli", version.ref = "picocli" }
+picocli-compiler = { module = "info.picocli:picocli-codegen", version.ref = "picocli" }
+playservices-safetynet = "com.google.android.gms:play-services-safetynet:17.0.1"
+robolectric-android = "org.robolectric:android-all:12-robolectric-7732740"
+signature-android-apilevel21 = "net.sf.androidscents.signature:android-api-level-21:5.0.1_r2"
+squareup-moshi = { module = "com.squareup.moshi:moshi", version.ref = "com-squareup-moshi" }
+squareup-moshi-kotlin = { module = "com.squareup.moshi:moshi-kotlin", version.ref = "com-squareup-moshi" }
+squareup-moshi-compiler = { module = "com.squareup.moshi:moshi-kotlin-codegen", version.ref = "com-squareup-moshi" }
+squareup-okio = { module = "com.squareup.okio:okio", version.ref = "com-squareup-okio" }
+squareup-okio-fakefilesystem = { module = "com.squareup.okio:okio-fakefilesystem", version.ref = "com-squareup-okio" }
diff --git a/mockwebserver-deprecated/build.gradle.kts b/mockwebserver-deprecated/build.gradle.kts
index e4719a354..537714f0f 100644
--- a/mockwebserver-deprecated/build.gradle.kts
+++ b/mockwebserver-deprecated/build.gradle.kts
@@ -19,11 +19,11 @@ tasks.jar {
 dependencies {
   api(projects.okhttp)
   api(projects.mockwebserver3)
-  api(Dependencies.junit)
+  api(libs.junit)
 
   testImplementation(projects.okhttpTestingSupport)
   testImplementation(projects.okhttpTls)
-  testImplementation(Dependencies.assertj)
+  testImplementation(libs.assertj.core)
 }
 
 tasks.register<JapicmpTask>("japicmp") {
diff --git a/mockwebserver-junit4/build.gradle.kts b/mockwebserver-junit4/build.gradle.kts
index e3d4a8647..1c9ca31ba 100644
--- a/mockwebserver-junit4/build.gradle.kts
+++ b/mockwebserver-junit4/build.gradle.kts
@@ -15,9 +15,9 @@ tasks.jar {
 
 dependencies {
   api(projects.mockwebserver3)
-  api(Dependencies.junit)
+  api(libs.junit)
 
-  testImplementation(Dependencies.assertj)
+  testImplementation(libs.assertj.core)
 }
 
 mavenPublishing {
diff --git a/mockwebserver-junit5/build.gradle.kts b/mockwebserver-junit5/build.gradle.kts
index 3c11e4001..74b7f795a 100644
--- a/mockwebserver-junit5/build.gradle.kts
+++ b/mockwebserver-junit5/build.gradle.kts
@@ -21,12 +21,12 @@ tasks {
 
 dependencies {
   api(projects.mockwebserver3)
-  api(Dependencies.junit5Api)
-  compileOnly(Dependencies.animalSniffer)
+  api(libs.junit.jupiter.api)
+  compileOnly(libs.animalsniffer.annotations)
 
-  testRuntimeOnly(Dependencies.junit5JupiterEngine)
-  testImplementation(Dependencies.assertj)
-  testImplementation(Dependencies.kotlinJunit5)
+  testRuntimeOnly(libs.junit.jupiter.engine)
+  testImplementation(libs.assertj.core)
+  testImplementation(libs.kotlin.junit5)
 }
 
 mavenPublishing {
diff --git a/mockwebserver/build.gradle.kts b/mockwebserver/build.gradle.kts
index 1ffa5e556..44f7fa9bf 100644
--- a/mockwebserver/build.gradle.kts
+++ b/mockwebserver/build.gradle.kts
@@ -19,8 +19,8 @@ dependencies {
   testImplementation(projects.okhttpTestingSupport)
   testImplementation(projects.okhttpTls)
   testRuntimeOnly(projects.mockwebserver3Junit5)
-  testImplementation(Dependencies.junit)
-  testImplementation(Dependencies.assertj)
+  testImplementation(libs.junit)
+  testImplementation(libs.assertj.core)
 }
 
 mavenPublishing {
diff --git a/native-image-tests/build.gradle.kts b/native-image-tests/build.gradle.kts
index 98de73e22..7bbdac6b0 100644
--- a/native-image-tests/build.gradle.kts
+++ b/native-image-tests/build.gradle.kts
@@ -1,4 +1,5 @@
 import org.apache.tools.ant.taskdefs.condition.Os
+import org.jetbrains.kotlin.incremental.ChangesCollector.Companion.getNonPrivateNames
 
 plugins {
   id("com.palantir.graal")
@@ -6,11 +7,11 @@ plugins {
 }
 
 dependencies {
-  implementation(Dependencies.assertj)
-  implementation(Dependencies.junit5Api)
-  implementation(Dependencies.junit5JupiterEngine)
-  implementation(Dependencies.junitPlatformConsole)
-  implementation(Dependencies.okioFakeFileSystem)
+  implementation(libs.assertj.core)
+  implementation(libs.junit.jupiter.api)
+  implementation(libs.junit.jupiter.engine)
+  implementation(libs.junit.platform.console)
+  implementation(libs.squareup.okio.fakefilesystem)
 
   implementation(projects.okhttp)
   implementation(projects.okhttpBrotli)
@@ -19,19 +20,20 @@ dependencies {
   implementation(projects.okhttpSse)
   implementation(projects.okhttpTestingSupport)
   implementation(projects.okhttpTls)
-  implementation(Dependencies.assertj)
+  implementation(libs.assertj.core)
   implementation(projects.mockwebserver3)
   implementation(projects.mockwebserver)
   implementation(projects.okhttpUrlconnection)
   implementation(projects.mockwebserver3Junit4)
   implementation(projects.mockwebserver3Junit5)
-  implementation(Dependencies.bndResolve)
-  implementation(Dependencies.junit5Api)
-  implementation(Dependencies.junit5JupiterParams)
+  implementation(libs.aqute.resolve)
+  implementation(libs.junit.jupiter.api)
+  implementation(libs.junit.jupiter.params)
+  implementation(libs.assertk)
 
-  implementation(Dependencies.nativeImageSvm)
+  implementation(libs.nativeImageSvm)
 
-  compileOnly(Dependencies.jsr305)
+  compileOnly(libs.findbugs.jsr305)
 }
 
 animalsniffer {
@@ -52,7 +54,7 @@ sourceSets {
 graal {
   mainClass("okhttp3.RunTestsKt")
   outputName("ConsoleLauncher")
-  graalVersion(Versions.graal)
+  graalVersion(libs.versions.graalvm.get())
   javaVersion("11")
 
   option("--no-fallback")
diff --git a/okcurl/build.gradle.kts b/okcurl/build.gradle.kts
index 1574ad0b9..567a1e541 100644
--- a/okcurl/build.gradle.kts
+++ b/okcurl/build.gradle.kts
@@ -29,14 +29,14 @@ sourceSets {
 dependencies {
   api(projects.okhttp)
   api(projects.loggingInterceptor)
-  implementation(Dependencies.picocli)
-  implementation(Dependencies.guava)
+  implementation(libs.picocli)
+  implementation(libs.guava.jre)
 
-  kapt(Dependencies.picocliCompiler)
+  kapt(libs.picocli.compiler)
 
   testImplementation(projects.okhttpTestingSupport)
-  testImplementation(Dependencies.junit5Api)
-  testImplementation(Dependencies.assertj)
+  testImplementation(libs.junit.jupiter.api)
+  testImplementation(libs.assertj.core)
 }
 
 tasks.shadowJar {
@@ -46,7 +46,7 @@ tasks.shadowJar {
 graal {
   mainClass("okhttp3.curl.Main")
   outputName("okcurl")
-  graalVersion(Versions.graal)
+  graalVersion(libs.versions.graalvm.get())
   javaVersion("11")
 
   option("--no-fallback")
diff --git a/okhttp-brotli/build.gradle.kts b/okhttp-brotli/build.gradle.kts
index f9819149f..ce16d1559 100644
--- a/okhttp-brotli/build.gradle.kts
+++ b/okhttp-brotli/build.gradle.kts
@@ -15,13 +15,13 @@ project.applyOsgi(
 
 dependencies {
   api(projects.okhttp)
-  api(Dependencies.brotli)
-  compileOnly(Dependencies.jsr305)
+  api(libs.brotli.dec)
+  compileOnly(libs.findbugs.jsr305)
 
   testImplementation(projects.okhttpTestingSupport)
-  testImplementation(Dependencies.conscrypt)
-  testImplementation(Dependencies.junit)
-  testImplementation(Dependencies.assertj)
+  testImplementation(libs.conscrypt.openjdk)
+  testImplementation(libs.junit)
+  testImplementation(libs.assertj.core)
 }
 
 mavenPublishing {
diff --git a/okhttp-dnsoverhttps/build.gradle.kts b/okhttp-dnsoverhttps/build.gradle.kts
index 5e1dca211..d31ff9eea 100644
--- a/okhttp-dnsoverhttps/build.gradle.kts
+++ b/okhttp-dnsoverhttps/build.gradle.kts
@@ -15,15 +15,15 @@ project.applyOsgi(
 
 dependencies {
   api(projects.okhttp)
-  compileOnly(Dependencies.jsr305)
+  compileOnly(libs.findbugs.jsr305)
 
   testImplementation(projects.okhttpTestingSupport)
   testImplementation(projects.mockwebserver)
   testImplementation(projects.mockwebserver3Junit5)
-  testImplementation(Dependencies.okioFakeFileSystem)
-  testImplementation(Dependencies.conscrypt)
-  testImplementation(Dependencies.junit)
-  testImplementation(Dependencies.assertj)
+  testImplementation(libs.squareup.okio.fakefilesystem)
+  testImplementation(libs.conscrypt.openjdk)
+  testImplementation(libs.junit)
+  testImplementation(libs.assertj.core)
 }
 
 mavenPublishing {
diff --git a/okhttp-hpacktests/build.gradle.kts b/okhttp-hpacktests/build.gradle.kts
index 85eed9ea0..d9e9b8fb4 100644
--- a/okhttp-hpacktests/build.gradle.kts
+++ b/okhttp-hpacktests/build.gradle.kts
@@ -3,11 +3,11 @@ plugins {
 }
 
 dependencies {
-  testImplementation(Dependencies.okio)
-  testImplementation(Dependencies.moshi)
+  testImplementation(libs.squareup.okio)
+  testImplementation(libs.squareup.moshi)
   testImplementation(projects.okhttp)
   testImplementation(projects.okhttpTestingSupport)
   testImplementation(projects.mockwebserver)
-  testImplementation(Dependencies.junit)
-  testImplementation(Dependencies.assertj)
+  testImplementation(libs.junit)
+  testImplementation(libs.assertj.core)
 }
diff --git a/okhttp-logging-interceptor/build.gradle.kts b/okhttp-logging-interceptor/build.gradle.kts
index 5d1cd1acb..10c1321f3 100644
--- a/okhttp-logging-interceptor/build.gradle.kts
+++ b/okhttp-logging-interceptor/build.gradle.kts
@@ -18,15 +18,15 @@ project.applyOsgi(
 
 dependencies {
   api(projects.okhttp)
-  compileOnly(Dependencies.jsr305)
+  compileOnly(libs.findbugs.jsr305)
 
-  testCompileOnly(Dependencies.jsr305)
-  testImplementation(Dependencies.junit)
+  testCompileOnly(libs.findbugs.jsr305)
+  testImplementation(libs.junit)
   testImplementation(projects.mockwebserver3)
   testImplementation(projects.mockwebserver3Junit5)
   testImplementation(projects.okhttpTestingSupport)
   testImplementation(projects.okhttpTls)
-  testImplementation(Dependencies.assertj)
+  testImplementation(libs.assertj.core)
 }
 
 tasks.register<JapicmpTask>("japicmp") {
diff --git a/okhttp-sse/build.gradle.kts b/okhttp-sse/build.gradle.kts
index 39e9bb49a..452fe2df1 100644
--- a/okhttp-sse/build.gradle.kts
+++ b/okhttp-sse/build.gradle.kts
@@ -18,14 +18,14 @@ project.applyOsgi(
 
 dependencies {
   api(projects.okhttp)
-  compileOnly(Dependencies.jsr305)
+  compileOnly(libs.findbugs.jsr305)
 
   testImplementation(projects.okhttpTestingSupport)
   testImplementation(projects.mockwebserver3)
   testImplementation(projects.mockwebserver3Junit5)
-  testImplementation(Dependencies.junit)
-  testImplementation(Dependencies.assertj)
-  testCompileOnly(Dependencies.jsr305)
+  testImplementation(libs.junit)
+  testImplementation(libs.assertj.core)
+  testCompileOnly(libs.findbugs.jsr305)
 }
 
 tasks.register<JapicmpTask>("japicmp") {
diff --git a/okhttp-testing-support/build.gradle.kts b/okhttp-testing-support/build.gradle.kts
index 0e48e47b0..69cbce235 100644
--- a/okhttp-testing-support/build.gradle.kts
+++ b/okhttp-testing-support/build.gradle.kts
@@ -6,19 +6,21 @@ plugins {
 dependencies {
   api(projects.okhttp)
   api(projects.okhttpTls)
-  api(Dependencies.assertj)
-  api(Dependencies.bouncycastle)
-  implementation(Dependencies.bouncycastlepkix)
-  implementation(Dependencies.bouncycastletls)
-  api(Dependencies.conscrypt)
-  api(Dependencies.corretto)
-  api(Dependencies.openjsse)
-  api(Dependencies.hamcrest)
-  api(Dependencies.junit5Api)
-  api(Dependencies.junit5JupiterParams)
+  api(libs.assertj.core)
+  api(libs.bouncycastle.bcprov)
+  implementation(libs.bouncycastle.bcpkix)
+  implementation(libs.bouncycastle.bctls)
+  api(libs.conscrypt.openjdk)
+  api(libs.openjsse)
+  api(variantOf(libs.amazonCorretto) {
+    classifier("linux-x86_64")
+  })
+  api(libs.hamcrestLibrary)
+  api(libs.junit.jupiter.api)
+  api(libs.junit.jupiter.params)
 
-  compileOnly(Dependencies.jsr305)
-  compileOnly(Dependencies.android)
+  compileOnly(libs.findbugs.jsr305)
+  compileOnly(libs.robolectric.android)
 }
 
 animalsniffer {
diff --git a/okhttp-tls/build.gradle.kts b/okhttp-tls/build.gradle.kts
index 7bcae518f..957fd0f1a 100644
--- a/okhttp-tls/build.gradle.kts
+++ b/okhttp-tls/build.gradle.kts
@@ -18,15 +18,15 @@ project.applyOsgi(
 )
 
 dependencies {
-  api(Dependencies.okio)
+  api(libs.squareup.okio)
   implementation(projects.okhttp)
-  compileOnly(Dependencies.jsr305)
-  compileOnly(Dependencies.animalSniffer)
+  compileOnly(libs.findbugs.jsr305)
+  compileOnly(libs.animalsniffer.annotations)
 
   testImplementation(projects.okhttpTestingSupport)
   testImplementation(projects.mockwebserver3Junit5)
-  testImplementation(Dependencies.junit)
-  testImplementation(Dependencies.assertj)
+  testImplementation(libs.junit)
+  testImplementation(libs.assertj.core)
 }
 
 animalsniffer {
diff --git a/okhttp-urlconnection/build.gradle.kts b/okhttp-urlconnection/build.gradle.kts
index a44d76101..dbba0319e 100644
--- a/okhttp-urlconnection/build.gradle.kts
+++ b/okhttp-urlconnection/build.gradle.kts
@@ -19,14 +19,14 @@ project.applyOsgi(
 
 dependencies {
   api(projects.okhttp)
-  compileOnly(Dependencies.jsr305)
-  compileOnly(Dependencies.animalSniffer)
+  compileOnly(libs.findbugs.jsr305)
+  compileOnly(libs.animalsniffer.annotations)
 
   testImplementation(projects.okhttpTestingSupport)
   testImplementation(projects.okhttpTls)
   testImplementation(projects.mockwebserver)
-  testImplementation(Dependencies.junit)
-  testImplementation(Dependencies.assertj)
+  testImplementation(libs.junit)
+  testImplementation(libs.assertj.core)
 }
 
 tasks.register<JapicmpTask>("japicmp") {
diff --git a/okhttp/build.gradle.kts b/okhttp/build.gradle.kts
index 5d7ee802c..d5dd1fecc 100644
--- a/okhttp/build.gradle.kts
+++ b/okhttp/build.gradle.kts
@@ -40,14 +40,14 @@ kotlin {
     commonMain {
       kotlin.srcDir("$buildDir/generated/sources/kotlinTemplates")
       dependencies {
-        api(Dependencies.okio)
+        api(libs.squareup.okio)
       }
     }
     val commonTest by getting {
       dependencies {
-        implementation(Dependencies.kotlinTest)
-        implementation(Dependencies.kotlinTestAnnotations)
-        implementation(Dependencies.assertk)
+        implementation(libs.kotlin.test.common)
+        implementation(libs.kotlin.test.annotations)
+        api(libs.assertk)
       }
     }
     val nonJvmMain = create("nonJvmMain") {
@@ -63,20 +63,20 @@ kotlin {
 
     getByName("jvmMain") {
       dependencies {
-        api(Dependencies.okio)
-        api(Dependencies.kotlinStdlib)
+        api(libs.squareup.okio)
+        api(libs.kotlin.stdlib)
 
         // These compileOnly dependencies must also be listed in the OSGi configuration above.
-        compileOnly(Dependencies.android)
-        compileOnly(Dependencies.bouncycastle)
-        compileOnly(Dependencies.bouncycastletls)
-        compileOnly(Dependencies.conscrypt)
-        compileOnly(Dependencies.openjsse)
-        compileOnly(Dependencies.jsr305)
-        compileOnly(Dependencies.animalSniffer)
+        compileOnly(libs.robolectric.android)
+        compileOnly(libs.bouncycastle.bcprov)
+        compileOnly(libs.bouncycastle.bctls)
+        compileOnly(libs.conscrypt.openjdk)
+        compileOnly(libs.openjsse)
+        compileOnly(libs.findbugs.jsr305)
+        compileOnly(libs.animalsniffer.annotations)
 
         // graal build support
-        compileOnly(Dependencies.nativeImageSvm)
+        compileOnly(libs.nativeImageSvm)
       }
     }
     getByName("jvmTest") {
@@ -93,30 +93,30 @@ kotlin {
         implementation(projects.okhttpBrotli)
         implementation(projects.okhttpDnsoverhttps)
         implementation(projects.okhttpSse)
-        implementation(Dependencies.okioFakeFileSystem)
-        implementation(Dependencies.conscrypt)
-        implementation(Dependencies.junit)
-        implementation(Dependencies.junit5Api)
-        implementation(Dependencies.junit5JupiterParams)
-        implementation(Dependencies.kotlinTestJunit)
-        implementation(Dependencies.assertj)
-        implementation(Dependencies.openjsse)
-        implementation(Dependencies.bndResolve)
-        compileOnly(Dependencies.jsr305)
+        implementation(libs.squareup.okio.fakefilesystem)
+        implementation(libs.conscrypt.openjdk)
+        implementation(libs.junit)
+        implementation(libs.junit.jupiter.api)
+        implementation(libs.junit.jupiter.params)
+        implementation(libs.kotlin.test.junit)
+        implementation(libs.assertj.core)
+        implementation(libs.openjsse)
+        implementation(libs.aqute.resolve)
+        compileOnly(libs.findbugs.jsr305)
       }
 
       getByName("jsMain") {
         dependencies {
           dependsOn(nonJvmMain)
-          api(Dependencies.okio)
-          api(Dependencies.kotlinStdlib)
+          api(libs.squareup.okio)
+          api(libs.kotlin.stdlib)
         }
       }
 
       getByName("jsTest") {
         dependencies {
           dependsOn(nonJvmTest)
-          implementation(Dependencies.kotlinTestJs)
+          implementation(libs.kotlin.test.js)
         }
       }
     }
@@ -180,8 +180,8 @@ tasks.getByName("jvmTest") {
 }
 
 dependencies {
-  osgiTestDeploy(Dependencies.equinox)
-  osgiTestDeploy(Dependencies.kotlinStdlibOsgi)
+  osgiTestDeploy(libs.eclipseOsgi)
+  osgiTestDeploy(libs.kotlin.stdlib.osgi)
 }
 
 tasks.register<JapicmpTask>("japicmp") {
diff --git a/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/ConnectPlan.kt b/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/ConnectPlan.kt
index 8c7a1a75a..62477db2b 100644
--- a/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/ConnectPlan.kt
+++ b/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/ConnectPlan.kt
@@ -90,8 +90,7 @@ class ConnectPlan(
   private var sink: BufferedSink? = null
   private var connection: RealConnection? = null
 
-  /** True if this connection is ready for use, including TCP, tunnels, and TLS. */
-  override val isReady: Boolean
+  override val isConnected: Boolean
     get() = protocol != null
 
   private fun copy(
@@ -138,7 +137,7 @@ class ConnectPlan(
 
   override fun connectTlsEtc(): ConnectResult {
     check(rawSocket != null) { "TCP not connected" }
-    check(!isReady) { "already connected" }
+    check(!isConnected) { "already connected" }
 
     val connectionSpecs = route.address.connectionSpecs
     var retryTlsConnection: ConnectPlan? = null
@@ -488,20 +487,6 @@ class ConnectPlan(
     rawSocket?.closeQuietly()
   }
 
-  override fun retry(): RoutePlanner.Plan {
-    return ConnectPlan(
-      client = client,
-      call = call,
-      routePlanner = routePlanner,
-      route = route,
-      routes = routes,
-      attempt = attempt,
-      tunnelRequest = tunnelRequest,
-      connectionSpecIndex = connectionSpecIndex,
-      isTlsFallback = isTlsFallback,
-    )
-  }
-
   fun closeQuietly() {
     socket?.closeQuietly()
   }
diff --git a/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/ExchangeFinder.kt b/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/ExchangeFinder.kt
index 73444f9e6..4a36f572c 100644
--- a/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/ExchangeFinder.kt
+++ b/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/ExchangeFinder.kt
@@ -36,7 +36,7 @@ internal class ExchangeFinder(
           else -> routePlanner.plan()
         }
 
-        if (!plan.isReady) {
+        if (!plan.isConnected) {
           val tcpConnectResult = plan.connectTcp()
           val connectResult = when {
             tcpConnectResult.isSuccess -> plan.connectTlsEtc()
diff --git a/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/FailedPlan.kt b/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/FailedPlan.kt
deleted file mode 100644
index b781bcfae..000000000
--- a/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/FailedPlan.kt
+++ /dev/null
@@ -1,43 +0,0 @@
-/*
- * Copyright (C) 2022 Square, Inc.
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-package okhttp3.internal.connection
-
-/**
- * Used when we were unsuccessful in the planning phase of a connection:
- *
- *  * A DNS lookup failed
- *  * The configuration is incapable of carrying the request, such as when the client is configured
- *    to use `H2_PRIOR_KNOWLEDGE` but the URL's scheme is `https:`.
- *  * Preemptive proxy authentication failed.
- *
- * Planning failures are not necessarily fatal. For example, even if we can't DNS lookup the first
- * proxy in a list, looking up a subsequent one may succeed.
- */
-internal class FailedPlan(e: Throwable) : RoutePlanner.Plan {
-  val result = RoutePlanner.ConnectResult(plan = this, throwable = e)
-
-  override val isReady = false
-
-  override fun connectTcp() = result
-
-  override fun connectTlsEtc() = result
-
-  override fun handleSuccess() = error("unexpected call")
-
-  override fun cancel() = error("unexpected cancel")
-
-  override fun retry() = error("unexpected retry")
-}
diff --git a/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/FastFallbackExchangeFinder.kt b/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/FastFallbackExchangeFinder.kt
index f58b310eb..0c088795b 100644
--- a/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/FastFallbackExchangeFinder.kt
+++ b/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/FastFallbackExchangeFinder.kt
@@ -35,17 +35,8 @@ internal class FastFallbackExchangeFinder(
 ) {
   private val connectDelayMillis = 250L
 
-  /**
-   * Plans currently being connected, and that will later be added to [connectResults]. This is
-   * mutated by the call thread only. If is accessed by background connect threads.
-   */
-  private val tcpConnectsInFlight = CopyOnWriteArrayList<Plan>()
-
-  /**
-   * These are retries of plans that were canceled when they lost a race. If the race's winner ends
-   * up not working out, this is what we'll attempt first.
-   */
-  private val deferredPlans = ArrayDeque<Plan>()
+  /** Plans currently being connected, and that will later be added to [connectResults]. */
+  private var connectsInFlight = CopyOnWriteArrayList<Plan>()
 
   /**
    * Results are posted here as they occur. The find job is done when either one plan completes
@@ -53,125 +44,123 @@ internal class FastFallbackExchangeFinder(
    */
   private val connectResults = taskRunner.backend.decorate(LinkedBlockingDeque<ConnectResult>())
 
+  /** Exceptions accumulate here. */
+  private var firstException: IOException? = null
+
   /** True until we've launched all the connects we'll ever launch. */
-  private var routePlannerHasMoreRoutes = true
+  private var morePlansExist = true
 
   fun find(): RealConnection {
-    var firstException: IOException? = null
     try {
-      while (routePlannerHasMoreRoutes ||
-        tcpConnectsInFlight.isNotEmpty() ||
-        deferredPlans.isNotEmpty()
-      ) {
+      while (morePlansExist || connectsInFlight.isNotEmpty()) {
         if (routePlanner.isCanceled()) throw IOException("Canceled")
 
-        launchTcpConnect()
+        launchConnect()
 
-        var connectResult = awaitTcpConnect(connectDelayMillis, TimeUnit.MILLISECONDS) ?: continue
+        val connection = awaitConnection()
+        if (connection != null) return connection
 
-        if (connectResult.isSuccess) {
-          // We have a connected TCP connection. Cancel and defer the racing connects that all lost.
-          cancelInFlightConnects()
-
-          // Finish connecting. We won't have to if the winner is from the connection pool.
-          if (!connectResult.plan.isReady) {
-            connectResult = connectResult.plan.connectTlsEtc()
-          }
-
-          if (connectResult.isSuccess) {
-            return connectResult.plan.handleSuccess()
-          }
-        }
-
-        val throwable = connectResult.throwable
-        if (throwable != null) {
-          if (throwable !is IOException) throw throwable
-          routePlanner.trackFailure(throwable)
-          if (firstException == null) {
-            firstException = throwable
-          } else {
-            firstException.addSuppressed(throwable)
-          }
-        }
-
-        val nextPlan = connectResult.nextPlan
-        if (nextPlan != null) {
-          // Try this plan's successor before deferred plans because it won the race!
-          deferredPlans.addFirst(nextPlan)
-        }
+        morePlansExist = morePlansExist && routePlanner.hasMoreRoutes()
       }
+
+      throw firstException!!
     } finally {
-      cancelInFlightConnects()
+      for (plan in connectsInFlight) {
+        plan.cancel()
+      }
     }
-
-    throw firstException!!
   }
 
-  private fun launchTcpConnect() {
-    val plan = when {
-      deferredPlans.isNotEmpty() -> {
-        deferredPlans.removeFirst()
-      }
-      routePlannerHasMoreRoutes -> {
-        try {
-          routePlanner.plan()
-        } catch (e: Throwable) {
-          FailedPlan(e)
-        } finally {
-          routePlannerHasMoreRoutes = routePlanner.hasMoreRoutes()
-        }
-      }
-      else -> return // Nothing further to try.
+  private fun launchConnect() {
+    if (!morePlansExist) return
+
+    val plan = try {
+      routePlanner.plan()
+    } catch (e: IOException) {
+      trackFailure(e)
+      return
     }
 
-    tcpConnectsInFlight += plan
+    connectsInFlight += plan
 
     // Already connected? Enqueue the result immediately.
-    if (plan.isReady) {
+    if (plan.isConnected) {
       connectResults.put(ConnectResult(plan))
       return
     }
 
-    // Already failed? Enqueue the result immediately.
-    if (plan is FailedPlan) {
-      connectResults.put(plan.result)
-      return
-    }
-
-    // Connect TCP asynchronously.
+    // Connect asynchronously.
     val taskName = "$okHttpName connect ${routePlanner.address.url.redact()}"
     taskRunner.newQueue().schedule(object : Task(taskName) {
       override fun runOnce(): Long {
         val connectResult = try {
-          plan.connectTcp()
+          connectAndDoRetries()
         } catch (e: Throwable) {
           ConnectResult(plan, throwable = e)
         }
-        // Only post a result if this hasn't since been canceled.
-        if (plan in tcpConnectsInFlight) {
-          connectResults.put(connectResult)
-        }
+        connectResults.put(connectResult)
         return -1L
       }
+
+      private fun connectAndDoRetries(): ConnectResult {
+        var firstException: Throwable? = null
+        var currentPlan = plan
+        while (true) {
+          val tcpConnectResult = currentPlan.connectTcp()
+          val connectResult = when {
+            tcpConnectResult.isSuccess -> currentPlan.connectTlsEtc()
+            else -> tcpConnectResult
+          }
+
+          if (connectResult.throwable == null) {
+            if (connectResult.nextPlan == null) return connectResult // Success.
+          } else {
+            if (firstException == null) {
+              firstException = connectResult.throwable
+            } else {
+              firstException.addSuppressed(connectResult.throwable)
+            }
+
+            // Fail if there's no next plan, or if this failure exception is not recoverable.
+            if (connectResult.nextPlan == null || connectResult.throwable !is IOException) break
+          }
+
+          // Replace the currently-running plan with its successor.
+          connectsInFlight.add(connectResult.nextPlan)
+          connectsInFlight.remove(currentPlan)
+          currentPlan = connectResult.nextPlan
+        }
+
+        return ConnectResult(currentPlan, throwable = firstException)
+      }
     })
   }
 
-  private fun awaitTcpConnect(timeout: Long, unit: TimeUnit): ConnectResult? {
-    if (tcpConnectsInFlight.isEmpty()) return null
+  private fun awaitConnection(): RealConnection? {
+    if (connectsInFlight.isEmpty()) return null
 
-    val result = connectResults.poll(timeout, unit) ?: return null
+    val completed = connectResults.poll(connectDelayMillis, TimeUnit.MILLISECONDS) ?: return null
 
-    tcpConnectsInFlight.remove(result.plan)
+    connectsInFlight.remove(completed.plan)
 
-    return result
+    val exception = completed.throwable
+    if (exception is IOException) {
+      trackFailure(exception)
+      return null
+    } else if (exception != null) {
+      throw exception
+    }
+
+    return completed.plan.handleSuccess()
   }
 
-  private fun cancelInFlightConnects() {
-    for (plan in tcpConnectsInFlight) {
-      plan.cancel()
-      val retry = plan.retry() ?: continue
-      deferredPlans += retry
+  private fun trackFailure(exception: IOException) {
+    routePlanner.trackFailure(exception)
+
+    if (firstException == null) {
+      firstException = exception
+    } else {
+      firstException!!.addSuppressed(exception)
     }
-    tcpConnectsInFlight.clear()
   }
 }
diff --git a/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/RealRoutePlanner.kt b/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/RealRoutePlanner.kt
index 2abb5cb3a..322a1050e 100644
--- a/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/RealRoutePlanner.kt
+++ b/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/RealRoutePlanner.kt
@@ -30,6 +30,7 @@ import okhttp3.Route
 import okhttp3.internal.EMPTY_RESPONSE
 import okhttp3.internal.canReuseConnectionFor
 import okhttp3.internal.closeQuietly
+import okhttp3.internal.connection.RoutePlanner.ConnectResult
 import okhttp3.internal.connection.RoutePlanner.Plan
 import okhttp3.internal.http.RealInterceptorChain
 import okhttp3.internal.http2.ConnectionShutdownException
@@ -175,7 +176,7 @@ class RealRoutePlanner(
       address = address,
       call = call,
       routes = routes,
-      requireMultiplexed = planToReplace != null && planToReplace.isReady
+      requireMultiplexed = planToReplace != null && planToReplace.isConnected
     ) ?: return null
 
     // If we coalesced our connection, remember the replaced connection's route. That way if the
@@ -189,6 +190,28 @@ class RealRoutePlanner(
     return ReusePlan(result)
   }
 
+  /** Reuse an existing connection. */
+  internal class ReusePlan(
+    val connection: RealConnection,
+  ) : Plan {
+
+    override val isConnected: Boolean = true
+
+    override fun connectTcp(): ConnectResult {
+      error("already connected")
+    }
+
+    override fun connectTlsEtc(): ConnectResult {
+      error("already connected")
+    }
+
+    override fun handleSuccess() = connection
+
+    override fun cancel() {
+      error("unexpected cancel of reused connection")
+    }
+  }
+
   /** Returns a plan for the first attempt at [route]. This throws if no plan is possible. */
   @Throws(IOException::class)
   internal fun planConnectToRoute(route: Route, routes: List<Route>? = null): ConnectPlan {
diff --git a/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/ReusePlan.kt b/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/ReusePlan.kt
deleted file mode 100644
index e9a53ccbc..000000000
--- a/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/ReusePlan.kt
+++ /dev/null
@@ -1,34 +0,0 @@
-/*
- * Copyright (C) 2022 Square, Inc.
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-package okhttp3.internal.connection
-
-/** Reuse a connection from the pool. */
-internal class ReusePlan(
-  val connection: RealConnection,
-) : RoutePlanner.Plan {
-
-  override val isReady = true
-
-  override fun connectTcp() = error("already connected")
-
-  override fun connectTlsEtc() = error("already connected")
-
-  override fun handleSuccess() = connection
-
-  override fun cancel() = error("unexpected cancel")
-
-  override fun retry() = error("unexpected retry")
-}
diff --git a/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/RoutePlanner.kt b/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/RoutePlanner.kt
index b3f07b7a3..56b534485 100644
--- a/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/RoutePlanner.kt
+++ b/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/RoutePlanner.kt
@@ -72,7 +72,7 @@ interface RoutePlanner {
    * multiple plans concurrently.
    */
   interface Plan {
-    val isReady: Boolean
+    val isConnected: Boolean
 
     fun connectTcp(): ConnectResult
 
@@ -81,9 +81,6 @@ interface RoutePlanner {
     fun handleSuccess(): RealConnection
 
     fun cancel()
-
-    /** Returns a plan to attempt if canceling this plan was a mistake! */
-    fun retry(): Plan?
   }
 
   /**
diff --git a/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/RouteSelector.kt b/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/RouteSelector.kt
index f73a83a2e..409a4abf5 100644
--- a/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/RouteSelector.kt
+++ b/okhttp/src/jvmMain/kotlin/okhttp3/internal/connection/RouteSelector.kt
@@ -16,6 +16,7 @@
 package okhttp3.internal.connection
 
 import java.io.IOException
+import java.net.InetAddress
 import java.net.InetSocketAddress
 import java.net.Proxy
 import java.net.SocketException
@@ -26,6 +27,7 @@ import okhttp3.Call
 import okhttp3.EventListener
 import okhttp3.HttpUrl
 import okhttp3.Route
+import okhttp3.internal.canParseAsIpAddress
 import okhttp3.internal.immutableListOf
 import okhttp3.internal.toImmutableList
 
@@ -159,15 +161,20 @@ class RouteSelector(
     if (proxy.type() == Proxy.Type.SOCKS) {
       mutableInetSocketAddresses += InetSocketAddress.createUnresolved(socketHost, socketPort)
     } else {
-      eventListener.dnsStart(call, socketHost)
+      val addresses = if (socketHost.canParseAsIpAddress()) {
+        listOf(InetAddress.getByName(socketHost))
+      } else {
+        eventListener.dnsStart(call, socketHost)
+
+        val result = address.dns.lookup(socketHost)
+        if (result.isEmpty()) {
+          throw UnknownHostException("${address.dns} returned no addresses for $socketHost")
+        }
 
-      val addresses = address.dns.lookup(socketHost)
-      if (addresses.isEmpty()) {
-        throw UnknownHostException("${address.dns} returned no addresses for $socketHost")
+        eventListener.dnsEnd(call, socketHost, result)
+        result
       }
 
-      eventListener.dnsEnd(call, socketHost, addresses)
-
       // Try each address for best behavior in mixed IPv4/IPv6 environments.
       val orderedAddresses = when {
         fastFallback -> reorderForHappyEyeballs(addresses)
diff --git a/okhttp/src/jvmTest/java/okhttp3/EventListenerTest.java b/okhttp/src/jvmTest/java/okhttp3/EventListenerTest.java
index 449f250bd..c52e76214 100644
--- a/okhttp/src/jvmTest/java/okhttp3/EventListenerTest.java
+++ b/okhttp/src/jvmTest/java/okhttp3/EventListenerTest.java
@@ -139,6 +139,27 @@ public final class EventListenerTest {
         "ResponseBodyEnd", "ConnectionReleased", "CallEnd");
   }
 
+  @Test public void successfulCallEventSequenceForIpAddress() throws IOException {
+    server.enqueue(new MockResponse()
+      .setBody("abc"));
+
+    String ipAddress = InetAddress.getLoopbackAddress().getHostAddress();
+
+    Call call = client.newCall(new Request.Builder()
+      .url(server.url("/").newBuilder().host(ipAddress).build())
+      .build());
+    Response response = call.execute();
+    assertThat(response.code()).isEqualTo(200);
+    assertThat(response.body().string()).isEqualTo("abc");
+    response.body().close();
+
+    assertThat(listener.recordedEventTypes()).containsExactly("CallStart",
+      "ProxySelectStart", "ProxySelectEnd",
+      "ConnectStart", "ConnectEnd", "ConnectionAcquired", "RequestHeadersStart",
+      "RequestHeadersEnd", "ResponseHeadersStart", "ResponseHeadersEnd", "ResponseBodyStart",
+      "ResponseBodyEnd", "ConnectionReleased", "CallEnd");
+  }
+
   @Test public void successfulCallEventSequenceForEnqueue() throws Exception {
     server.enqueue(new MockResponse()
         .setBody("abc"));
diff --git a/okhttp/src/jvmTest/java/okhttp3/FakeRoutePlanner.kt b/okhttp/src/jvmTest/java/okhttp3/FakeRoutePlanner.kt
index bd3d18ef8..acc5bb341 100644
--- a/okhttp/src/jvmTest/java/okhttp3/FakeRoutePlanner.kt
+++ b/okhttp/src/jvmTest/java/okhttp3/FakeRoutePlanner.kt
@@ -56,10 +56,6 @@ class FakeRoutePlanner(
     }
     val result = plans[nextPlanIndex++]
     events += "take plan ${result.id}"
-
-    val planningThrowable = result.planningThrowable
-    if (planningThrowable != null) throw planningThrowable
-
     return result
   }
 
@@ -85,46 +81,17 @@ class FakeRoutePlanner(
   inner class FakePlan(
     val id: Int
   ) : RoutePlanner.Plan {
-    var planningThrowable: Throwable? = null
     var canceled = false
     var connectState = ConnectState.READY
     val connection = factory.newConnection(pool, factory.newRoute(address))
-    var retry: FakePlan? = null
-    var retryTaken = false
 
-    override val isReady: Boolean
+    override val isConnected: Boolean
       get() = connectState == ConnectState.TLS_CONNECTED
 
     var tcpConnectDelayNanos = 0L
     var tcpConnectThrowable: Throwable? = null
-    var connectTcpNextPlan: FakePlan? = null
     var tlsConnectDelayNanos = 0L
     var tlsConnectThrowable: Throwable? = null
-    var connectTlsNextPlan: FakePlan? = null
-
-    fun createRetry(): FakePlan {
-      check(retry == null)
-      return FakePlan(nextPlanId++)
-        .also {
-          retry = it
-        }
-    }
-
-    fun createConnectTcpNextPlan(): FakePlan {
-      check(connectTcpNextPlan == null)
-      return FakePlan(nextPlanId++)
-        .also {
-          connectTcpNextPlan = it
-        }
-    }
-
-    fun createConnectTlsNextPlan(): FakePlan {
-      check(connectTlsNextPlan == null)
-      return FakePlan(nextPlanId++)
-        .also {
-          connectTlsNextPlan = it
-        }
-    }
 
     override fun connectTcp(): ConnectResult {
       check(connectState == ConnectState.READY)
@@ -135,15 +102,11 @@ class FakeRoutePlanner(
       return when {
         tcpConnectThrowable != null -> {
           events += "plan $id TCP connect failed"
-          ConnectResult(this, nextPlan = connectTcpNextPlan, throwable = tcpConnectThrowable)
+          ConnectResult(this, throwable = tcpConnectThrowable)
         }
         canceled -> {
           events += "plan $id TCP connect canceled"
-          ConnectResult(this, nextPlan = connectTcpNextPlan, throwable = IOException("canceled"))
-        }
-        connectTcpNextPlan != null -> {
-          events += "plan $id needs follow-up"
-          ConnectResult(this, nextPlan = connectTcpNextPlan)
+          ConnectResult(this, throwable = IOException("canceled"))
         }
         else -> {
           events += "plan $id TCP connected"
@@ -162,15 +125,11 @@ class FakeRoutePlanner(
       return when {
         tlsConnectThrowable != null -> {
           events += "plan $id TLS connect failed"
-          ConnectResult(this, nextPlan = connectTlsNextPlan, throwable = tlsConnectThrowable)
+          ConnectResult(this, throwable = tlsConnectThrowable)
         }
         canceled -> {
           events += "plan $id TLS connect canceled"
-          ConnectResult(this, nextPlan = connectTlsNextPlan, throwable = IOException("canceled"))
-        }
-        connectTlsNextPlan != null -> {
-          events += "plan $id needs follow-up"
-          ConnectResult(this, nextPlan = connectTlsNextPlan)
+          ConnectResult(this, throwable = IOException("canceled"))
         }
         else -> {
           events += "plan $id TLS connected"
@@ -186,12 +145,6 @@ class FakeRoutePlanner(
       events += "plan $id cancel"
       canceled = true
     }
-
-    override fun retry(): FakePlan? {
-      check(!retryTaken)
-      retryTaken = true
-      return retry
-    }
   }
 
   enum class ConnectState {
diff --git a/okhttp/src/jvmTest/java/okhttp3/internal/connection/FastFallbackExchangeFinderTest.kt b/okhttp/src/jvmTest/java/okhttp3/internal/connection/FastFallbackExchangeFinderTest.kt
index 6c4956ad6..4c7d512d2 100644
--- a/okhttp/src/jvmTest/java/okhttp3/internal/connection/FastFallbackExchangeFinderTest.kt
+++ b/okhttp/src/jvmTest/java/okhttp3/internal/connection/FastFallbackExchangeFinderTest.kt
@@ -16,7 +16,6 @@
 package okhttp3.internal.connection
 
 import java.io.IOException
-import java.net.UnknownServiceException
 import okhttp3.FakeRoutePlanner
 import okhttp3.FakeRoutePlanner.ConnectState.TLS_CONNECTED
 import okhttp3.internal.concurrent.TaskFaker
@@ -109,9 +108,9 @@ internal class FastFallbackExchangeFinderTest {
 
     taskFaker.advanceUntil(260.ms)
     assertThat(takeEvent()).isEqualTo("plan 0 TCP connected")
-    assertThat(takeEvent()).isEqualTo("plan 1 cancel")
     assertThat(takeEvent()).isEqualTo("plan 0 TLS connecting...")
     assertThat(takeEvent()).isEqualTo("plan 0 TLS connected")
+    assertThat(takeEvent()).isEqualTo("plan 1 cancel")
     assertThat(takeEvent()).isNull()
 
     taskFaker.advanceUntil(270.ms)
@@ -170,9 +169,9 @@ internal class FastFallbackExchangeFinderTest {
 
     taskFaker.advanceUntil(260.ms)
     assertThat(takeEvent()).isEqualTo("plan 1 TCP connected")
-    assertThat(takeEvent()).isEqualTo("plan 0 cancel")
     assertThat(takeEvent()).isEqualTo("plan 1 TLS connecting...")
     assertThat(takeEvent()).isEqualTo("plan 1 TLS connected")
+    assertThat(routePlanner.events.poll()).isEqualTo("plan 0 cancel")
     assertThat(takeEvent()).isNull()
 
     taskFaker.advanceUntil(270.ms)
@@ -338,273 +337,6 @@ internal class FastFallbackExchangeFinderTest {
     assertThat(takeEvent()).isNull()
   }
 
-  @Test
-  fun routePlannerPlanThrowsOnOnlyPlan() {
-    val plan0 = routePlanner.addPlan()
-    plan0.planningThrowable = UnknownServiceException("boom!")
-
-    taskRunner.newQueue().execute("connect") {
-      try {
-        finder.find()
-        fail()
-      } catch (e: UnknownServiceException) {
-        assertThat(e).hasMessage("boom!")
-      }
-    }
-
-    taskFaker.runTasks()
-    taskFaker.assertNoMoreTasks()
-    assertThat(takeEvent()).isEqualTo("take plan 0")
-    assertThat(takeEvent()).isEqualTo("tracking failure: ${UnknownServiceException("boom!")}")
-    assertThat(takeEvent()).isNull()
-  }
-
-  @Test
-  fun recoversAfterFirstPlanCallThrows() {
-    val plan0 = routePlanner.addPlan()
-    plan0.planningThrowable = UnknownServiceException("boom!")
-    val plan1 = routePlanner.addPlan()
-
-    taskRunner.newQueue().execute("connect") {
-      val result0 = finder.find()
-      assertThat(result0).isEqualTo(plan1.connection)
-    }
-
-    taskFaker.runTasks()
-    taskFaker.assertNoMoreTasks()
-    assertThat(takeEvent()).isEqualTo("take plan 0")
-    assertThat(takeEvent()).isEqualTo("tracking failure: ${UnknownServiceException("boom!")}")
-    assertThat(takeEvent()).isEqualTo("take plan 1")
-    assertThat(takeEvent()).isEqualTo("plan 1 TCP connecting...")
-    assertThat(takeEvent()).isEqualTo("plan 1 TCP connected")
-    assertThat(takeEvent()).isEqualTo("plan 1 TLS connecting...")
-    assertThat(takeEvent()).isEqualTo("plan 1 TLS connected")
-    assertThat(takeEvent()).isNull()
-  }
-
-  @Test
-  fun retryConnectionThatLostTcpRaceAfterWinnersTlsFails() {
-    val plan0 = routePlanner.addPlan()
-    plan0.tcpConnectDelayNanos = 270.ms
-
-    val plan1 = routePlanner.addPlan()
-    plan1.tcpConnectDelayNanos = 10.ms // TCP connect at time = 260 ms.
-    plan1.tlsConnectThrowable = IOException("boom!")
-
-    val plan2 = plan0.createRetry()
-
-    taskRunner.newQueue().execute("connect") {
-      val result0 = finder.find()
-      assertThat(result0).isEqualTo(plan2.connection)
-    }
-
-    taskFaker.runTasks()
-    assertThat(takeEvent()).isEqualTo("take plan 0")
-    assertThat(takeEvent()).isEqualTo("plan 0 TCP connecting...")
-    assertThat(takeEvent()).isNull()
-
-    taskFaker.advanceUntil(250.ms)
-    taskFaker.runTasks()
-    assertThat(takeEvent()).isEqualTo("take plan 1")
-    assertThat(takeEvent()).isEqualTo("plan 1 TCP connecting...")
-    assertThat(takeEvent()).isNull()
-
-    taskFaker.advanceUntil(260.ms)
-    taskFaker.runTasks()
-    assertThat(takeEvent()).isEqualTo("plan 1 TCP connected")
-    assertThat(takeEvent()).isEqualTo("plan 0 cancel")
-    assertThat(takeEvent()).isEqualTo("plan 1 TLS connecting...")
-    assertThat(takeEvent()).isEqualTo("plan 1 TLS connect failed")
-    assertThat(takeEvent()).isEqualTo("tracking failure: java.io.IOException: boom!")
-    assertThat(takeEvent()).isEqualTo("plan 2 TCP connecting...")
-    assertThat(takeEvent()).isEqualTo("plan 2 TCP connected")
-    assertThat(takeEvent()).isEqualTo("plan 2 TLS connecting...")
-    assertThat(takeEvent()).isEqualTo("plan 2 TLS connected")
-    assertThat(takeEvent()).isNull()
-
-    taskFaker.advanceUntil(270.ms)
-    taskFaker.runTasks()
-    assertThat(takeEvent()).isEqualTo("plan 0 TCP connect canceled")
-    assertThat(takeEvent()).isNull()
-  }
-
-  @Test
-  fun losingPlanDoesNotConnectTls() {
-    val plan0 = routePlanner.addPlan()
-    plan0.tcpConnectDelayNanos = 270.ms
-    val plan1 = routePlanner.addPlan()
-    plan1.tcpConnectDelayNanos = 10.ms // Connect at time = 260 ms.
-    plan1.tlsConnectDelayNanos = 20.ms // Connect at time = 280 ms.
-
-    taskRunner.newQueue().execute("connect") {
-      val result0 = finder.find()
-      assertThat(result0).isEqualTo(plan0.connection)
-    }
-
-    taskFaker.runTasks()
-    assertThat(takeEvent()).isEqualTo("take plan 0")
-    assertThat(takeEvent()).isEqualTo("plan 0 TCP connecting...")
-    assertThat(takeEvent()).isNull()
-
-    taskFaker.advanceUntil(250.ms)
-    assertThat(takeEvent()).isEqualTo("take plan 1")
-    assertThat(takeEvent()).isEqualTo("plan 1 TCP connecting...")
-    assertThat(takeEvent()).isNull()
-
-    taskFaker.advanceUntil(260.ms)
-    assertThat(takeEvent()).isEqualTo("plan 1 TCP connected")
-    assertThat(takeEvent()).isEqualTo("plan 0 cancel")
-    assertThat(takeEvent()).isEqualTo("plan 1 TLS connecting...")
-    assertThat(takeEvent()).isNull()
-
-    taskFaker.advanceUntil(270.ms)
-    assertThat(takeEvent()).isEqualTo("plan 0 TCP connect canceled")
-    assertThat(takeEvent()).isNull()
-
-    taskFaker.advanceUntil(280.ms)
-    assertThat(takeEvent()).isEqualTo("plan 1 TLS connected")
-    assertThat(takeEvent()).isNull()
-
-    assertThat(routePlanner.events.poll()).isNull()
-  }
-
-  @Test
-  fun tcpConnectFollowUpPlanUsed() {
-    val plan0 = routePlanner.addPlan()
-    val plan1 = plan0.createConnectTcpNextPlan()
-
-    taskRunner.newQueue().execute("connect") {
-      val result0 = finder.find()
-      assertThat(result0).isEqualTo(plan1.connection)
-    }
-
-    taskFaker.runTasks()
-    assertThat(takeEvent()).isEqualTo("take plan 0")
-    assertThat(takeEvent()).isEqualTo("plan 0 TCP connecting...")
-    assertThat(takeEvent()).isEqualTo("plan 0 needs follow-up")
-    assertThat(takeEvent()).isEqualTo("plan 1 TCP connecting...")
-    assertThat(takeEvent()).isEqualTo("plan 1 TCP connected")
-    assertThat(takeEvent()).isEqualTo("plan 1 TLS connecting...")
-    assertThat(takeEvent()).isEqualTo("plan 1 TLS connected")
-    assertThat(takeEvent()).isNull()
-  }
-
-  @Test
-  fun tlsConnectFollowUpPlanUsed() {
-    val plan0 = routePlanner.addPlan()
-    val plan1 = plan0.createConnectTlsNextPlan()
-
-    taskRunner.newQueue().execute("connect") {
-      val result0 = finder.find()
-      assertThat(result0).isEqualTo(plan1.connection)
-    }
-
-    taskFaker.runTasks()
-    assertThat(takeEvent()).isEqualTo("take plan 0")
-    assertThat(takeEvent()).isEqualTo("plan 0 TCP connecting...")
-    assertThat(takeEvent()).isEqualTo("plan 0 TCP connected")
-    assertThat(takeEvent()).isEqualTo("plan 0 TLS connecting...")
-    assertThat(takeEvent()).isEqualTo("plan 0 needs follow-up")
-    assertThat(takeEvent()).isEqualTo("plan 1 TCP connecting...")
-    assertThat(takeEvent()).isEqualTo("plan 1 TCP connected")
-    assertThat(takeEvent()).isEqualTo("plan 1 TLS connecting...")
-    assertThat(takeEvent()).isEqualTo("plan 1 TLS connected")
-    assertThat(takeEvent()).isNull()
-  }
-
-  /**
-   * This test performs two races:
-   *
-   *  * The first race is between plan0 and plan1, with a 250 ms head start for plan0.
-   *  * The second race is between plan2 and plan3, with a 250 ms head start for plan2.
-   *
-   * We get plan0 and plan1 from the route planner.
-   * We get plan2 as a follow-up to plan1, typically retry the same IP but different TLS.
-   * We get plan3 as a retry of plan0, which was canceled when it lost the race.
-   *
-   * This test confirms that we prefer to do the TLS follow-up (plan2) before the TCP retry (plan3).
-   * It also confirms we enforce the 250 ms delay in each race.
-   */
-  @Test
-  fun tcpConnectionsRaceAfterTlsFails() {
-    val plan0 = routePlanner.addPlan()
-    plan0.tcpConnectDelayNanos = 280.ms
-
-    val plan1 = routePlanner.addPlan()
-    plan1.tcpConnectDelayNanos = 10.ms // Connect at time = 260 ms.
-    plan1.tlsConnectDelayNanos = 10.ms // Connect at time = 270 ms.
-    plan1.tlsConnectThrowable = IOException("boom!")
-
-    val plan2 = plan1.createConnectTlsNextPlan()
-    plan2.tcpConnectDelayNanos = 270.ms // Connect at time = 540 ms.
-
-    val plan3 = plan0.createRetry()
-    plan3.tcpConnectDelayNanos = 10.ms // Connect at time = 530 ms.
-
-    taskRunner.newQueue().execute("connect") {
-      val result0 = finder.find()
-      assertThat(result0).isEqualTo(plan3.connection)
-    }
-
-    taskFaker.runTasks()
-    assertThat(takeEvent()).isEqualTo("take plan 0")
-    assertThat(takeEvent()).isEqualTo("plan 0 TCP connecting...")
-    assertThat(takeEvent()).isNull()
-
-    taskFaker.advanceUntil(250.ms)
-    taskFaker.runTasks()
-    assertThat(takeEvent()).isEqualTo("take plan 1")
-    assertThat(takeEvent()).isEqualTo("plan 1 TCP connecting...")
-    assertThat(takeEvent()).isNull()
-
-    taskFaker.advanceUntil(260.ms)
-    taskFaker.runTasks()
-    assertThat(takeEvent()).isEqualTo("plan 1 TCP connected")
-    assertThat(takeEvent()).isEqualTo("plan 0 cancel")
-    assertThat(takeEvent()).isEqualTo("plan 1 TLS connecting...")
-    assertThat(takeEvent()).isNull()
-
-    taskFaker.advanceUntil(270.ms)
-    taskFaker.runTasks()
-    assertThat(takeEvent()).isEqualTo("plan 1 TLS connect failed")
-    assertThat(takeEvent()).isEqualTo("tracking failure: ${IOException("boom!")}")
-    assertThat(takeEvent()).isEqualTo("plan 2 TCP connecting...")
-    assertThat(takeEvent()).isNull()
-
-    taskFaker.advanceUntil(280.ms)
-    taskFaker.runTasks()
-    assertThat(takeEvent()).isEqualTo("plan 0 TCP connect canceled")
-    assertThat(takeEvent()).isNull()
-
-    taskFaker.advanceUntil(520.ms)
-    taskFaker.runTasks()
-    assertThat(takeEvent()).isEqualTo("plan 3 TCP connecting...")
-    assertThat(takeEvent()).isNull()
-
-    taskFaker.advanceUntil(530.ms)
-    taskFaker.runTasks()
-    assertThat(takeEvent()).isEqualTo("plan 3 TCP connected")
-    assertThat(takeEvent()).isEqualTo("plan 2 cancel")
-    assertThat(takeEvent()).isEqualTo("plan 3 TLS connecting...")
-    assertThat(takeEvent()).isEqualTo("plan 3 TLS connected")
-    assertThat(takeEvent()).isNull()
-
-    taskFaker.advanceUntil(540.ms)
-    taskFaker.runTasks()
-    assertThat(takeEvent()).isEqualTo("plan 2 TCP connect canceled")
-    assertThat(takeEvent()).isNull()
-  }
-
-  @Test
-  fun cancelEarlyDuringTcpConnectDoesntLeak() {
-    // TODO(jwilson): change ConnectPlan.cancel() to work even if rawSocket hasn't been created yet.
-  }
-
-  @Test
-  fun routeFailureStatisticsAreTrackedPerRoute() {
-    // TODO(jwilson): we call resetStatistics() in the wrong phrase for racy connects.
-  }
-
   private fun takeEvent() = routePlanner.events.poll()
 
   private val Int.ms: Long
diff --git a/regression-test/build.gradle.kts b/regression-test/build.gradle.kts
index 74253ba4b..7ccc3f9f5 100644
--- a/regression-test/build.gradle.kts
+++ b/regression-test/build.gradle.kts
@@ -36,18 +36,18 @@ android {
 dependencies {
   val okhttpLegacyVersion = "3.12.12"
 
-  implementation(Dependencies.kotlinReflect)
-  implementation(Dependencies.playServicesSafetynet)
+  implementation(libs.kotlin.reflect)
+  implementation(libs.playservices.safetynet)
   implementation("com.squareup.okhttp3:okhttp:${okhttpLegacyVersion}")
   implementation("com.squareup.okhttp3:okhttp-tls:${okhttpLegacyVersion}") {
     exclude("org.bouncycastle")
   }
   androidTestImplementation("com.squareup.okhttp3:mockwebserver:${okhttpLegacyVersion}")
-  androidTestImplementation(Dependencies.bouncycastle)
-  androidTestImplementation(Dependencies.bouncycastletls)
-  androidTestImplementation(Dependencies.androidxExtJunit)
-  androidTestImplementation(Dependencies.androidxEspressoCore)
-  androidTestImplementation(Dependencies.httpclient5)
-  androidTestImplementation(Dependencies.moshi)
-  androidTestImplementation(Dependencies.moshiKotlin)
+  androidTestImplementation(libs.bouncycastle.bcprov)
+  androidTestImplementation(libs.bouncycastle.bctls)
+  androidTestImplementation(libs.androidx.junit)
+  androidTestImplementation(libs.androidx.espresso.core)
+  androidTestImplementation(libs.httpClient5)
+  androidTestImplementation(libs.squareup.moshi)
+  androidTestImplementation(libs.squareup.moshi.kotlin)
 }
diff --git a/samples/compare/build.gradle.kts b/samples/compare/build.gradle.kts
index e24d9bfdd..5de275e79 100644
--- a/samples/compare/build.gradle.kts
+++ b/samples/compare/build.gradle.kts
@@ -8,10 +8,10 @@ dependencies {
   testRuntimeOnly(projects.mockwebserver3Junit5)
   testImplementation(projects.okhttpTls)
   testImplementation(projects.okhttpTestingSupport)
-  testImplementation(Dependencies.httpclient5)
-  testImplementation(Dependencies.jettyClient)
-  testImplementation(Dependencies.junit)
-  testImplementation(Dependencies.assertj)
+  testImplementation(libs.httpClient5)
+  testImplementation(libs.jettyClient)
+  testImplementation(libs.junit)
+  testImplementation(libs.assertj.core)
 }
 
 tasks.compileJava {
diff --git a/samples/compare/src/test/kotlin/okhttp3/compare/ApacheHttpClientTest.kt b/samples/compare/src/test/kotlin/okhttp3/compare/ApacheHttpClientTest.kt
index f2aa69d56..266838524 100644
--- a/samples/compare/src/test/kotlin/okhttp3/compare/ApacheHttpClientTest.kt
+++ b/samples/compare/src/test/kotlin/okhttp3/compare/ApacheHttpClientTest.kt
@@ -54,6 +54,6 @@ class ApacheHttpClientTest {
     assertThat(recorded.getHeader("Accept")).isEqualTo("text/plain")
     assertThat(recorded.getHeader("Accept-Encoding")).isEqualTo("gzip, x-gzip, deflate")
     assertThat(recorded.getHeader("Connection")).isEqualTo("keep-alive")
-    assertThat(recorded.getHeader("User-Agent")).startsWith("Apache-HttpClient/5.0")
+    assertThat(recorded.getHeader("User-Agent")).startsWith("Apache-HttpClient/")
   }
 }
diff --git a/samples/crawler/build.gradle.kts b/samples/crawler/build.gradle.kts
index d89643717..6ea013bef 100644
--- a/samples/crawler/build.gradle.kts
+++ b/samples/crawler/build.gradle.kts
@@ -9,7 +9,7 @@ application {
 
 dependencies {
   implementation(projects.okhttp)
-  implementation(Dependencies.jsoup)
+  implementation(libs.jsoup)
 }
 
 tasks.compileJava {
diff --git a/samples/guide/build.gradle.kts b/samples/guide/build.gradle.kts
index adc37977f..4e8fcea8f 100644
--- a/samples/guide/build.gradle.kts
+++ b/samples/guide/build.gradle.kts
@@ -8,14 +8,14 @@ dependencies {
   implementation(projects.mockwebserver)
   implementation(projects.okhttpTestingSupport)
   implementation(projects.okhttpTls)
-  implementation(Dependencies.animalSniffer)
-  implementation(Dependencies.moshi)
-  kapt(Dependencies.moshiCompiler)
+  implementation(libs.animalsniffer.annotations)
+  implementation(libs.squareup.moshi)
+  kapt(libs.squareup.moshi.compiler)
 }
 
 java {
   toolchain {
-    languageVersion.set(JavaLanguageVersion.of(14))
+    languageVersion.set(JavaLanguageVersion.of(17))
   }
 }
 
diff --git a/samples/simple-client/build.gradle.kts b/samples/simple-client/build.gradle.kts
index 17f0b2bc3..f51460c7d 100644
--- a/samples/simple-client/build.gradle.kts
+++ b/samples/simple-client/build.gradle.kts
@@ -4,5 +4,5 @@ plugins {
 
 dependencies {
   implementation(projects.okhttp)
-  implementation(Dependencies.moshi)
+  implementation(libs.squareup.moshi)
 }
diff --git a/samples/slack/build.gradle.kts b/samples/slack/build.gradle.kts
index c6b36fe0e..dacdc08fc 100644
--- a/samples/slack/build.gradle.kts
+++ b/samples/slack/build.gradle.kts
@@ -4,5 +4,5 @@ plugins {
 
 dependencies {
   implementation(projects.mockwebserver)
-  implementation(Dependencies.moshi)
+  implementation(libs.squareup.moshi)
 }
diff --git a/samples/unixdomainsockets/build.gradle.kts b/samples/unixdomainsockets/build.gradle.kts
index ec84786fa..422ec83cd 100644
--- a/samples/unixdomainsockets/build.gradle.kts
+++ b/samples/unixdomainsockets/build.gradle.kts
@@ -5,5 +5,5 @@ plugins {
 dependencies {
   implementation(projects.okhttp)
   implementation(projects.mockwebserver)
-  implementation(Dependencies.jnrUnixsocket)
+  implementation(libs.jnr.unixsocket)
 }

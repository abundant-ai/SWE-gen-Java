diff --git a/mockwebserver-deprecated/src/main/kotlin/okhttp3/mockwebserver/MockWebServer.kt b/mockwebserver-deprecated/src/main/kotlin/okhttp3/mockwebserver/MockWebServer.kt
index a853aaae3..1dc782334 100644
--- a/mockwebserver-deprecated/src/main/kotlin/okhttp3/mockwebserver/MockWebServer.kt
+++ b/mockwebserver-deprecated/src/main/kotlin/okhttp3/mockwebserver/MockWebServer.kt
@@ -145,7 +145,7 @@ class MockWebServer : ExternalResource(), Closeable {
   fun protocols(): List<Protocol> = delegate.protocols
 
   fun useHttps(sslSocketFactory: SSLSocketFactory, tunnelProxy: Boolean) {
-    delegate.useHttps(sslSocketFactory)
+    delegate.useHttps(sslSocketFactory, tunnelProxy)
   }
 
   fun noClientAuth() {
diff --git a/mockwebserver/api/mockwebserver3.api b/mockwebserver/api/mockwebserver3.api
index 6c0b263ac..7a9a4b75c 100644
--- a/mockwebserver/api/mockwebserver3.api
+++ b/mockwebserver/api/mockwebserver3.api
@@ -111,7 +111,7 @@ public final class mockwebserver3/MockWebServer : java/io/Closeable {
 	public final fun toProxyAddress ()Ljava/net/Proxy;
 	public fun toString ()Ljava/lang/String;
 	public final fun url (Ljava/lang/String;)Lokhttp3/HttpUrl;
-	public final fun useHttps (Ljavax/net/ssl/SSLSocketFactory;)V
+	public final fun useHttps (Ljavax/net/ssl/SSLSocketFactory;Z)V
 }
 
 public final class mockwebserver3/MockWebServer$Companion {
diff --git a/mockwebserver/src/main/kotlin/mockwebserver3/MockWebServer.kt b/mockwebserver/src/main/kotlin/mockwebserver3/MockWebServer.kt
index 937c4c0f0..a485b85a4 100644
--- a/mockwebserver/src/main/kotlin/mockwebserver3/MockWebServer.kt
+++ b/mockwebserver/src/main/kotlin/mockwebserver3/MockWebServer.kt
@@ -277,8 +277,10 @@ class MockWebServer : Closeable {
 
   /**
    * Serve requests with HTTPS rather than otherwise.
+   *
+   * @param tunnelProxy true to expect the HTTP CONNECT method before negotiating TLS.
    */
-  fun useHttps(sslSocketFactory: SSLSocketFactory) {
+  fun useHttps(sslSocketFactory: SSLSocketFactory, tunnelProxy: Boolean) {
     this.sslSocketFactory = sslSocketFactory
   }
 
diff --git a/mockwebserver/src/test/java/mockwebserver3/MockWebServerTest.java b/mockwebserver/src/test/java/mockwebserver3/MockWebServerTest.java
index 82243a6b1..27ddce17d 100644
--- a/mockwebserver/src/test/java/mockwebserver3/MockWebServerTest.java
+++ b/mockwebserver/src/test/java/mockwebserver3/MockWebServerTest.java
@@ -552,7 +552,7 @@ public final class MockWebServerTest {
 
   @Test public void https() throws Exception {
     HandshakeCertificates handshakeCertificates = localhost();
-    server.useHttps(handshakeCertificates.sslSocketFactory());
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false);
     server.enqueue(new MockResponse().setBody("abc"));
 
     HttpUrl url = server.url("/");
@@ -594,7 +594,7 @@ public final class MockWebServerTest {
         .heldCertificate(serverCertificate)
         .build();
 
-    server.useHttps(serverHandshakeCertificates.sslSocketFactory());
+    server.useHttps(serverHandshakeCertificates.sslSocketFactory(), false);
     server.enqueue(new MockResponse().setBody("abc"));
     server.requestClientAuth();
 
diff --git a/okhttp-android/src/androidTest/kotlin/okhttp3/android/AndroidAsyncDnsTest.kt b/okhttp-android/src/androidTest/kotlin/okhttp3/android/AndroidAsyncDnsTest.kt
index 2ff25e6f5..d9a76270b 100644
--- a/okhttp-android/src/androidTest/kotlin/okhttp3/android/AndroidAsyncDnsTest.kt
+++ b/okhttp-android/src/androidTest/kotlin/okhttp3/android/AndroidAsyncDnsTest.kt
@@ -67,7 +67,7 @@ class AndroidAsyncDnsTest(val server: MockWebServer) {
 
   @BeforeEach
   fun init() {
-    server.useHttps(localhost.sslSocketFactory())
+    server.useHttps(localhost.sslSocketFactory(), false)
   }
 
   @Test
diff --git a/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.java b/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.java
index deb7bc4af..758358673 100644
--- a/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.java
+++ b/okhttp-logging-interceptor/src/test/java/okhttp3/logging/HttpLoggingInterceptorTest.java
@@ -796,7 +796,7 @@ public final class HttpLoggingInterceptorTest {
   @Test public void http2() throws Exception {
     platform.assumeNotBouncyCastle();
 
-    server.useHttps(handshakeCertificates.sslSocketFactory());
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false);
     url = server.url("/");
 
     setLevel(Level.BASIC);
@@ -877,7 +877,7 @@ public final class HttpLoggingInterceptorTest {
     platform.assumeHttp2Support();
     platform.assumeNotBouncyCastle();
 
-    server.useHttps(handshakeCertificates.sslSocketFactory()); // HTTP/2
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false); // HTTP/2
     url = server.url("/");
 
     setLevel(Level.BODY);
diff --git a/okhttp-logging-interceptor/src/test/java/okhttp3/logging/LoggingEventListenerTest.java b/okhttp-logging-interceptor/src/test/java/okhttp3/logging/LoggingEventListenerTest.java
index b14ee3114..85a1de599 100644
--- a/okhttp-logging-interceptor/src/test/java/okhttp3/logging/LoggingEventListenerTest.java
+++ b/okhttp-logging-interceptor/src/test/java/okhttp3/logging/LoggingEventListenerTest.java
@@ -152,7 +152,7 @@ public final class LoggingEventListenerTest {
     TestUtil.assumeNotWindows();
     platform.assumeNotBouncyCastle();
 
-    server.useHttps(handshakeCertificates.sslSocketFactory());
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false);
     url = server.url("/");
 
     server.enqueue(new MockResponse());
@@ -221,7 +221,7 @@ public final class LoggingEventListenerTest {
     TestUtil.assumeNotWindows();
     platform.assumeNotBouncyCastle();
 
-    server.useHttps(handshakeCertificates.sslSocketFactory());
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false);
     server.setProtocols(asList(HTTP_2, HTTP_1_1));
     server.enqueue(new MockResponse().setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE));
     url = server.url("/");
diff --git a/okhttp/src/jvmTest/java/okhttp3/CacheCorruptionTest.kt b/okhttp/src/jvmTest/java/okhttp3/CacheCorruptionTest.kt
index 95438e08c..bbee27ff0 100644
--- a/okhttp/src/jvmTest/java/okhttp3/CacheCorruptionTest.kt
+++ b/okhttp/src/jvmTest/java/okhttp3/CacheCorruptionTest.kt
@@ -142,7 +142,7 @@ class CacheCorruptionTest(
   }
 
   private fun testCorruptingCache(corruptor: () -> Unit): Response {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(
       MockResponse()
         .addHeader("Last-Modified: " + formatDate(-1, TimeUnit.HOURS))
diff --git a/okhttp/src/jvmTest/java/okhttp3/CacheTest.java b/okhttp/src/jvmTest/java/okhttp3/CacheTest.java
index f910c72ac..b401e344e 100644
--- a/okhttp/src/jvmTest/java/okhttp3/CacheTest.java
+++ b/okhttp/src/jvmTest/java/okhttp3/CacheTest.java
@@ -264,7 +264,7 @@ public final class CacheTest {
   }
 
   @Test public void secureResponseCaching() throws IOException {
-    server.useHttps(handshakeCertificates.sslSocketFactory());
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false);
     server.enqueue(new MockResponse()
         .addHeader("Last-Modified: " + formatDate(-1, TimeUnit.HOURS))
         .addHeader("Expires: " + formatDate(1, TimeUnit.HOURS))
@@ -362,7 +362,7 @@ public final class CacheTest {
   }
 
   @Test public void secureResponseCachingAndRedirects() throws IOException {
-    server.useHttps(handshakeCertificates.sslSocketFactory());
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false);
     server.enqueue(new MockResponse()
         .addHeader("Last-Modified: " + formatDate(-1, TimeUnit.HOURS))
         .addHeader("Expires: " + formatDate(1, TimeUnit.HOURS))
@@ -405,7 +405,7 @@ public final class CacheTest {
    * https://github.com/square/okhttp/issues/214
    */
   @Test public void secureResponseCachingAndProtocolRedirects() throws IOException {
-    server2.useHttps(handshakeCertificates.sslSocketFactory());
+    server2.useHttps(handshakeCertificates.sslSocketFactory(), false);
     server2.enqueue(new MockResponse()
         .addHeader("Last-Modified: " + formatDate(-1, TimeUnit.HOURS))
         .addHeader("Expires: " + formatDate(1, TimeUnit.HOURS))
@@ -1780,7 +1780,7 @@ public final class CacheTest {
   }
 
   @Test public void varyAndHttps() throws Exception {
-    server.useHttps(handshakeCertificates.sslSocketFactory());
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false);
     server.enqueue(new MockResponse()
         .addHeader("Cache-Control: max-age=60")
         .addHeader("Vary: Accept-Language")
diff --git a/okhttp/src/jvmTest/java/okhttp3/CallHandshakeTest.kt b/okhttp/src/jvmTest/java/okhttp3/CallHandshakeTest.kt
index ba34c56aa..5d45bd7c1 100644
--- a/okhttp/src/jvmTest/java/okhttp3/CallHandshakeTest.kt
+++ b/okhttp/src/jvmTest/java/okhttp3/CallHandshakeTest.kt
@@ -69,7 +69,7 @@ class CallHandshakeTest {
         handshakeCertificates.sslSocketFactory(), handshakeCertificates.trustManager)
       .hostnameVerifier(RecordingHostnameVerifier())
       .build()
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
 
     defaultEnabledCipherSuites =
       handshakeCertificates.sslSocketFactory().defaultCipherSuites.toList()
diff --git a/okhttp/src/jvmTest/java/okhttp3/CallKotlinTest.kt b/okhttp/src/jvmTest/java/okhttp3/CallKotlinTest.kt
index 8a1230888..3b43ad2ca 100644
--- a/okhttp/src/jvmTest/java/okhttp3/CallKotlinTest.kt
+++ b/okhttp/src/jvmTest/java/okhttp3/CallKotlinTest.kt
@@ -100,7 +100,7 @@ class CallKotlinTest(
         .sslSocketFactory(
             handshakeCertificates.sslSocketFactory(), handshakeCertificates.trustManager)
         .build()
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
   }
 
   @Test
diff --git a/okhttp/src/jvmTest/java/okhttp3/CallTest.kt b/okhttp/src/jvmTest/java/okhttp3/CallTest.kt
index d48863b50..571abc80b 100644
--- a/okhttp/src/jvmTest/java/okhttp3/CallTest.kt
+++ b/okhttp/src/jvmTest/java/okhttp3/CallTest.kt
@@ -1133,7 +1133,7 @@ open class CallTest(
   }
 
   @Test fun tlsHandshakeFailure_noFallbackByDefault() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(MockResponse().setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE))
     server.enqueue(MockResponse().setBody("response that will never be received"))
     val response = executeSynchronously("/")
@@ -1146,7 +1146,7 @@ open class CallTest(
   }
 
   @Test fun recoverFromTlsHandshakeFailure() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(MockResponse().setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE))
     server.enqueue(MockResponse().setBody("abc"))
     client = client.newBuilder()
@@ -1169,7 +1169,7 @@ open class CallTest(
       // This only works if the client socket supports TLS_FALLBACK_SCSV.
       return
     }
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(MockResponse().setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE))
     val clientSocketFactory = RecordingSSLSocketFactory(
       handshakeCertificates.sslSocketFactory()
@@ -1196,7 +1196,7 @@ open class CallTest(
   }
 
   @Test fun recoverFromTlsHandshakeFailure_Async() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(MockResponse().setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE))
     server.enqueue(MockResponse().setBody("abc"))
     client = client.newBuilder()
@@ -1223,7 +1223,7 @@ open class CallTest(
         handshakeCertificates.trustManager
       )
       .build()
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(MockResponse().setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE))
     val request = Request.Builder().url(server.url("/")).build()
     try {
@@ -1256,7 +1256,7 @@ open class CallTest(
     client = client.newBuilder()
       .sslSocketFactory(clientCertificates.sslSocketFactory(), clientCertificates.trustManager)
       .build()
-    server.useHttps(serverCertificates.sslSocketFactory())
+    server.useHttps(serverCertificates.sslSocketFactory(), false)
     executeSynchronously("/")
       .assertFailureMatches("(?s)Hostname localhost not verified.*")
   }
@@ -1292,7 +1292,8 @@ open class CallTest(
     val serverCertificates = HandshakeCertificates.Builder()
       .build()
     server.useHttps(
-        socketFactoryWithCipherSuite(serverCertificates.sslSocketFactory(), cipherSuite)
+      socketFactoryWithCipherSuite(serverCertificates.sslSocketFactory(), cipherSuite),
+      false
     )
     executeSynchronously("/")
       .assertFailure(SSLHandshakeException::class.java)
@@ -1319,7 +1320,7 @@ open class CallTest(
     client = client.newBuilder()
       .protocols(listOf(Protocol.H2_PRIOR_KNOWLEDGE))
       .build()
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(MockResponse())
     val call = client.newCall(Request(server.url("/")))
     try {
@@ -2907,7 +2908,7 @@ open class CallTest(
 
   /** Test which headers are sent unencrypted to the HTTP proxy.  */
   @Test fun proxyConnectOmitsApplicationHeaders() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), true)
     server.enqueue(
       MockResponse()
         .inTunnel()
@@ -2976,7 +2977,7 @@ open class CallTest(
 
   /** Respond to a proxy authorization challenge.  */
   @Test fun proxyAuthenticateOnConnect() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), true)
     server.enqueue(
       MockResponse()
         .inTunnel()
@@ -3045,7 +3046,7 @@ open class CallTest(
    * TLS tunnel. https://github.com/square/okhttp/issues/2426
    */
   @Test fun proxyAuthenticateOnConnectWithConnectionClose() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), true)
     server.protocols = listOf<Protocol>(Protocol.HTTP_1_1)
     server.enqueue(
       MockResponse()
@@ -3086,7 +3087,7 @@ open class CallTest(
   }
 
   @Test fun tooManyProxyAuthFailuresWithConnectionClose() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), true)
     server.protocols = listOf(Protocol.HTTP_1_1)
     for (i in 0..20) {
       server.enqueue(
@@ -3119,7 +3120,7 @@ open class CallTest(
    * credentials. Worse, that approach leaks proxy credentials to the origin server.
    */
   @Test fun noPreemptiveProxyAuthorization() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), true)
     server.enqueue(
       MockResponse()
         .inTunnel()
@@ -3150,7 +3151,7 @@ open class CallTest(
 
   /** Confirm that we can send authentication information without being prompted first.  */
   @Test fun preemptiveProxyAuthentication() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), true)
     server.enqueue(
       MockResponse()
         .inTunnel()
@@ -3191,7 +3192,7 @@ open class CallTest(
   }
 
   @Test fun preemptiveThenReactiveProxyAuthentication() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), true)
     server.enqueue(
       MockResponse()
         .inTunnel()
@@ -3234,7 +3235,7 @@ open class CallTest(
 
   /** https://github.com/square/okhttp/issues/4915  */
   @Test @Disabled fun proxyDisconnectsAfterRequest() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), true)
     server.enqueue(
       MockResponse()
         .inTunnel()
@@ -3589,7 +3590,7 @@ open class CallTest(
 
   /** Use a proxy to fake IPv6 connectivity, even if localhost doesn't have IPv6.  */
   private fun configureClientAndServerProxies(http2: Boolean) {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), true)
     server.protocols = when {
       http2 -> listOf(Protocol.HTTP_2, Protocol.HTTP_1_1)
       else -> listOf(Protocol.HTTP_1_1)
@@ -3731,7 +3732,7 @@ open class CallTest(
       .build()
 
     // Use that certificate on the server and trust it on the client.
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     client = client.newBuilder()
       .sslSocketFactory(
         handshakeCertificates.sslSocketFactory(), handshakeCertificates.trustManager
@@ -4002,7 +4003,7 @@ open class CallTest(
       )
       .hostnameVerifier(RecordingHostnameVerifier())
       .build()
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
   }
 
   private fun gzip(data: String): Buffer {
diff --git a/okhttp/src/jvmTest/java/okhttp3/ConnectionCoalescingTest.java b/okhttp/src/jvmTest/java/okhttp3/ConnectionCoalescingTest.java
index 4925f784d..f3131e7ae 100644
--- a/okhttp/src/jvmTest/java/okhttp3/ConnectionCoalescingTest.java
+++ b/okhttp/src/jvmTest/java/okhttp3/ConnectionCoalescingTest.java
@@ -98,7 +98,7 @@ public final class ConnectionCoalescingTest {
     HandshakeCertificates serverHandshakeCertificates = new HandshakeCertificates.Builder()
         .heldCertificate(certificate)
         .build();
-    server.useHttps(serverHandshakeCertificates.sslSocketFactory());
+    server.useHttps(serverHandshakeCertificates.sslSocketFactory(), false);
 
     url = server.url("/robots.txt");
   }
diff --git a/okhttp/src/jvmTest/java/okhttp3/ConnectionReuseTest.kt b/okhttp/src/jvmTest/java/okhttp3/ConnectionReuseTest.kt
index 59689ec87..36d68d559 100644
--- a/okhttp/src/jvmTest/java/okhttp3/ConnectionReuseTest.kt
+++ b/okhttp/src/jvmTest/java/okhttp3/ConnectionReuseTest.kt
@@ -322,7 +322,7 @@ class ConnectionReuseTest {
       .hostnameVerifier(RecordingHostnameVerifier())
       .protocols(protocols.toList())
       .build()
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.protocols = client.protocols
   }
 
diff --git a/okhttp/src/jvmTest/java/okhttp3/DuplexTest.java b/okhttp/src/jvmTest/java/okhttp3/DuplexTest.java
index 5e6b41e3c..669845cf7 100644
--- a/okhttp/src/jvmTest/java/okhttp3/DuplexTest.java
+++ b/okhttp/src/jvmTest/java/okhttp3/DuplexTest.java
@@ -710,7 +710,7 @@ public final class DuplexTest {
             handshakeCertificates.sslSocketFactory(), handshakeCertificates.trustManager())
         .hostnameVerifier(new RecordingHostnameVerifier())
         .build();
-    server.useHttps(handshakeCertificates.sslSocketFactory());
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false);
   }
 
   private class DelayedRequestBody extends RequestBody {
diff --git a/okhttp/src/jvmTest/java/okhttp3/EventListenerTest.java b/okhttp/src/jvmTest/java/okhttp3/EventListenerTest.java
index 3c7657934..cd80520ae 100644
--- a/okhttp/src/jvmTest/java/okhttp3/EventListenerTest.java
+++ b/okhttp/src/jvmTest/java/okhttp3/EventListenerTest.java
@@ -314,7 +314,7 @@ public final class EventListenerTest {
   }
 
   @Test public void secondCallEventSequence() throws IOException {
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.setProtocols(asList(Protocol.HTTP_2, Protocol.HTTP_1_1));
     server.enqueue(new MockResponse());
     server.enqueue(new MockResponse());
@@ -396,7 +396,7 @@ public final class EventListenerTest {
   }
 
   @Test public void successfulEmptyH2CallEventSequence() throws IOException {
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.setProtocols(asList(Protocol.HTTP_2, Protocol.HTTP_1_1));
     server.enqueue(new MockResponse());
 
@@ -407,7 +407,7 @@ public final class EventListenerTest {
   }
 
   @Test public void successfulEmptyHttpsCallEventSequence() throws IOException {
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.setProtocols(asList(Protocol.HTTP_1_1));
     server.enqueue(new MockResponse()
         .setBody("abc"));
@@ -419,7 +419,7 @@ public final class EventListenerTest {
   }
 
   @Test public void successfulChunkedHttpsCallEventSequence() throws IOException {
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.setProtocols(asList(Protocol.HTTP_1_1));
     server.enqueue(
         new MockResponse().setBodyDelay(100, TimeUnit.MILLISECONDS).setChunkedBody("Hello!", 2));
@@ -431,7 +431,7 @@ public final class EventListenerTest {
   }
 
   @Test public void successfulChunkedH2CallEventSequence() throws IOException {
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.setProtocols(asList(Protocol.HTTP_2, Protocol.HTTP_1_1));
     server.enqueue(
         new MockResponse().setBodyDelay(100, TimeUnit.MILLISECONDS).setChunkedBody("Hello!", 2));
@@ -582,7 +582,7 @@ public final class EventListenerTest {
   }
 
   @Test public void failedConnect() throws UnknownHostException {
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.enqueue(new MockResponse()
         .setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE));
 
@@ -611,7 +611,7 @@ public final class EventListenerTest {
   }
 
   @Test public void multipleConnectsForSingleCall() throws IOException {
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.enqueue(new MockResponse()
         .setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE));
     server.enqueue(new MockResponse());
@@ -694,7 +694,7 @@ public final class EventListenerTest {
   }
 
   @Test public void authenticatingTunnelProxyConnect() throws IOException {
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(true);
     server.enqueue(new MockResponse()
         .inTunnel()
         .setResponseCode(407)
@@ -726,7 +726,7 @@ public final class EventListenerTest {
   }
 
   @Test public void successfulSecureConnect() throws IOException {
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.enqueue(new MockResponse());
 
     Call call = client.newCall(new Request.Builder()
@@ -745,7 +745,7 @@ public final class EventListenerTest {
   }
 
   @Test public void failedSecureConnect() {
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.enqueue(new MockResponse()
         .setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE));
 
@@ -767,7 +767,7 @@ public final class EventListenerTest {
   }
 
   @Test public void secureConnectWithTunnel() throws IOException {
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(true);
     server.enqueue(new MockResponse()
         .inTunnel());
     server.enqueue(new MockResponse());
@@ -792,7 +792,7 @@ public final class EventListenerTest {
   }
 
   @Test public void multipleSecureConnectsForSingleCall() throws IOException {
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.enqueue(new MockResponse()
         .setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE));
     server.enqueue(new MockResponse());
@@ -816,7 +816,7 @@ public final class EventListenerTest {
   }
 
   @Test public void noSecureConnectsOnPooledConnection() throws IOException {
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.enqueue(new MockResponse());
     server.enqueue(new MockResponse());
 
@@ -926,7 +926,7 @@ public final class EventListenerTest {
   }
 
   @Test public void responseBodyFailHttp1OverHttps() throws IOException {
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.setProtocols(asList(Protocol.HTTP_1_1));
     responseBodyFail(Protocol.HTTP_1_1);
   }
@@ -934,7 +934,7 @@ public final class EventListenerTest {
   @Test public void responseBodyFailHttp2OverHttps() throws IOException {
     platform.assumeHttp2Support();
 
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.setProtocols(asList(Protocol.HTTP_2, Protocol.HTTP_1_1));
     responseBodyFail(Protocol.HTTP_2);
   }
@@ -1026,7 +1026,7 @@ public final class EventListenerTest {
   }
 
   @Test public void requestBodyFailHttp1OverHttps() {
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.setProtocols(asList(Protocol.HTTP_1_1));
 
     requestBodyFail(Protocol.HTTP_1_1);
@@ -1035,7 +1035,7 @@ public final class EventListenerTest {
   @Test public void requestBodyFailHttp2OverHttps() {
     platform.assumeHttp2Support();
 
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.setProtocols(asList(Protocol.HTTP_2, Protocol.HTTP_1_1));
 
     requestBodyFail(Protocol.HTTP_2);
@@ -1147,7 +1147,7 @@ public final class EventListenerTest {
   }
 
   @Test public void requestBodySuccessHttp1OverHttps() throws IOException {
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.setProtocols(asList(Protocol.HTTP_1_1));
     requestBodySuccess(RequestBody.create("Hello", MediaType.get("text/plain")), equalTo(5L),
         equalTo(19L));
@@ -1156,7 +1156,7 @@ public final class EventListenerTest {
   @Test public void requestBodySuccessHttp2OverHttps() throws IOException {
     platform.assumeHttp2Support();
 
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.setProtocols(asList(Protocol.HTTP_2, Protocol.HTTP_1_1));
     requestBodySuccess(RequestBody.create("Hello", MediaType.get("text/plain")), equalTo(5L),
         equalTo(19L));
@@ -1227,7 +1227,7 @@ public final class EventListenerTest {
   }
 
   @Test public void timeToFirstByteHttp1OverHttps() throws IOException {
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.setProtocols(asList(Protocol.HTTP_1_1));
 
     timeToFirstByte();
@@ -1235,7 +1235,7 @@ public final class EventListenerTest {
 
   @Test public void timeToFirstByteHttp2OverHttps() throws IOException {
     platform.assumeHttp2Support();
-    enableTlsWithTunnel();
+    enableTlsWithTunnel(false);
     server.setProtocols(asList(Protocol.HTTP_2, Protocol.HTTP_1_1));
 
     timeToFirstByte();
@@ -1333,13 +1333,13 @@ public final class EventListenerTest {
     listener.takeEvent(CallEnd.class, 0L);
   }
 
-  private void enableTlsWithTunnel() {
+  private void enableTlsWithTunnel(boolean tunnelProxy) {
     client = client.newBuilder()
         .sslSocketFactory(
             handshakeCertificates.sslSocketFactory(), handshakeCertificates.trustManager())
         .hostnameVerifier(new RecordingHostnameVerifier())
         .build();
-    server.useHttps(handshakeCertificates.sslSocketFactory());
+    server.useHttps(handshakeCertificates.sslSocketFactory(), tunnelProxy);
   }
 
   @Test public void redirectUsingSameConnectionEventSequence() throws IOException {
diff --git a/okhttp/src/jvmTest/java/okhttp3/InsecureForHostTest.kt b/okhttp/src/jvmTest/java/okhttp3/InsecureForHostTest.kt
index 14c0eda3c..9a4f713a1 100644
--- a/okhttp/src/jvmTest/java/okhttp3/InsecureForHostTest.kt
+++ b/okhttp/src/jvmTest/java/okhttp3/InsecureForHostTest.kt
@@ -35,7 +35,7 @@ class InsecureForHostTest(
 
   @Test fun `untrusted host in insecureHosts connects successfully`() {
     val serverCertificates = localhost()
-    server.useHttps(serverCertificates.sslSocketFactory())
+    server.useHttps(serverCertificates.sslSocketFactory(), false)
     server.enqueue(MockResponse())
 
     val clientCertificates = HandshakeCertificates.Builder()
@@ -65,7 +65,7 @@ class InsecureForHostTest(
     val serverCertificates = HandshakeCertificates.Builder()
         .heldCertificate(heldCertificate)
         .build()
-    server.useHttps(serverCertificates.sslSocketFactory())
+    server.useHttps(serverCertificates.sslSocketFactory(), false)
     server.enqueue(MockResponse())
 
     val clientCertificates = HandshakeCertificates.Builder()
@@ -87,7 +87,7 @@ class InsecureForHostTest(
 
   @Test fun `untrusted host not in insecureHosts fails with SSLException`() {
     val serverCertificates = localhost()
-    server.useHttps(serverCertificates.sslSocketFactory())
+    server.useHttps(serverCertificates.sslSocketFactory(), false)
     server.enqueue(MockResponse())
 
     val clientCertificates = HandshakeCertificates.Builder()
diff --git a/okhttp/src/jvmTest/java/okhttp3/JSSETest.kt b/okhttp/src/jvmTest/java/okhttp3/JSSETest.kt
index daa008cfa..65c9eb420 100644
--- a/okhttp/src/jvmTest/java/okhttp3/JSSETest.kt
+++ b/okhttp/src/jvmTest/java/okhttp3/JSSETest.kt
@@ -149,6 +149,6 @@ class JSSETest(
         handshakeCertificates.sslSocketFactory(), handshakeCertificates.trustManager
       )
       .build()
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
   }
 }
diff --git a/okhttp/src/jvmTest/java/okhttp3/KotlinSourceModernTest.kt b/okhttp/src/jvmTest/java/okhttp3/KotlinSourceModernTest.kt
index d7ba620a6..4ff00a8c7 100644
--- a/okhttp/src/jvmTest/java/okhttp3/KotlinSourceModernTest.kt
+++ b/okhttp/src/jvmTest/java/okhttp3/KotlinSourceModernTest.kt
@@ -737,7 +737,7 @@ class KotlinSourceModernTest {
     mockWebServer.protocolNegotiationEnabled = false
     mockWebServer.protocols = listOf()
     val protocols: List<Protocol> = mockWebServer.protocols
-    mockWebServer.useHttps(SSLSocketFactory.getDefault() as SSLSocketFactory)
+    mockWebServer.useHttps(SSLSocketFactory.getDefault() as SSLSocketFactory, false)
     mockWebServer.noClientAuth()
     mockWebServer.requestClientAuth()
     mockWebServer.requireClientAuth()
diff --git a/okhttp/src/jvmTest/java/okhttp3/OpenJSSETest.kt b/okhttp/src/jvmTest/java/okhttp3/OpenJSSETest.kt
index a171329b2..b6c616ff9 100644
--- a/okhttp/src/jvmTest/java/okhttp3/OpenJSSETest.kt
+++ b/okhttp/src/jvmTest/java/okhttp3/OpenJSSETest.kt
@@ -109,6 +109,6 @@ class OpenJSSETest(
         .sslSocketFactory(
             handshakeCertificates.sslSocketFactory(), handshakeCertificates.trustManager)
         .build()
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
   }
 }
diff --git a/okhttp/src/jvmTest/java/okhttp3/ServerTruncatesRequestTest.kt b/okhttp/src/jvmTest/java/okhttp3/ServerTruncatesRequestTest.kt
index 32e924f56..b76ccc0f8 100644
--- a/okhttp/src/jvmTest/java/okhttp3/ServerTruncatesRequestTest.kt
+++ b/okhttp/src/jvmTest/java/okhttp3/ServerTruncatesRequestTest.kt
@@ -292,7 +292,7 @@ class ServerTruncatesRequestTest(
         )
         .hostnameVerifier(RecordingHostnameVerifier())
         .build()
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
   }
 
   /** A request body that slowly trickles bytes, expecting to not complete. */
diff --git a/okhttp/src/jvmTest/java/okhttp3/SessionReuseTest.kt b/okhttp/src/jvmTest/java/okhttp3/SessionReuseTest.kt
index fc6c316a5..7b0a8e507 100644
--- a/okhttp/src/jvmTest/java/okhttp3/SessionReuseTest.kt
+++ b/okhttp/src/jvmTest/java/okhttp3/SessionReuseTest.kt
@@ -154,6 +154,6 @@ class SessionReuseTest(
         handshakeCertificates.sslSocketFactory(), handshakeCertificates.trustManager
       )
       .build()
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
   }
 }
diff --git a/okhttp/src/jvmTest/java/okhttp3/SocketChannelTest.kt b/okhttp/src/jvmTest/java/okhttp3/SocketChannelTest.kt
index 34d14ac45..cf1131449 100644
--- a/okhttp/src/jvmTest/java/okhttp3/SocketChannelTest.kt
+++ b/okhttp/src/jvmTest/java/okhttp3/SocketChannelTest.kt
@@ -135,7 +135,7 @@ class SocketChannelTest(
               }
             }
           }
-          server.useHttps(serverSslSocketFactory)
+          server.useHttps(serverSslSocketFactory, false)
         } else if (socketMode == Channel) {
           socketFactory(ChannelSocketFactory())
         }
diff --git a/okhttp/src/jvmTest/java/okhttp3/URLConnectionTest.kt b/okhttp/src/jvmTest/java/okhttp3/URLConnectionTest.kt
index 8ace58dbe..d4a0dbdc7 100644
--- a/okhttp/src/jvmTest/java/okhttp3/URLConnectionTest.kt
+++ b/okhttp/src/jvmTest/java/okhttp3/URLConnectionTest.kt
@@ -471,7 +471,7 @@ class URLConnectionTest {
 
   @Test
   fun connectViaHttps() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(
       MockResponse()
         .setBody("this response comes via HTTPS")
@@ -499,7 +499,7 @@ class URLConnectionTest {
   }
 
   private fun connectViaHttpsReusingConnections(rebuildClient: Boolean) {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(
       MockResponse()
         .setBody("this response comes via HTTPS")
@@ -540,7 +540,7 @@ class URLConnectionTest {
 
   @Test
   fun connectViaHttpsReusingConnectionsDifferentFactories() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(
       MockResponse()
         .setBody("this response comes via HTTPS")
@@ -583,7 +583,7 @@ class URLConnectionTest {
   // TODO(jwilson): tests below this marker need to be migrated to OkHttp's request/response API.
   @Test
   fun connectViaHttpsWithSSLFallback() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(
       MockResponse()
         .setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE)
@@ -612,7 +612,7 @@ class URLConnectionTest {
 
   @Test
   fun connectViaHttpsWithSSLFallbackFailuresRecorded() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(
       MockResponse()
         .setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE)
@@ -647,7 +647,7 @@ class URLConnectionTest {
    */
   @Test
   fun sslFallbackNotUsedWhenRecycledConnectionFails() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(
       MockResponse()
         .setBody("abc")
@@ -687,7 +687,7 @@ class URLConnectionTest {
   @Test
   fun connectViaHttpsToUntrustedServer() {
     // Flaky https://github.com/square/okhttp/issues/5222
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(MockResponse()) // unused
     try {
       getResponse(newRequest("/foo"))
@@ -784,7 +784,7 @@ class URLConnectionTest {
       ): Socket? = null
     }
     if (useHttps) {
-      server.useHttps(handshakeCertificates.sslSocketFactory())
+      server.useHttps(handshakeCertificates.sslSocketFactory(), false)
       client = client.newBuilder()
         .sslSocketFactory(
           handshakeCertificates.sslSocketFactory(), handshakeCertificates.trustManager
@@ -866,7 +866,7 @@ class URLConnectionTest {
   }
 
   private fun testConnectViaDirectProxyToHttps(proxyConfig: ProxyConfig) {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(
       MockResponse()
         .setBody("this response comes via HTTPS")
@@ -909,7 +909,7 @@ class URLConnectionTest {
    */
   private fun testConnectViaHttpProxyToHttps(proxyConfig: ProxyConfig) {
     val hostnameVerifier = RecordingHostnameVerifier()
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), true)
     server.enqueue(
       MockResponse()
         .inTunnel()
@@ -944,7 +944,7 @@ class URLConnectionTest {
   @Test
   fun connectViaHttpProxyToHttpsUsingBadProxyAndHttpResponseCache() {
     initResponseCache()
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), true)
     // The inclusion of a body in the response to a CONNECT is key to reproducing b/6754912.
     server.enqueue(
       MockResponse()
@@ -990,7 +990,7 @@ class URLConnectionTest {
   @Test
   fun proxyConnectIncludesProxyHeadersOnly() {
     val hostnameVerifier = RecordingHostnameVerifier()
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), true)
     server.enqueue(
       MockResponse()
         .inTunnel()
@@ -1029,7 +1029,7 @@ class URLConnectionTest {
   @Test
   fun proxyAuthenticateOnConnect() {
     java.net.Authenticator.setDefault(RecordingAuthenticator())
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), true)
     server.enqueue(
       MockResponse()
         .inTunnel()
@@ -1074,7 +1074,7 @@ class URLConnectionTest {
   // http://code.google.com/p/android/issues/detail?id=37221
   @Test
   fun proxyWithConnectionClose() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), true)
     server.enqueue(
       MockResponse()
         .inTunnel()
@@ -1103,7 +1103,7 @@ class URLConnectionTest {
   fun proxyWithConnectionReuse() {
     val socketFactory = handshakeCertificates.sslSocketFactory()
     val hostnameVerifier = RecordingHostnameVerifier()
-    server.useHttps(socketFactory)
+    server.useHttps(socketFactory, true)
     server.enqueue(
       MockResponse()
         .inTunnel()
@@ -1446,7 +1446,7 @@ class URLConnectionTest {
     if (tls) {
       val socketFactory = handshakeCertificates.sslSocketFactory()
       val hostnameVerifier = RecordingHostnameVerifier()
-      server.useHttps(socketFactory)
+      server.useHttps(socketFactory, false)
       client = client.newBuilder()
         .sslSocketFactory(socketFactory, handshakeCertificates.trustManager)
         .hostnameVerifier(hostnameVerifier)
@@ -1902,7 +1902,7 @@ class URLConnectionTest {
    * http://code.google.com/p/android/issues/detail?id=12860
    */
   private fun testSecureStreamingPost(streamingMode: TransferKind) {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(
       MockResponse()
         .setBody("Success!")
@@ -2160,7 +2160,7 @@ class URLConnectionTest {
 
   @Test
   fun redirectedOnHttps() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(
       MockResponse()
         .setResponseCode(HttpURLConnection.HTTP_MOVED_TEMP)
@@ -2192,7 +2192,7 @@ class URLConnectionTest {
 
   @Test
   fun notRedirectedFromHttpsToHttp() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(
       MockResponse()
         .setResponseCode(HttpURLConnection.HTTP_MOVED_TEMP)
@@ -2233,7 +2233,7 @@ class URLConnectionTest {
       MockResponse()
         .setBody("This is insecure HTTP!")
     )
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(
       MockResponse()
         .setResponseCode(HttpURLConnection.HTTP_MOVED_TEMP)
@@ -2254,7 +2254,7 @@ class URLConnectionTest {
 
   @Test
   fun redirectedFromHttpToHttpsFollowingProtocolRedirects() {
-    server2.useHttps(handshakeCertificates.sslSocketFactory())
+    server2.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server2.enqueue(
       MockResponse()
         .setBody("This is secure HTTPS!")
@@ -2288,8 +2288,8 @@ class URLConnectionTest {
 
   private fun redirectToAnotherOriginServer(https: Boolean) {
     if (https) {
-      server.useHttps(handshakeCertificates.sslSocketFactory())
-      server2.useHttps(handshakeCertificates.sslSocketFactory())
+      server.useHttps(handshakeCertificates.sslSocketFactory(), false)
+      server2.useHttps(handshakeCertificates.sslSocketFactory(), false)
       server2.protocolNegotiationEnabled = false
       client = client.newBuilder()
         .sslSocketFactory(
@@ -2708,7 +2708,7 @@ class URLConnectionTest {
       .hostnameVerifier(hostnameVerifier)
       .sslSocketFactory(sslContext.socketFactory, trustManager)
       .build()
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.enqueue(
       MockResponse()
         .setBody("ABC")
@@ -3819,7 +3819,7 @@ class URLConnectionTest {
 
   @Test
   fun testNoSslFallback() {
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false /* tunnelProxy */)
     server.enqueue(
       MockResponse()
         .setSocketPolicy(SocketPolicy.FAIL_HANDSHAKE)
@@ -4231,7 +4231,7 @@ class URLConnectionTest {
       .hostnameVerifier(RecordingHostnameVerifier())
       .protocols(Arrays.asList(protocol, Protocol.HTTP_1_1))
       .build()
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     server.protocolNegotiationEnabled = true
     server.protocols = client.protocols
   }
diff --git a/okhttp/src/jvmTest/java/okhttp3/internal/http/CancelTest.kt b/okhttp/src/jvmTest/java/okhttp3/internal/http/CancelTest.kt
index 64424e7fb..e4e2b95cd 100644
--- a/okhttp/src/jvmTest/java/okhttp3/internal/http/CancelTest.kt
+++ b/okhttp/src/jvmTest/java/okhttp3/internal/http/CancelTest.kt
@@ -115,7 +115,7 @@ class CancelTest {
         }
       }
     if (connectionType != HTTP) {
-      server.useHttps(handshakeCertificates.sslSocketFactory())
+      server.useHttps(handshakeCertificates.sslSocketFactory(), false)
     }
     server.start()
 
diff --git a/okhttp/src/jvmTest/java/okhttp3/internal/http2/HttpOverHttp2Test.kt b/okhttp/src/jvmTest/java/okhttp3/internal/http2/HttpOverHttp2Test.kt
index 8b70f8a5c..b4d0cfb31 100644
--- a/okhttp/src/jvmTest/java/okhttp3/internal/http2/HttpOverHttp2Test.kt
+++ b/okhttp/src/jvmTest/java/okhttp3/internal/http2/HttpOverHttp2Test.kt
@@ -129,7 +129,7 @@ class HttpOverHttp2Test {
     platform.assumeNotBouncyCastle()
     if (protocol === Protocol.HTTP_2) {
       platform.assumeHttp2Support()
-      server.useHttps(handshakeCertificates.sslSocketFactory())
+      server.useHttps(handshakeCertificates.sslSocketFactory(), false)
       client = clientTestRule.newClientBuilder()
         .protocols(listOf(Protocol.HTTP_2, Protocol.HTTP_1_1))
         .sslSocketFactory(
@@ -1839,7 +1839,7 @@ class HttpOverHttp2Test {
   fun concurrentHttp2ConnectionsDeduplicated(protocol: Protocol, mockWebServer: MockWebServer) {
     setUp(protocol, mockWebServer)
     assumeTrue(protocol === Protocol.HTTP_2)
-    server.useHttps(handshakeCertificates.sslSocketFactory())
+    server.useHttps(handshakeCertificates.sslSocketFactory(), true)
     val queueDispatcher = QueueDispatcher()
     queueDispatcher.enqueueResponse(
       MockResponse()
diff --git a/okhttp/src/jvmTest/java/okhttp3/internal/tls/CertificatePinnerChainValidationTest.java b/okhttp/src/jvmTest/java/okhttp3/internal/tls/CertificatePinnerChainValidationTest.java
index 217d3af54..e253ac5b6 100644
--- a/okhttp/src/jvmTest/java/okhttp3/internal/tls/CertificatePinnerChainValidationTest.java
+++ b/okhttp/src/jvmTest/java/okhttp3/internal/tls/CertificatePinnerChainValidationTest.java
@@ -98,7 +98,7 @@ public final class CertificatePinnerChainValidationTest {
     HandshakeCertificates serverHandshakeCertificates = new HandshakeCertificates.Builder()
         .heldCertificate(certificate, intermediateCa.certificate())
         .build();
-    server.useHttps(serverHandshakeCertificates.sslSocketFactory());
+    server.useHttps(serverHandshakeCertificates.sslSocketFactory(), false);
 
     // The request should complete successfully.
     server.enqueue(new MockResponse()
@@ -146,7 +146,7 @@ public final class CertificatePinnerChainValidationTest {
     HandshakeCertificates serverHandshakeCertificates = new HandshakeCertificates.Builder()
         .heldCertificate(certificate, intermediateCa.certificate())
         .build();
-    server.useHttps(serverHandshakeCertificates.sslSocketFactory());
+    server.useHttps(serverHandshakeCertificates.sslSocketFactory(), false);
 
     // The request should complete successfully.
     server.enqueue(new MockResponse()
@@ -232,7 +232,7 @@ public final class CertificatePinnerChainValidationTest {
     SSLSocketFactory socketFactory = newServerSocketFactory(rogueCertificate,
         compromisedIntermediateCa.certificate(), goodCertificate.certificate());
 
-    server.useHttps(socketFactory);
+    server.useHttps(socketFactory, false);
     server.enqueue(new MockResponse()
         .setBody("abc")
         .addHeader("Content-Type: text/plain"));
@@ -311,7 +311,7 @@ public final class CertificatePinnerChainValidationTest {
 
     SSLSocketFactory socketFactory = newServerSocketFactory(rogueCertificate,
         goodIntermediateCa.certificate(), compromisedIntermediateCa.certificate());
-    server.useHttps(socketFactory);
+    server.useHttps(socketFactory, false);
     server.enqueue(new MockResponse()
         .setBody("abc")
         .addHeader("Content-Type: text/plain"));
@@ -456,7 +456,7 @@ public final class CertificatePinnerChainValidationTest {
             attackerIntermediate.certificate()
         )
         .build();
-    server.useHttps(serverHandshakeCertificates.sslSocketFactory());
+    server.useHttps(serverHandshakeCertificates.sslSocketFactory(), false);
 
     server.enqueue(new MockResponse());
 
@@ -556,7 +556,7 @@ public final class CertificatePinnerChainValidationTest {
             pinnedRoot.certificate()
         )
         .build();
-    server.useHttps(serverHandshakeCertificates.sslSocketFactory());
+    server.useHttps(serverHandshakeCertificates.sslSocketFactory(), false);
 
     server.enqueue(new MockResponse());
 
@@ -592,7 +592,7 @@ public final class CertificatePinnerChainValidationTest {
     HandshakeCertificates serverHandshakeCertificates = new HandshakeCertificates.Builder()
         .heldCertificate(onlyCertificate)
         .build();
-    server.useHttps(serverHandshakeCertificates.sslSocketFactory());
+    server.useHttps(serverHandshakeCertificates.sslSocketFactory(), false);
 
     // The request should complete successfully.
     server.enqueue(new MockResponse()
diff --git a/okhttp/src/jvmTest/java/okhttp3/internal/tls/ClientAuthTest.java b/okhttp/src/jvmTest/java/okhttp3/internal/tls/ClientAuthTest.java
index 5b9c6a63f..4303a5d11 100644
--- a/okhttp/src/jvmTest/java/okhttp3/internal/tls/ClientAuthTest.java
+++ b/okhttp/src/jvmTest/java/okhttp3/internal/tls/ClientAuthTest.java
@@ -126,7 +126,7 @@ public final class ClientAuthTest {
 
     SSLSocketFactory socketFactory = buildServerSslSocketFactory();
 
-    server.useHttps(socketFactory);
+    server.useHttps(socketFactory, false);
     server.requestClientAuth();
     server.enqueue(new MockResponse().setBody("abc"));
 
@@ -144,7 +144,7 @@ public final class ClientAuthTest {
 
     SSLSocketFactory socketFactory = buildServerSslSocketFactory();
 
-    server.useHttps(socketFactory);
+    server.useHttps(socketFactory, false);
     server.requireClientAuth();
     server.enqueue(new MockResponse().setBody("abc"));
 
@@ -162,7 +162,7 @@ public final class ClientAuthTest {
 
     SSLSocketFactory socketFactory = buildServerSslSocketFactory();
 
-    server.useHttps(socketFactory);
+    server.useHttps(socketFactory, false);
     server.noClientAuth();
     server.enqueue(new MockResponse().setBody("abc"));
 
@@ -179,7 +179,7 @@ public final class ClientAuthTest {
 
     SSLSocketFactory socketFactory = buildServerSslSocketFactory();
 
-    server.useHttps(socketFactory);
+    server.useHttps(socketFactory, false);
     server.requestClientAuth();
     server.enqueue(new MockResponse().setBody("abc"));
 
@@ -200,7 +200,7 @@ public final class ClientAuthTest {
 
     SSLSocketFactory socketFactory = buildServerSslSocketFactory();
 
-    server.useHttps(socketFactory);
+    server.useHttps(socketFactory, false);
     server.requireClientAuth();
 
     Call call = client.newCall(new Request.Builder().url(server.url("/")).build());
@@ -231,7 +231,7 @@ public final class ClientAuthTest {
 
     SSLSocketFactory socketFactory = buildServerSslSocketFactory();
 
-    server.useHttps(socketFactory);
+    server.useHttps(socketFactory, false);
     server.requireClientAuth();
 
     Call call = client.newCall(new Request.Builder().url(server.url("/")).build());
@@ -256,7 +256,7 @@ public final class ClientAuthTest {
 
     SSLSocketFactory socketFactory = buildServerSslSocketFactory();
 
-    server.useHttps(socketFactory);
+    server.useHttps(socketFactory, false);
     server.requireClientAuth();
 
     Call call = client.newCall(new Request.Builder().url(server.url("/")).build());
@@ -298,7 +298,7 @@ public final class ClientAuthTest {
 
     SSLSocketFactory socketFactory = buildServerSslSocketFactory();
 
-    server.useHttps(socketFactory);
+    server.useHttps(socketFactory, false);
     server.requireClientAuth();
 
     Call call = client.newCall(new Request.Builder().url(server.url("/")).build());
diff --git a/okhttp/src/jvmTest/java/okhttp3/internal/ws/WebSocketHttpTest.java b/okhttp/src/jvmTest/java/okhttp3/internal/ws/WebSocketHttpTest.java
index 381a2ea33..d13de0169 100644
--- a/okhttp/src/jvmTest/java/okhttp3/internal/ws/WebSocketHttpTest.java
+++ b/okhttp/src/jvmTest/java/okhttp3/internal/ws/WebSocketHttpTest.java
@@ -521,7 +521,7 @@ public final class WebSocketHttpTest {
   }
 
   @Test public void wssScheme() {
-    webServer.useHttps(handshakeCertificates.sslSocketFactory());
+    webServer.useHttps(handshakeCertificates.sslSocketFactory(), false);
     client = client.newBuilder()
         .sslSocketFactory(
             handshakeCertificates.sslSocketFactory(), handshakeCertificates.trustManager())
@@ -532,7 +532,7 @@ public final class WebSocketHttpTest {
   }
 
   @Test public void httpsScheme() {
-    webServer.useHttps(handshakeCertificates.sslSocketFactory());
+    webServer.useHttps(handshakeCertificates.sslSocketFactory(), false);
     client = client.newBuilder()
         .sslSocketFactory(
             handshakeCertificates.sslSocketFactory(), handshakeCertificates.trustManager())

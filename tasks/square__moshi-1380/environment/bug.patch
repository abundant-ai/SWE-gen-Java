diff --git a/kotlin/codegen/src/test/java/com/squareup/moshi/kotlin/codegen/JsonClassCodegenProcessorTest.kt b/kotlin/codegen/src/test/java/com/squareup/moshi/kotlin/codegen/JsonClassCodegenProcessorTest.kt
index 96d29c63..567e8b9a 100644
--- a/kotlin/codegen/src/test/java/com/squareup/moshi/kotlin/codegen/JsonClassCodegenProcessorTest.kt
+++ b/kotlin/codegen/src/test/java/com/squareup/moshi/kotlin/codegen/JsonClassCodegenProcessorTest.kt
@@ -47,7 +47,7 @@ class JsonClassCodegenProcessorTest {
           import com.squareup.moshi.JsonClass
 
           @JsonClass(generateAdapter = true)
-          class PrivateConstructor private constructor(val a: Int, val b: Int) {
+          class PrivateConstructor private constructor(var a: Int, var b: Int) {
             fun a() = a
             fun b() = b
             companion object {
diff --git a/kotlin/reflect/src/main/java/com/squareup/moshi/kotlin/reflect/KotlinJsonAdapter.kt b/kotlin/reflect/src/main/java/com/squareup/moshi/kotlin/reflect/KotlinJsonAdapter.kt
index 0db237e8..02744cb1 100644
--- a/kotlin/reflect/src/main/java/com/squareup/moshi/kotlin/reflect/KotlinJsonAdapter.kt
+++ b/kotlin/reflect/src/main/java/com/squareup/moshi/kotlin/reflect/KotlinJsonAdapter.kt
@@ -27,6 +27,7 @@ import com.squareup.moshi.internal.Util.resolve
 import com.squareup.moshi.rawType
 import java.lang.reflect.Modifier
 import java.lang.reflect.Type
+import java.util.AbstractMap.SimpleEntry
 import kotlin.reflect.KFunction
 import kotlin.reflect.KMutableProperty1
 import kotlin.reflect.KParameter
diff --git a/kotlin/tests/src/test/kotlin/com/squareup/moshi/kotlin/codegen/GeneratedAdaptersTest.kt b/kotlin/tests/src/test/kotlin/com/squareup/moshi/kotlin/codegen/GeneratedAdaptersTest.kt
index 8d3d1835..406af922 100644
--- a/kotlin/tests/src/test/kotlin/com/squareup/moshi/kotlin/codegen/GeneratedAdaptersTest.kt
+++ b/kotlin/tests/src/test/kotlin/com/squareup/moshi/kotlin/codegen/GeneratedAdaptersTest.kt
@@ -437,7 +437,10 @@ class GeneratedAdaptersTest {
   }
 
   @JsonClass(generateAdapter = true)
-  class ImmutableProperties(val a: Int, val b: Int)
+  class ImmutableProperties(a: Int, b: Int) {
+    val a = a
+    val b = b
+  }
 
   @Test fun constructorDefaults() {
     val moshi = Moshi.Builder().build()
diff --git a/kotlin/tests/src/test/kotlin/com/squareup/moshi/kotlin/reflect/KotlinJsonAdapterTest.kt b/kotlin/tests/src/test/kotlin/com/squareup/moshi/kotlin/reflect/KotlinJsonAdapterTest.kt
index 23d857c7..f9c9c996 100644
--- a/kotlin/tests/src/test/kotlin/com/squareup/moshi/kotlin/reflect/KotlinJsonAdapterTest.kt
+++ b/kotlin/tests/src/test/kotlin/com/squareup/moshi/kotlin/reflect/KotlinJsonAdapterTest.kt
@@ -115,7 +115,10 @@ class KotlinJsonAdapterTest {
     assertThat(decoded.b).isEqualTo(5)
   }
 
-  class ImmutableProperties(val a: Int, val b: Int)
+  class ImmutableProperties(a: Int, b: Int) {
+    val a = a
+    val b = b
+  }
 
   @Test fun constructorDefaults() {
     val moshi = Moshi.Builder().add(KotlinJsonAdapterFactory()).build()
@@ -429,13 +432,13 @@ class KotlinJsonAdapterTest {
 
     val decoded = jsonAdapter.fromJson("""{"a":4,"buf":[0,0],"size":0}""")!!
     assertThat(decoded.a).isEqualTo(4)
-    assertThat(decoded.buf()).isEqualTo(ByteArray(2) { 0 })
+    assertThat(decoded.buf()).isEqualTo(ByteArray(2, { 0 }))
     assertThat(decoded.count()).isEqualTo(0)
   }
 
   internal class ExtendsPlatformClassWithProtectedField(var a: Int) : ByteArrayOutputStream(2) {
-    fun buf(): ByteArray = buf
-    fun count(): Int = count
+    fun buf() = buf
+    fun count() = count
   }
 
   @Test fun platformTypeThrows() {
diff --git a/moshi/src/main/java/com/squareup/moshi/JsonUtf8Writer.java b/moshi/src/main/java/com/squareup/moshi/JsonUtf8Writer.java
index 8cc783fd..5cee11f5 100644
--- a/moshi/src/main/java/com/squareup/moshi/JsonUtf8Writer.java
+++ b/moshi/src/main/java/com/squareup/moshi/JsonUtf8Writer.java
@@ -49,7 +49,7 @@ final class JsonUtf8Writer extends JsonWriter {
   static {
     REPLACEMENT_CHARS = new String[128];
     for (int i = 0; i <= 0x1f; i++) {
-      REPLACEMENT_CHARS[i] = String.format("\\u%04x", i);
+      REPLACEMENT_CHARS[i] = String.format("\\u%04x", (int) i);
     }
     REPLACEMENT_CHARS['"'] = "\\\"";
     REPLACEMENT_CHARS['\\'] = "\\\\";
diff --git a/moshi/src/main/java/com/squareup/moshi/LinkedHashTreeMap.java b/moshi/src/main/java/com/squareup/moshi/LinkedHashTreeMap.java
index ffce2d4e..a3c0a204 100644
--- a/moshi/src/main/java/com/squareup/moshi/LinkedHashTreeMap.java
+++ b/moshi/src/main/java/com/squareup/moshi/LinkedHashTreeMap.java
@@ -43,7 +43,7 @@ final class LinkedHashTreeMap<K, V> extends AbstractMap<K, V> implements Seriali
         }
       };
 
-  final Comparator<? super K> comparator;
+  Comparator<? super K> comparator;
   Node<K, V>[] table;
   final Node<K, V> header;
   int size = 0;
@@ -346,11 +346,13 @@ final class LinkedHashTreeMap<K, V> extends AbstractMap<K, V> implements Seriali
         int rightLeftHeight = rightLeft != null ? rightLeft.height : 0;
 
         int rightDelta = rightLeftHeight - rightRightHeight;
-        if (rightDelta != -1 && (rightDelta != 0 || insert)) {
+        if (rightDelta == -1 || (rightDelta == 0 && !insert)) {
+          rotateLeft(node); // AVL right right
+        } else {
           assert (rightDelta == 1);
           rotateRight(right); // AVL right left
+          rotateLeft(node);
         }
-        rotateLeft(node); // AVL right right
         if (insert) {
           break; // no further rotations will be necessary
         }
@@ -362,11 +364,13 @@ final class LinkedHashTreeMap<K, V> extends AbstractMap<K, V> implements Seriali
         int leftLeftHeight = leftLeft != null ? leftLeft.height : 0;
 
         int leftDelta = leftLeftHeight - leftRightHeight;
-        if (leftDelta != 1 && (leftDelta != 0 || insert)) {
+        if (leftDelta == 1 || (leftDelta == 0 && !insert)) {
+          rotateRight(node); // AVL left left
+        } else {
           assert (leftDelta == -1);
           rotateLeft(left); // AVL left right
+          rotateRight(node);
         }
-        rotateRight(node); // AVL left left
         if (insert) {
           break; // no further rotations will be necessary
         }
diff --git a/moshi/src/main/java/com/squareup/moshi/Moshi.java b/moshi/src/main/java/com/squareup/moshi/Moshi.java
index 6a480f21..9f19fb6d 100644
--- a/moshi/src/main/java/com/squareup/moshi/Moshi.java
+++ b/moshi/src/main/java/com/squareup/moshi/Moshi.java
@@ -184,7 +184,7 @@ public final class Moshi {
   @CheckReturnValue
   public Moshi.Builder newBuilder() {
     Builder result = new Builder();
-    for (int i = 0; i < lastOffset; i++) {
+    for (int i = 0, limit = lastOffset; i < limit; i++) {
       result.add(factories.get(i));
     }
     for (int i = lastOffset, limit = factories.size() - BUILT_IN_FACTORIES.size(); i < limit; i++) {
diff --git a/moshi/src/test/java/com/squareup/moshi/KotlinExtensionsTest.kt b/moshi/src/test/java/com/squareup/moshi/KotlinExtensionsTest.kt
index 0474b2d7..47c277e8 100644
--- a/moshi/src/test/java/com/squareup/moshi/KotlinExtensionsTest.kt
+++ b/moshi/src/test/java/com/squareup/moshi/KotlinExtensionsTest.kt
@@ -61,7 +61,7 @@ class KotlinExtensionsTest {
   fun addAdapterInferred() {
     // An adapter that always returns -1
     val customIntdapter = object : JsonAdapter<Int>() {
-      override fun fromJson(reader: JsonReader): Int {
+      override fun fromJson(reader: JsonReader): Int? {
         reader.skipValue()
         return -1
       }
@@ -81,7 +81,7 @@ class KotlinExtensionsTest {
   fun addAdapterInferred_parameterized() {
     // An adapter that always returns listOf(-1)
     val customIntListAdapter = object : JsonAdapter<List<Int>>() {
-      override fun fromJson(reader: JsonReader): List<Int> {
+      override fun fromJson(reader: JsonReader): List<Int>? {
         reader.skipValue()
         return listOf(-1)
       }

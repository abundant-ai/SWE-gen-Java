diff --git a/gradle/libs.versions.toml b/gradle/libs.versions.toml
index de946c0f1..b3d48ca51 100644
--- a/gradle/libs.versions.toml
+++ b/gradle/libs.versions.toml
@@ -3,7 +3,7 @@
 biz-aQute-bnd = "7.1.0"
 checkStyle = "10.25.0"
 com-squareup-moshi = "1.15.2"
-com-squareup-okio = "3.12.0"
+com-squareup-okio = "3.13.0"
 de-mannodermaus-junit5 = "1.8.0"
 graalvm = "24.2.1"
 junit-platform = "1.13.1"
diff --git a/mockwebserver/api/mockwebserver3.api b/mockwebserver/api/mockwebserver3.api
index 8c9a90cc3..ede7b45e5 100644
--- a/mockwebserver/api/mockwebserver3.api
+++ b/mockwebserver/api/mockwebserver3.api
@@ -19,9 +19,9 @@ public final class mockwebserver3/MockResponse {
 	public final fun getMessage ()Ljava/lang/String;
 	public final fun getPushPromises ()Ljava/util/List;
 	public final fun getSettings ()Lokhttp3/internal/http2/Settings;
+	public final fun getSocketHandler ()Lmockwebserver3/SocketHandler;
 	public final fun getSocketPolicy ()Lmockwebserver3/SocketPolicy;
 	public final fun getStatus ()Ljava/lang/String;
-	public final fun getStreamHandler ()Lmockwebserver3/StreamHandler;
 	public final fun getThrottleBytesPerPeriod ()J
 	public final fun getThrottlePeriodNanos ()J
 	public final fun getTrailers ()Lokhttp3/Headers;
@@ -61,9 +61,9 @@ public final class mockwebserver3/MockResponse$Builder : java/lang/Cloneable {
 	public final fun getInformationalResponses ()Ljava/util/List;
 	public final fun getPushPromises ()Ljava/util/List;
 	public final fun getSettings ()Lokhttp3/internal/http2/Settings;
+	public final fun getSocketHandler ()Lmockwebserver3/SocketHandler;
 	public final fun getSocketPolicy ()Lmockwebserver3/SocketPolicy;
 	public final fun getStatus ()Ljava/lang/String;
-	public final fun getStreamHandler ()Lmockwebserver3/StreamHandler;
 	public final fun getThrottleBytesPerPeriod ()J
 	public final fun getThrottlePeriodNanos ()J
 	public final fun getTrailers ()Lokhttp3/Headers;
@@ -75,9 +75,9 @@ public final class mockwebserver3/MockResponse$Builder : java/lang/Cloneable {
 	public final fun removeHeader (Ljava/lang/String;)Lmockwebserver3/MockResponse$Builder;
 	public final fun setHeader (Ljava/lang/String;Ljava/lang/Object;)Lmockwebserver3/MockResponse$Builder;
 	public final fun settings (Lokhttp3/internal/http2/Settings;)Lmockwebserver3/MockResponse$Builder;
+	public final fun socketHandler (Lmockwebserver3/SocketHandler;)Lmockwebserver3/MockResponse$Builder;
 	public final fun socketPolicy (Lmockwebserver3/SocketPolicy;)Lmockwebserver3/MockResponse$Builder;
 	public final fun status (Ljava/lang/String;)Lmockwebserver3/MockResponse$Builder;
-	public final fun streamHandler (Lmockwebserver3/StreamHandler;)Lmockwebserver3/MockResponse$Builder;
 	public final fun throttleBody (JJLjava/util/concurrent/TimeUnit;)Lmockwebserver3/MockResponse$Builder;
 	public final fun trailers (Lokhttp3/Headers;)Lmockwebserver3/MockResponse$Builder;
 	public final fun trailersDelay (JLjava/util/concurrent/TimeUnit;)Lmockwebserver3/MockResponse$Builder;
@@ -171,6 +171,10 @@ public final class mockwebserver3/RecordedRequest {
 	public fun toString ()Ljava/lang/String;
 }
 
+public abstract interface class mockwebserver3/SocketHandler {
+	public abstract fun handle (Lokio/Socket;)V
+}
+
 public abstract interface class mockwebserver3/SocketPolicy {
 }
 
@@ -240,13 +244,3 @@ public final class mockwebserver3/SocketPolicy$StallSocketAtStart : mockwebserve
 	public static final field INSTANCE Lmockwebserver3/SocketPolicy$StallSocketAtStart;
 }
 
-public abstract interface class mockwebserver3/Stream {
-	public abstract fun cancel ()V
-	public abstract fun getRequestBody ()Lokio/BufferedSource;
-	public abstract fun getResponseBody ()Lokio/BufferedSink;
-}
-
-public abstract interface class mockwebserver3/StreamHandler {
-	public abstract fun handle (Lmockwebserver3/Stream;)V
-}
-
diff --git a/mockwebserver/src/main/kotlin/mockwebserver3/MockResponse.kt b/mockwebserver/src/main/kotlin/mockwebserver3/MockResponse.kt
index 5b52f47a7..d1aa78a57 100644
--- a/mockwebserver/src/main/kotlin/mockwebserver3/MockResponse.kt
+++ b/mockwebserver/src/main/kotlin/mockwebserver3/MockResponse.kt
@@ -57,7 +57,7 @@ class MockResponse {
   // At most one of (body,webSocketListener,streamHandler) is non-null.
   val body: MockResponseBody?
   val webSocketListener: WebSocketListener?
-  val streamHandler: StreamHandler?
+  val socketHandler: SocketHandler?
 
   val inTunnel: Boolean
   val informationalResponses: List<MockResponse>
@@ -94,7 +94,7 @@ class MockResponse {
     this.headers = builder.headers
     this.trailers = builder.trailers
     this.body = builder.body
-    this.streamHandler = builder.streamHandler
+    this.socketHandler = builder.socketHandler
     this.webSocketListener = builder.webSocketListener
     this.inTunnel = builder.inTunnel
     this.informationalResponses = builder.informationalResponses
@@ -150,22 +150,22 @@ class MockResponse {
     val trailers: Headers
       get() = trailers_.build()
 
-    // At most one of (body,webSocketListener,streamHandler) is non-null.
+    // At most one of (body,webSocketListener,socketHandler) is non-null.
     private var bodyVar: MockResponseBody? = null
-    private var streamHandlerVar: StreamHandler? = null
+    private var socketHandlerVar: SocketHandler? = null
     private var webSocketListenerVar: WebSocketListener? = null
 
     var body: MockResponseBody?
       get() = bodyVar
       private set(value) {
         bodyVar = value
-        streamHandlerVar = null
+        socketHandlerVar = null
         webSocketListenerVar = null
       }
-    var streamHandler: StreamHandler?
-      get() = streamHandlerVar
+    var socketHandler: SocketHandler?
+      get() = socketHandlerVar
       private set(value) {
-        streamHandlerVar = value
+        socketHandlerVar = value
         bodyVar = null
         webSocketListenerVar = null
       }
@@ -174,7 +174,7 @@ class MockResponse {
       private set(value) {
         webSocketListenerVar = value
         bodyVar = null
-        streamHandlerVar = null
+        socketHandlerVar = null
       }
 
     var throttleBytesPerPeriod: Long
@@ -205,7 +205,7 @@ class MockResponse {
       this.informationalResponses_ = mutableListOf()
       this.status = "HTTP/1.1 200 OK"
       this.bodyVar = null
-      this.streamHandlerVar = null
+      this.socketHandlerVar = null
       this.webSocketListenerVar = null
       this.headers_ =
         Headers
@@ -229,7 +229,7 @@ class MockResponse {
       this.headers_ = mockResponse.headers.newBuilder()
       this.trailers_ = mockResponse.trailers.newBuilder()
       this.bodyVar = mockResponse.body
-      this.streamHandlerVar = mockResponse.streamHandler
+      this.socketHandlerVar = mockResponse.socketHandler
       this.webSocketListenerVar = mockResponse.webSocketListener
       this.throttleBytesPerPeriod = mockResponse.throttleBytesPerPeriod
       this.throttlePeriodNanos = mockResponse.throttlePeriodNanos
@@ -322,9 +322,9 @@ class MockResponse {
     /** Sets the response body to the UTF-8 encoded bytes of [body]. */
     fun body(body: String): Builder = body(Buffer().writeUtf8(body))
 
-    fun streamHandler(streamHandler: StreamHandler) =
+    fun socketHandler(socketHandler: SocketHandler) =
       apply {
-        this.streamHandler = streamHandler
+        this.socketHandler = socketHandler
       }
 
     /**
diff --git a/mockwebserver/src/main/kotlin/mockwebserver3/MockWebServer.kt b/mockwebserver/src/main/kotlin/mockwebserver3/MockWebServer.kt
index 734d05e59..a4ce2a0fd 100644
--- a/mockwebserver/src/main/kotlin/mockwebserver3/MockWebServer.kt
+++ b/mockwebserver/src/main/kotlin/mockwebserver3/MockWebServer.kt
@@ -65,7 +65,6 @@ import mockwebserver3.SocketPolicy.ShutdownServerAfterResponse
 import mockwebserver3.SocketPolicy.StallSocketAtStart
 import mockwebserver3.internal.ThrottledSink
 import mockwebserver3.internal.TriggerSink
-import mockwebserver3.internal.duplex.RealStream
 import mockwebserver3.internal.sleepNanos
 import okhttp3.ExperimentalOkHttpApi
 import okhttp3.Headers
@@ -1053,7 +1052,7 @@ class MockWebServer : Closeable {
       val body = Buffer()
       val requestLine = "$method $path HTTP/1.1"
       var exception: IOException? = null
-      if (readBody && peek.streamHandler == null && peek.socketPolicy !is DoNotReadRequestBody) {
+      if (readBody && peek.socketHandler == null && peek.socketPolicy !is DoNotReadRequestBody) {
         try {
           val contentLengthString = headers["content-length"]
           val requestBodySink =
@@ -1065,7 +1064,7 @@ class MockWebServer : Closeable {
                 socket = socket,
               ).buffer()
           requestBodySink.use {
-            it.writeAll(stream.getSource())
+            it.writeAll(stream.source)
           }
         } catch (e: IOException) {
           exception = e
@@ -1109,11 +1108,11 @@ class MockWebServer : Closeable {
       val bodyDelayNanos = response.bodyDelayNanos
       val trailers = response.trailers
       val body = response.body
-      val streamHandler = response.streamHandler
+      val socketHandler = response.socketHandler
       val outFinished = (
         body == null &&
           response.pushPromises.isEmpty() &&
-          streamHandler == null
+          socketHandler == null
       )
       val flushHeaders = body == null || bodyDelayNanos != 0L
       require(!outFinished || trailers.size == 0) {
@@ -1131,7 +1130,7 @@ class MockWebServer : Closeable {
         sleepNanos(bodyDelayNanos)
         val responseBodySink =
           stream
-            .getSink()
+            .sink
             .withThrottlingAndSocketPolicy(
               policy = response,
               disconnectHalfway = response.socketPolicy == DisconnectDuringResponseBody,
@@ -1147,8 +1146,8 @@ class MockWebServer : Closeable {
             sleepNanos(response.trailersDelayNanos)
           }
         }
-      } else if (streamHandler != null) {
-        streamHandler.handle(RealStream(stream))
+      } else if (socketHandler != null) {
+        socketHandler.handle(stream)
       } else if (!outFinished) {
         sleepNanos(response.trailersDelayNanos)
         stream.close(ErrorCode.NO_ERROR, null)
diff --git a/mockwebserver/src/main/kotlin/mockwebserver3/internal/duplex/RealStream.kt b/mockwebserver/src/main/kotlin/mockwebserver3/SocketHandler.kt
similarity index 53%
rename from mockwebserver/src/main/kotlin/mockwebserver3/internal/duplex/RealStream.kt
rename to mockwebserver/src/main/kotlin/mockwebserver3/SocketHandler.kt
index b1867d7b3..1d2980454 100644
--- a/mockwebserver/src/main/kotlin/mockwebserver3/internal/duplex/RealStream.kt
+++ b/mockwebserver/src/main/kotlin/mockwebserver3/SocketHandler.kt
@@ -13,21 +13,18 @@
  * See the License for the specific language governing permissions and
  * limitations under the License.
  */
-package mockwebserver3.internal.duplex
+package mockwebserver3
 
-import mockwebserver3.Stream
-import okhttp3.internal.http2.ErrorCode
-import okhttp3.internal.http2.Http2Stream
-import okio.buffer
+import okhttp3.ExperimentalOkHttpApi
+import okio.Socket
 
-/** Adapt OkHttp's internal [Http2Stream] type to the public [Stream] type. */
-internal class RealStream(
-  private val http2Stream: Http2Stream,
-) : Stream {
-  override val requestBody = http2Stream.getSource().buffer()
-  override val responseBody = http2Stream.getSink().buffer()
-
-  override fun cancel() {
-    http2Stream.closeLater(ErrorCode.CANCEL)
-  }
+/**
+ * Handles a call's request and response streams directly. Use this instead of [MockResponseBody] to
+ * begin sending response data before all request data has been received.
+ *
+ * See [okhttp3.RequestBody.isDuplex].
+ */
+@ExperimentalOkHttpApi
+interface SocketHandler {
+  fun handle(socket: Socket)
 }
diff --git a/mockwebserver/src/main/kotlin/mockwebserver3/Stream.kt b/mockwebserver/src/main/kotlin/mockwebserver3/Stream.kt
deleted file mode 100644
index 90c68534e..000000000
--- a/mockwebserver/src/main/kotlin/mockwebserver3/Stream.kt
+++ /dev/null
@@ -1,41 +0,0 @@
-/*
- * Copyright (C) 2022 Block, Inc.
- *
- * Licensed under the Apache License, Version 2.0 (the "License");
- * you may not use this file except in compliance with the License.
- * You may obtain a copy of the License at
- *
- *      http://www.apache.org/licenses/LICENSE-2.0
- *
- * Unless required by applicable law or agreed to in writing, software
- * distributed under the License is distributed on an "AS IS" BASIS,
- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
- * See the License for the specific language governing permissions and
- * limitations under the License.
- */
-package mockwebserver3
-
-import okhttp3.ExperimentalOkHttpApi
-import okio.BufferedSink
-import okio.BufferedSource
-
-/**
- * A bidirectional sequence of data frames exchanged between client and server.
- */
-@ExperimentalOkHttpApi
-interface Stream {
-  val requestBody: BufferedSource
-  val responseBody: BufferedSink
-
-  /**
-   * Terminate the stream so that no further data is transmitted or received. Note that
-   * [requestBody] may return data after this call; that is the buffered data received before this
-   * stream was canceled.
-   *
-   * This does nothing if [requestBody] and [responseBody] are already closed.
-   *
-   * For HTTP/2 this sends the [CANCEL](https://datatracker.ietf.org/doc/html/rfc7540#section-7)
-   * error code.
-   */
-  fun cancel()
-}
diff --git a/mockwebserver/src/main/kotlin/mockwebserver3/internal/duplex/MockSocketHandler.kt b/mockwebserver/src/main/kotlin/mockwebserver3/internal/duplex/MockSocketHandler.kt
new file mode 100644
index 000000000..e040f6ed9
--- /dev/null
+++ b/mockwebserver/src/main/kotlin/mockwebserver3/internal/duplex/MockSocketHandler.kt
@@ -0,0 +1,134 @@
+/*
+ * Copyright (C) 2019 Square, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package mockwebserver3.internal.duplex
+
+import java.io.IOException
+import java.util.concurrent.CountDownLatch
+import java.util.concurrent.FutureTask
+import java.util.concurrent.LinkedBlockingQueue
+import java.util.concurrent.TimeUnit
+import mockwebserver3.SocketHandler
+import okio.BufferedSink
+import okio.BufferedSource
+import okio.Socket
+import okio.buffer
+import okio.utf8Size
+
+private typealias Action = (BufferedSocket) -> Unit
+
+private class BufferedSocket(
+  val socket: Socket,
+) {
+  val source: BufferedSource = socket.source.buffer()
+  val sink: BufferedSink = socket.sink.buffer()
+
+  fun cancel() {
+    socket.cancel()
+  }
+}
+
+/**
+ * A scriptable request/response conversation. Create the script by calling methods like
+ * [receiveRequest] in the sequence they are run.
+ */
+class MockSocketHandler : SocketHandler {
+  private val actions = LinkedBlockingQueue<Action>()
+  private val results = LinkedBlockingQueue<FutureTask<Void>>()
+
+  fun receiveRequest(expected: String) =
+    apply {
+      actions += { stream ->
+        val actual = stream.source.readUtf8(expected.utf8Size())
+        if (actual != expected) throw AssertionError("$actual != $expected")
+      }
+    }
+
+  fun exhaustRequest() =
+    apply {
+      actions += { stream ->
+        if (!stream.source.exhausted()) throw AssertionError("expected exhausted")
+      }
+    }
+
+  fun cancelStream() =
+    apply {
+      actions += { stream -> stream.cancel() }
+    }
+
+  fun requestIOException() =
+    apply {
+      actions += { stream ->
+        try {
+          stream.source.exhausted()
+          throw AssertionError("expected IOException")
+        } catch (expected: IOException) {
+        }
+      }
+    }
+
+  @JvmOverloads
+  fun sendResponse(
+    s: String,
+    responseSent: CountDownLatch = CountDownLatch(0),
+  ) = apply {
+    actions += { stream ->
+      stream.sink.writeUtf8(s)
+      stream.sink.flush()
+      responseSent.countDown()
+    }
+  }
+
+  fun exhaustResponse() =
+    apply {
+      actions += { stream -> stream.sink.close() }
+    }
+
+  fun sleep(
+    duration: Long,
+    unit: TimeUnit,
+  ) = apply {
+    actions += { Thread.sleep(unit.toMillis(duration)) }
+  }
+
+  override fun handle(socket: Socket) {
+    val task = serviceSocketTask(BufferedSocket(socket))
+    results.add(task)
+    task.run()
+  }
+
+  /** Returns a task that processes both request and response from [socket]. */
+  private fun serviceSocketTask(socket: BufferedSocket): FutureTask<Void> {
+    return FutureTask<Void> {
+      socket.source.use {
+        socket.sink.use {
+          while (true) {
+            val action = actions.poll() ?: break
+            action(socket)
+          }
+        }
+      }
+      return@FutureTask null
+    }
+  }
+
+  /** Returns once all stream actions complete successfully. */
+  fun awaitSuccess() {
+    val futureTask =
+      results.poll(5, TimeUnit.SECONDS)
+        ?: throw AssertionError("no onRequest call received")
+    futureTask.get(5, TimeUnit.SECONDS)
+  }
+}
diff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Http2ExchangeCodec.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Http2ExchangeCodec.kt
index 3b02e28a7..ee4d569ff 100644
--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Http2ExchangeCodec.kt
+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Http2ExchangeCodec.kt
@@ -70,7 +70,7 @@ class Http2ExchangeCodec(
   override fun createRequestBody(
     request: Request,
     contentLength: Long,
-  ): Sink = stream!!.getSink()
+  ): Sink = stream!!.sink
 
   override fun writeRequestHeaders(request: Request) {
     if (stream != null) return
@@ -93,7 +93,7 @@ class Http2ExchangeCodec(
   }
 
   override fun finishRequest() {
-    stream!!.getSink().close()
+    stream!!.sink.close()
   }
 
   override fun readResponseHeaders(expectContinue: Boolean): Response.Builder? {
diff --git a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Http2Stream.kt b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Http2Stream.kt
index c03f7c636..fa7337a16 100644
--- a/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Http2Stream.kt
+++ b/okhttp/src/commonJvmAndroid/kotlin/okhttp3/internal/http2/Http2Stream.kt
@@ -32,6 +32,7 @@ import okio.AsyncTimeout
 import okio.Buffer
 import okio.BufferedSource
 import okio.Sink
+import okio.Socket
 import okio.Source
 import okio.Timeout
 
@@ -43,7 +44,8 @@ class Http2Stream internal constructor(
   outFinished: Boolean,
   inFinished: Boolean,
   headers: Headers?,
-) : Lockable {
+) : Lockable,
+  Socket {
   // Internal state is guarded by `this`. No long-running or potentially blocking operations are
   // performed while the lock is held.
 
@@ -64,12 +66,12 @@ class Http2Stream internal constructor(
   /** True if response headers have been sent or received. */
   private var hasResponseHeaders: Boolean = false
 
-  internal val source =
+  override val source =
     FramingSource(
       maxByteCount = connection.okHttpSettings.initialWindowSize.toLong(),
       finished = inFinished,
     )
-  internal val sink =
+  override val sink =
     FramingSink(
       finished = outFinished,
     )
@@ -234,24 +236,6 @@ class Http2Stream internal constructor(
 
   fun writeTimeout(): Timeout = writeTimeout
 
-  /** Returns a source that reads data from the peer. */
-  fun getSource(): Source = source
-
-  /**
-   * Returns a sink that can be used to write data to the peer.
-   *
-   * @throws IllegalStateException if this stream was initiated by the peer and a [writeHeaders] has
-   *     not yet been sent.
-   */
-  fun getSink(): Sink {
-    withLock {
-      check(hasResponseHeaders || isLocallyInitiated) {
-        "reply before requesting the sink"
-      }
-    }
-    return sink
-  }
-
   /**
    * Abnormally terminate this stream. This blocks until the `RST_STREAM` frame has been
    * transmitted.
@@ -267,6 +251,10 @@ class Http2Stream internal constructor(
     connection.writeSynReset(id, rstStatusCode)
   }
 
+  override fun cancel() {
+    closeLater(ErrorCode.CANCEL)
+  }
+
   /**
    * Abnormally terminate this stream. This enqueues a `RST_STREAM` frame and returns immediately.
    */
@@ -572,7 +560,7 @@ class Http2Stream internal constructor(
   }
 
   /** A sink that writes outgoing data frames of a stream. This class is not thread safe. */
-  internal inner class FramingSink(
+  inner class FramingSink(
     /** True if either side has cleanly shut down this stream. We shall send no more bytes. */
     var finished: Boolean = false,
   ) : Sink {

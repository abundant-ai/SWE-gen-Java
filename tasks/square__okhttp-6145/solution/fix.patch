diff --git a/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/Adapters.kt b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/Adapters.kt
index 75065a534..0ff46ddde 100644
--- a/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/Adapters.kt
+++ b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/Adapters.kt
@@ -229,11 +229,25 @@ internal object Adapters {
         tag = 16L
     ) {
       override fun encode(writer: DerWriter, value: T) {
+        writer.pushTypeHint()
+        try {
+          encodeWithTypeHints(value, writer)
+        } finally {
+          writer.popTypeHint()
+        }
+      }
+
+      private fun encodeWithTypeHints(value: T, writer: DerWriter) {
         val list = decompose(value)
+
         for (i in list.indices) {
           val v = list[i]
           val adapter = members[i] as DerAdapter<Any?>
 
+          if (adapter.typeHint) {
+            writer.typeHint = v
+          }
+
           if (adapter.omitInSequence(v)) {
             // Skip.
           } else {
@@ -243,18 +257,38 @@ internal object Adapters {
       }
 
       override fun decode(reader: DerReader, header: DerHeader): T {
+        reader.pushTypeHint()
+        try {
+          return decodeWithTypeHints(reader)
+        } finally {
+          reader.popTypeHint()
+        }
+      }
+
+      private fun decodeWithTypeHints(reader: DerReader): T {
         val list = mutableListOf<Any?>()
 
         while (list.size < members.size) {
           val member = members[list.size]
-          if (reader.hasNext() && member.matches(reader.peekedTagClass, reader.peekedTag)) {
-            list += reader.read(member)
-          } else if (member.isOptional) {
-            list += member.defaultValue
-          } else {
-            throw IOException("expected ${member.tagClass}/${member.tag} " +
-                "but was ${reader.peekedTagClass}/${reader.peekedTag}")
+
+          val value = when {
+            reader.hasNext() &&
+                member.matches(reader.peekedTagClass, reader.peekedTag) -> {
+              reader.read(member)
+            }
+            member.isOptional -> {
+              member.defaultValue
+            }
+            else -> {
+              throw IOException("expected ${member.tagClass}/${member.tag} " +
+                  "but was ${reader.peekedTagClass}/${reader.peekedTag}")
+            }
+          }
+
+          if (member.typeHint) {
+            reader.typeHint = value
           }
+          list += value
         }
 
         if (reader.hasNext()) {
@@ -289,6 +323,43 @@ internal object Adapters {
     }
   }
 
+  /**
+   * This decodes an [OCTET_STRING] value into its contents, which are also expected to be ASN.1.
+   * To determine which type to decode as it uses a preceding member of the same SEQUENCE. For
+   * example, extensions type IDs specify what types to use for the corresponding values.
+   *
+   * If the hint is unknown [chooser] should return null which will cause the value to be decoded as
+   * an opaque byte string.
+   */
+  fun usingTypeHint(chooser: (Any?) -> DerAdapter<*>?): DerAdapter<Any?> {
+    return object : DerAdapter<Any?>(tagClass = OCTET_STRING.tagClass, tag = OCTET_STRING.tag) {
+      override fun encode(writer: DerWriter, value: Any?) {
+        val adapter = chooser(writer.typeHint)
+
+        // If we don't understand this hint, encode the body as a byte string. The byte string
+        // will include a tag and length header as a prefix.
+        if (adapter == null) {
+          (OCTET_STRING as DerAdapter<Any?>).encode(writer, value)
+          return
+        }
+
+        writer.write(adapter as DerAdapter<Any?>, value)
+      }
+
+      override fun decode(reader: DerReader, header: DerHeader): Any? {
+        val adapter = chooser(reader.typeHint)
+
+        // If we don't understand this hint, decode the body as a byte string. The byte string
+        // will include a tag and length header as a prefix.
+        if (adapter == null) {
+          return OCTET_STRING.decode(reader, header)
+        }
+
+        return reader.read(adapter as DerAdapter<Any?>)
+      }
+    }
+  }
+
   /**
    * Object class to adapter type. This approach limits us to one adapter per Kotlin class, which
    * might be too few for values like UTF_STRING and OBJECT_IDENTIFIER that share a Kotlin class but
diff --git a/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/CertificateAdapters.kt b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/CertificateAdapters.kt
index 9bcaccfb5..49b1ee85e 100644
--- a/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/CertificateAdapters.kt
+++ b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/CertificateAdapters.kt
@@ -16,7 +16,6 @@
 package okhttp3.tls.internal.der
 
 import java.math.BigInteger
-import okio.ByteString
 
 /**
  * ASN.1 adapters adapted from the specifications in [RFC 5280][rfc_5280].
@@ -75,6 +74,66 @@ internal object CertificateAdapters {
       construct = { AlgorithmIdentifier(it[0] as String, it[1]) }
   )
 
+  /**
+   * ```
+   * BasicConstraints ::= SEQUENCE {
+   *   cA                      BOOLEAN DEFAULT FALSE,
+   *   pathLenConstraint       INTEGER (0..MAX) OPTIONAL
+   * }
+   * ```
+   */
+  internal val basicConstraints = Adapters.sequence(
+      Adapters.BOOLEAN.optional(defaultValue = false),
+      Adapters.INTEGER_AS_LONG.optional(),
+      decompose = { listOf(it.ca, it.pathLenConstraint) },
+      construct = { BasicConstraints(it[0] as Boolean, it[1] as Long?) }
+  )
+
+  /**
+   * Note that only a subset of available choices are implemented.
+   *
+   * ```
+   * GeneralName ::= CHOICE {
+   *   otherName                       [0]     OtherName,
+   *   rfc822Name                      [1]     IA5String,
+   *   dNSName                         [2]     IA5String,
+   *   x400Address                     [3]     ORAddress,
+   *   directoryName                   [4]     Name,
+   *   ediPartyName                    [5]     EDIPartyName,
+   *   uniformResourceIdentifier       [6]     IA5String,
+   *   iPAddress                       [7]     OCTET STRING,
+   *   registeredID                    [8]     OBJECT IDENTIFIER
+   * }
+   * ```
+   */
+  internal val generalNameDnsName = Adapters.IA5_STRING.withTag(tag = 2L)
+  internal val generalNameIpAddress = Adapters.OCTET_STRING.withTag(tag = 7L)
+  internal val generalName = Adapters.choice(
+      generalNameDnsName,
+      generalNameIpAddress
+  )
+
+  /**
+   * ```
+   * SubjectAltName ::= GeneralNames
+   *
+   * GeneralNames ::= SEQUENCE SIZE (1..MAX) OF GeneralName
+   * ```
+   */
+  internal val subjectAltName = generalName.asSequenceOf()
+
+  /**
+   * This uses the preceding extension ID to select which adapter to use for the extension value
+   * that follows.
+   */
+  internal val extensionValue = Adapters.usingTypeHint { typeHint ->
+    when (typeHint) {
+      ObjectIdentifiers.subjectAltName -> subjectAltName
+      ObjectIdentifiers.basicConstraints -> basicConstraints
+      else -> null
+    }
+  }
+
   /**
    * ```
    * Extension ::= SEQUENCE  {
@@ -88,11 +147,11 @@ internal object CertificateAdapters {
    * ```
    */
   internal val extension = Adapters.sequence(
-      Adapters.OBJECT_IDENTIFIER,
+      Adapters.OBJECT_IDENTIFIER.asTypeHint(),
       Adapters.BOOLEAN.optional(defaultValue = false),
-      Adapters.OCTET_STRING,
+      extensionValue,
       decompose = { listOf(it.extnID, it.critical, it.extnValue) },
-      construct = { Extension(it[0] as String, it[1] as Boolean, it[2] as ByteString) }
+      construct = { Extension(it[0] as String, it[1] as Boolean, it[2]) }
   )
 
   /**
diff --git a/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/DerAdapter.kt b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/DerAdapter.kt
index c15c8f226..fbbdb2cde 100644
--- a/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/DerAdapter.kt
+++ b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/DerAdapter.kt
@@ -22,7 +22,7 @@ import okio.IOException
 /**
  * Reads a DER tag class, tag, length, and value and decodes it as value.
  */
-internal abstract class DerAdapter<T>(
+internal abstract class DerAdapter<T> private constructor(
   /** The tag class this adapter expects, or -1 to match any tag class. */
   val tagClass: Int,
 
@@ -30,11 +30,22 @@ internal abstract class DerAdapter<T>(
   val tag: Long,
 
   /** True if the default value should be used if this value is absent during decoding. */
-  val isOptional: Boolean = false,
+  val isOptional: Boolean,
 
   /** The value to return if this value is absent. Undefined unless this is optional. */
-  val defaultValue: T? = null
+  val defaultValue: T?,
+
+  /** True to set the encoded or decoded value as the type hint for the current SEQUENCE. */
+  val typeHint: Boolean
 ) {
+  internal constructor(tagClass: Int, tag: Long) : this(
+      tagClass = tagClass,
+      tag = tag,
+      isOptional = false,
+      defaultValue = null,
+      typeHint = false
+  )
+
   /**
    * Returns true if this adapter decodes values with [tagClass] and [tag]. Most adapters match
    * exactly one tag class and tag, but ANY adapters match anything and CHOICE adapters match
@@ -76,8 +87,9 @@ internal abstract class DerAdapter<T>(
     tagClass: Int = this.tagClass,
     tag: Long = this.tag,
     isOptional: Boolean = this.isOptional,
-    defaultValue: T? = this.defaultValue
-  ): DerAdapter<T> = object : DerAdapter<T>(tagClass, tag, isOptional, defaultValue) {
+    defaultValue: T? = this.defaultValue,
+    typeHint: Boolean = this.typeHint
+  ): DerAdapter<T> = object : DerAdapter<T>(tagClass, tag, isOptional, defaultValue, typeHint) {
     override fun encode(writer: DerWriter, value: T) = this@DerAdapter.encode(writer, value)
 
     override fun decode(reader: DerReader, header: DerHeader): T =
@@ -120,6 +132,14 @@ internal abstract class DerAdapter<T>(
     )
   }
 
+  /**
+   * Returns a copy of this adapter that sets the encoded or decoded value as the type hint for the
+   * other adapters on this SEQUENCE to interrogate.
+   */
+  fun asTypeHint(): DerAdapter<T> {
+    return copy(typeHint = true)
+  }
+
   /**
    * Returns an adapter that expects this value wrapped by another value. Typically this occurs
    * when a value has both a context or application tag and a universal tag.
diff --git a/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/DerReader.kt b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/DerReader.kt
index 369028375..50eaa9051 100644
--- a/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/DerReader.kt
+++ b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/DerReader.kt
@@ -55,6 +55,19 @@ internal class DerReader(source: Source) {
   val peekedTag: Long
     get() = peekedHeader?.tag ?: error("peekedTag only accessible after hasNext")
 
+  /** Type hints scoped to the call stack, manipulated with [pushTypeHint] and [popTypeHint]. */
+  private val typeHintStack = mutableListOf<Any?>()
+
+  /**
+   * The type hint for the current object. Used to pick adapters based on other fields, such as
+   * in extensions which have different types depending on their extension ID.
+   */
+  var typeHint: Any?
+    get() = typeHintStack.lastOrNull()
+    set(value) {
+      typeHintStack.set(typeHintStack.size - 1, value)
+    }
+
   private var constructed: Boolean = false
 
   private var peekedHeader: DerHeader? = null
@@ -154,6 +167,14 @@ internal class DerReader(source: Source) {
     return DerHeader(tagClass, tag, constructed, length)
   }
 
+  fun pushTypeHint() {
+    typeHintStack.add(null)
+  }
+
+  fun popTypeHint() {
+    typeHintStack.removeAt(typeHintStack.size - 1)
+  }
+
   fun readBoolean(): Boolean {
     if (bytesLeft != 1L) throw ProtocolException("unexpected length: $bytesLeft")
     return source.readByte().toInt() != 0
diff --git a/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/DerWriter.kt b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/DerWriter.kt
index 0ed8b6b20..28340e24c 100644
--- a/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/DerWriter.kt
+++ b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/DerWriter.kt
@@ -24,6 +24,19 @@ internal class DerWriter(sink: BufferedSink) {
   /** A stack of buffers that will be concatenated once we know the length of each. */
   private val stack = mutableListOf(sink)
 
+  /** Type hints scoped to the call stack, manipulated with [pushTypeHint] and [popTypeHint]. */
+  private val typeHintStack = mutableListOf<Any?>()
+
+  /**
+   * The type hint for the current object. Used to pick adapters based on other fields, such as
+   * in extensions which have different types depending on their extension ID.
+   */
+  var typeHint: Any?
+    get() = typeHintStack.lastOrNull()
+    set(value) {
+      typeHintStack[typeHintStack.size - 1] = value
+    }
+
   /** False unless we made a recursive call to [write] at the current stack frame. */
   private var constructed = false
 
@@ -83,6 +96,22 @@ internal class DerWriter(sink: BufferedSink) {
     sink.writeAll(content)
   }
 
+  /**
+   * Create a new namespace for type hints. Type hints from the enclosing type are no longer usable
+   * by the current type's members.
+   */
+  fun pushTypeHint() {
+    typeHintStack.add(null)
+  }
+
+  /**
+   * Remove the current namespace when it is going out of scope. Calls to [pushTypeHint] and
+   * [popTypeHint] should be balanced.
+   */
+  fun popTypeHint() {
+    typeHintStack.removeAt(typeHintStack.size - 1)
+  }
+
   private fun sink(): BufferedSink = stack[stack.size - 1]
 
   fun writeBoolean(b: Boolean) {
diff --git a/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/ObjectIdentifiers.kt b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/ObjectIdentifiers.kt
new file mode 100644
index 000000000..2998deaad
--- /dev/null
+++ b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/ObjectIdentifiers.kt
@@ -0,0 +1,22 @@
+/*
+ * Copyright (C) 2020 Square, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package okhttp3.tls.internal.der
+
+/** ASN.1 object identifiers used internally by this implementation. */
+internal object ObjectIdentifiers {
+  val subjectAltName = "2.5.29.17"
+  val basicConstraints = "2.5.29.19"
+}
diff --git a/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/certificates.kt b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/certificates.kt
index b977a248c..83a6b2b94 100644
--- a/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/certificates.kt
+++ b/okhttp-tls/src/main/kotlin/okhttp3/tls/internal/der/certificates.kt
@@ -16,7 +16,6 @@
 package okhttp3.tls.internal.der
 
 import java.math.BigInteger
-import okio.ByteString
 
 internal data class Certificate(
   val tbsCertificate: TbsCertificate,
@@ -93,5 +92,10 @@ internal data class SubjectPublicKeyInfo(
 internal data class Extension(
   val extnID: String,
   val critical: Boolean,
-  val extnValue: ByteString
+  val extnValue: Any?
+)
+
+internal data class BasicConstraints(
+  val ca: Boolean,
+  val pathLenConstraint: Long?
 )

diff --git a/kotlin/codegen/build.gradle.kts b/kotlin/codegen/build.gradle.kts
index d8aa2fa1..19c0bb04 100644
--- a/kotlin/codegen/build.gradle.kts
+++ b/kotlin/codegen/build.gradle.kts
@@ -65,9 +65,11 @@ dependencies {
     exclude(group = "org.jetbrains.kotlin")
     exclude(group = "com.squareup", module = "kotlinpoet")
   }
+  api(Dependencies.KotlinPoet.elementsClassInspector)
   shade(Dependencies.KotlinPoet.elementsClassInspector) {
     exclude(group = "org.jetbrains.kotlin")
     exclude(group = "com.squareup", module = "kotlinpoet")
+    exclude(group = "com.google.guava")
   }
   api(Dependencies.asm)
 
diff --git a/kotlin/codegen/src/main/java/com/squareup/moshi/kotlin/codegen/metadata.kt b/kotlin/codegen/src/main/java/com/squareup/moshi/kotlin/codegen/metadata.kt
index b3bdd11a..7f676bbb 100644
--- a/kotlin/codegen/src/main/java/com/squareup/moshi/kotlin/codegen/metadata.kt
+++ b/kotlin/codegen/src/main/java/com/squareup/moshi/kotlin/codegen/metadata.kt
@@ -483,7 +483,10 @@ internal fun TargetProperty.generator(
 private fun List<AnnotationSpec>?.qualifiers(elements: Elements): Set<AnnotationSpec> {
   if (this == null) return setOf()
   return filterTo(mutableSetOf()) {
-    elements.getTypeElement(it.typeName.toString()).getAnnotation(JSON_QUALIFIER) != null
+    val typeElement = checkNotNull(elements.getTypeElement(it.typeName.rawType().canonicalName)) {
+      "Could not get the type element of $it"
+    }
+    typeElement.getAnnotation(JSON_QUALIFIER) != null
   }
 }
 

diff --git a/.github/workflows/build.yml b/.github/workflows/build.yml
index b5731a035..8a7b46e4b 100644
--- a/.github/workflows/build.yml
+++ b/.github/workflows/build.yml
@@ -563,19 +563,26 @@ jobs:
         env:
           API_LEVEL: ${{ matrix.api-level }}
 
+      - name: Run Release Tests
+        uses: reactivecircus/android-emulator-runner@v2
+        with:
+          api-level: ${{ matrix.api-level }}
+          arch: ${{ matrix.api-level == '34' && 'x86_64' || 'x86' }}
+          script: ./gradlew :android-test-app:connectedCheck
+        env:
+          API_LEVEL: ${{ matrix.api-level }}
+
       - name: Build Release App
         run: ./gradlew android-test-app:lint android-test-app:assembleRelease
 
-#  Can't run with AGP 9
-#  java.lang.NoClassDefFoundError: Failed resolution of: Landroidx/tracing/Trace;
-#      - name: Run Release Tests
-#        uses: reactivecircus/android-emulator-runner@v2
-#        with:
-#          api-level: ${{ matrix.api-level }}
-#          arch: ${{ matrix.api-level == '34' && 'x86_64' || 'x86' }}
-#          script: ./gradlew :android-test-app:connectedReleaseAndroidTest
-#        env:
-#          API_LEVEL: ${{ matrix.api-level }}
+      - name: Run Release Tests
+        uses: reactivecircus/android-emulator-runner@v2
+        with:
+          api-level: ${{ matrix.api-level }}
+          arch: ${{ matrix.api-level == '34' && 'x86_64' || 'x86' }}
+          script: ./gradlew :android-test-app:connectedReleaseAndroidTest
+        env:
+          API_LEVEL: ${{ matrix.api-level }}
 
   testloom:
     runs-on: ubuntu-latest
diff --git a/android-test/src/androidDeviceTest/README.md b/android-test/src/androidTest/README.md
similarity index 100%
rename from android-test/src/androidDeviceTest/README.md
rename to android-test/src/androidTest/README.md
diff --git a/android-test/src/androidDeviceTest/java/okhttp/android/test/OkHttpTest.kt b/android-test/src/androidTest/java/okhttp/android/test/OkHttpTest.kt
similarity index 100%
rename from android-test/src/androidDeviceTest/java/okhttp/android/test/OkHttpTest.kt
rename to android-test/src/androidTest/java/okhttp/android/test/OkHttpTest.kt
diff --git a/android-test/src/androidDeviceTest/java/okhttp/android/test/SingleAndroidTest.kt b/android-test/src/androidTest/java/okhttp/android/test/SingleAndroidTest.kt
similarity index 100%
rename from android-test/src/androidDeviceTest/java/okhttp/android/test/SingleAndroidTest.kt
rename to android-test/src/androidTest/java/okhttp/android/test/SingleAndroidTest.kt
diff --git a/android-test/src/androidDeviceTest/java/okhttp/android/test/StrictModeTest.kt b/android-test/src/androidTest/java/okhttp/android/test/StrictModeTest.kt
similarity index 100%
rename from android-test/src/androidDeviceTest/java/okhttp/android/test/StrictModeTest.kt
rename to android-test/src/androidTest/java/okhttp/android/test/StrictModeTest.kt
diff --git a/android-test/src/androidDeviceTest/java/okhttp/android/test/alpn/AlpnOverrideTest.kt b/android-test/src/androidTest/java/okhttp/android/test/alpn/AlpnOverrideTest.kt
similarity index 100%
rename from android-test/src/androidDeviceTest/java/okhttp/android/test/alpn/AlpnOverrideTest.kt
rename to android-test/src/androidTest/java/okhttp/android/test/alpn/AlpnOverrideTest.kt
diff --git a/android-test/src/androidDeviceTest/java/okhttp/android/test/letsencrypt/LetsEncryptClientTest.kt b/android-test/src/androidTest/java/okhttp/android/test/letsencrypt/LetsEncryptClientTest.kt
similarity index 100%
rename from android-test/src/androidDeviceTest/java/okhttp/android/test/letsencrypt/LetsEncryptClientTest.kt
rename to android-test/src/androidTest/java/okhttp/android/test/letsencrypt/LetsEncryptClientTest.kt
diff --git a/android-test/src/androidDeviceTest/java/okhttp/android/test/sni/SniOverrideTest.kt b/android-test/src/androidTest/java/okhttp/android/test/sni/SniOverrideTest.kt
similarity index 100%
rename from android-test/src/androidDeviceTest/java/okhttp/android/test/sni/SniOverrideTest.kt
rename to android-test/src/androidTest/java/okhttp/android/test/sni/SniOverrideTest.kt
diff --git a/gradle.properties b/gradle.properties
index 5ee973826..1b38621e4 100644
--- a/gradle.properties
+++ b/gradle.properties
@@ -13,6 +13,6 @@ okhttpDokka=false
 
 org.gradle.jvmargs='-Dfile.encoding=UTF-8'
 
-# AGP 9.0 Settings
-android.builtInKotlin=true
-android.newDsl=true
+# AGP 9.0 Workarounds
+android.builtInKotlin=false
+android.newDsl=false
diff --git a/okhttp/build.gradle.kts b/okhttp/build.gradle.kts
index 83353a6b7..ba9e1bdcd 100644
--- a/okhttp/build.gradle.kts
+++ b/okhttp/build.gradle.kts
@@ -2,6 +2,7 @@
 
 import com.vanniktech.maven.publish.JavadocJar
 import com.vanniktech.maven.publish.KotlinMultiplatform
+import org.jetbrains.kotlin.gradle.dsl.JvmTarget
 import org.jetbrains.kotlin.gradle.tasks.KotlinCompile
 import org.jetbrains.kotlin.gradle.tasks.KotlinJvmCompile
 import ru.vyarus.gradle.plugin.animalsniffer.AnimalSniffer
@@ -9,7 +10,7 @@ import ru.vyarus.gradle.plugin.animalsniffer.AnimalSnifferExtension
 
 plugins {
   kotlin("multiplatform")
-  id("com.android.kotlin.multiplatform.library")
+  id("com.android.library")
   kotlin("plugin.serialization")
   id("com.vanniktech.maven.publish.base")
   id("binary-compatibility-validator")
@@ -53,32 +54,9 @@ kotlin {
   jvm {
   }
 
-  androidLibrary {
-    namespace = "okhttp.okhttp3"
-    compileSdk = 35
-    minSdk = 21
-
-    androidResources {
-      enable = true
-    }
-
-    optimization {
-      consumerKeepRules.publish = true
-      consumerKeepRules.files.add(file("okhttp3.pro"))
-    }
-
-    withDeviceTest {
-      instrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
-      execution = "HOST"
-    }
-
-    // SDK 35 needs 17, for now avoid trying to run on
-    // multiple robolectric versions, since device tests
-    // do that
-    if (testJavaVersion >= 17) {
-      withHostTest {
-        isIncludeAndroidResources = true
-      }
+  androidTarget {
+    compilerOptions {
+      jvmTarget.set(JvmTarget.JVM_17)
     }
   }
 
@@ -179,19 +157,17 @@ kotlin {
       }
     }
 
-    if (testJavaVersion >= 17) {
-      val androidHostTest by getting {
-        dependencies {
-          implementation(libs.assertk)
-          implementation(libs.kotlin.test.annotations)
-          implementation(libs.kotlin.test.common)
-          implementation(libs.androidx.junit)
+    val androidUnitTest by getting {
+      dependencies {
+        implementation(libs.assertk)
+        implementation(libs.kotlin.test.annotations)
+        implementation(libs.kotlin.test.common)
+        implementation(libs.androidx.junit)
 
-          implementation(libs.junit.jupiter.engine)
-          implementation(libs.junit.vintage.engine)
+        implementation(libs.junit.jupiter.engine)
+        implementation(libs.junit.vintage.engine)
 
-          implementation(libs.robolectric)
-        }
+        implementation(libs.robolectric)
       }
     }
   }
@@ -210,7 +186,30 @@ if (platform == "jdk8alpn") {
   }
 }
 
+android {
+  compileSdk = 35
 
+  namespace = "okhttp.okhttp3"
+
+  defaultConfig {
+    minSdk = 21
+
+    consumerProguardFiles("okhttp3.pro")
+  }
+
+  testOptions {
+    unitTests {
+      isIncludeAndroidResources = true
+    }
+  }
+
+  sourceSets {
+    named("main") {
+      manifest.srcFile("src/androidMain/AndroidManifest.xml")
+      assets.srcDir("src/androidMain/assets")
+    }
+  }
+}
 
 // From https://github.com/Kotlin/kotlinx-atomicfu/blob/master/atomicfu/build.gradle.kts
 val compileJavaModuleInfo by tasks.registering(JavaCompile::class) {
@@ -347,6 +346,13 @@ afterEvaluate {
       // https://cs.android.com/android-studio/platform/tools/base/+/mirror-goog-studio-main:build-system/gradle-core/src/main/java/com/android/build/gradle/tasks/factory/AndroidUnitTest.java;l=339
       allJvmArgs = allJvmArgs.filter { !it.startsWith("--add-opens") }
     }
+    if (name.matches("test.*UnitTest".toRegex()) && javaLauncher.get().metadata.languageVersion.asInt() < 17) {
+      // Work around robolectric requirements and limitations
+      // https://github.com/robolectric/robolectric/issues/10419
+      filter {
+        excludeTest("okhttp3.internal.publicsuffix.PublicSuffixDatabaseTest", null)
+      }
+    }
   }
 }
 
@@ -362,5 +368,5 @@ tasks.withType<KotlinCompile> {
 apply(plugin = "io.github.usefulness.maven-sympathy")
 
 mavenPublishing {
-  configure(KotlinMultiplatform(javadocJar = JavadocJar.Empty()))
+  configure(KotlinMultiplatform(javadocJar = JavadocJar.Empty(), androidVariantsToPublish = listOf("release")))
 }
diff --git a/okhttp/src/androidHostTest/kotlin/okhttp3/internal/publicsuffix/PublicSuffixTesting.android.kt b/okhttp/src/androidUnitTest/kotlin/okhttp3/internal/publicsuffix/PublicSuffixTesting.android.kt
similarity index 100%
rename from okhttp/src/androidHostTest/kotlin/okhttp3/internal/publicsuffix/PublicSuffixTesting.android.kt
rename to okhttp/src/androidUnitTest/kotlin/okhttp3/internal/publicsuffix/PublicSuffixTesting.android.kt

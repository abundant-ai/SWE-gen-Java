diff --git a/android-test/src/androidDeviceTest/README.md b/android-test/src/androidDeviceTest/README.md
new file mode 100644
index 000000000..8d485e222
--- /dev/null
+++ b/android-test/src/androidDeviceTest/README.md
@@ -0,0 +1,55 @@
+Android Test
+============
+
+A gradle module for running Android instrumentation tests on a device or emulator.
+
+1. Add an Emulator named `pixel5`, if you don't already have one
+
+```
+$ sdkmanager --install "system-images;android-29;google_apis;x86"
+$ echo "no" | avdmanager --verbose create avd --force --name "pixel5" --device "pixel" --package "system-images;android-29;google_apis;x86" --tag "google_apis" --abi "x86"
+```
+
+2. Run an Emulator using Android Studio or from command line.
+
+```
+$ emulator -no-window -no-snapshot-load @pixel5
+```
+
+2. Turn on logs with logcat
+
+```
+$ adb logcat '*:E' OkHttp:D Http2:D TestRunner:D TaskRunner:D OkHttpTest:D GnssHAL_GnssInterface:F DeviceStateChecker:F memtrack:F
+...
+01-01 12:53:32.811 10999 11089 D OkHttp  : [49 ms] responseHeadersEnd: Response{protocol=h2, code=200, message=, url=https://1.1.1.1/dns-query?dns=AAABAAABAAAAAAAAA3d3dwhmYWNlYm9vawNjb20AABwAAQ}
+01-01 12:53:32.811 10999 11089 D OkHttp  : [49 ms] responseBodyStart
+01-01 12:53:32.811 10999 11089 D OkHttp  : [49 ms] responseBodyEnd: byteCount=128
+01-01 12:53:32.811 10999 11089 D OkHttp  : [49 ms] connectionReleased
+01-01 12:53:32.811 10999 11089 D OkHttp  : [49 ms] callEnd
+01-01 12:53:32.816 10999 11090 D OkHttp  : [54 ms] responseHeadersStart
+01-01 12:53:32.816 10999 11090 D OkHttp  : [54 ms] responseHeadersEnd: Response{protocol=h2, code=200, message=, url=https://1.1.1.1/dns-query?dns=AAABAAABAAAAAAAAA3d3dwhmYWNlYm9vawNjb20AAAEAAQ}
+01-01 12:53:32.817 10999 11090 D OkHttp  : [55 ms] responseBodyStart
+01-01 12:53:32.818 10999 11090 D OkHttp  : [56 ms] responseBodyEnd: byteCount=128
+01-01 12:53:32.818 10999 11090 D OkHttp  : [56 ms] connectionReleased
+01-01 12:53:32.818 10999 11090 D OkHttp  : [56 ms] callEnd
+```
+
+3. Run tests using gradle
+
+```
+$ ANDROID_SDK_ROOT=/Users/myusername/Library/Android/sdk ./gradlew :android-test:connectedCheck -PandroidBuild=true
+...
+> Task :android-test:connectedDebugAndroidTest
+...
+11:55:40 V/InstrumentationResultParser: Time: 13.271
+11:55:40 V/InstrumentationResultParser:
+11:55:40 V/InstrumentationResultParser: OK (12 tests)
+...
+11:55:40 I/XmlResultReporter: XML test result file generated at /Users/myusername/workspace/okhttp/android-test/build/outputs/androidTest-results/connected/TEST-pixel3a-Q(AVD) - 10-android-test-.xml. Total tests 13, passed 11, assumption_failure 1, ignored 1,
+...
+BUILD SUCCESSFUL in 1m 30s
+63 actionable tasks: 61 executed, 2 up-to-date
+
+```
+
+n.b. use ANDROID_SERIAL=emulator-5554 or similar if you need to select between devices.
diff --git a/gradle.properties b/gradle.properties
index 1b38621e4..5ee973826 100644
--- a/gradle.properties
+++ b/gradle.properties
@@ -13,6 +13,6 @@ okhttpDokka=false
 
 org.gradle.jvmargs='-Dfile.encoding=UTF-8'
 
-# AGP 9.0 Workarounds
-android.builtInKotlin=false
-android.newDsl=false
+# AGP 9.0 Settings
+android.builtInKotlin=true
+android.newDsl=true
diff --git a/okhttp/build.gradle.kts b/okhttp/build.gradle.kts
index ba9e1bdcd..83353a6b7 100644
--- a/okhttp/build.gradle.kts
+++ b/okhttp/build.gradle.kts
@@ -2,7 +2,6 @@
 
 import com.vanniktech.maven.publish.JavadocJar
 import com.vanniktech.maven.publish.KotlinMultiplatform
-import org.jetbrains.kotlin.gradle.dsl.JvmTarget
 import org.jetbrains.kotlin.gradle.tasks.KotlinCompile
 import org.jetbrains.kotlin.gradle.tasks.KotlinJvmCompile
 import ru.vyarus.gradle.plugin.animalsniffer.AnimalSniffer
@@ -10,7 +9,7 @@ import ru.vyarus.gradle.plugin.animalsniffer.AnimalSnifferExtension
 
 plugins {
   kotlin("multiplatform")
-  id("com.android.library")
+  id("com.android.kotlin.multiplatform.library")
   kotlin("plugin.serialization")
   id("com.vanniktech.maven.publish.base")
   id("binary-compatibility-validator")
@@ -54,9 +53,32 @@ kotlin {
   jvm {
   }
 
-  androidTarget {
-    compilerOptions {
-      jvmTarget.set(JvmTarget.JVM_17)
+  androidLibrary {
+    namespace = "okhttp.okhttp3"
+    compileSdk = 35
+    minSdk = 21
+
+    androidResources {
+      enable = true
+    }
+
+    optimization {
+      consumerKeepRules.publish = true
+      consumerKeepRules.files.add(file("okhttp3.pro"))
+    }
+
+    withDeviceTest {
+      instrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
+      execution = "HOST"
+    }
+
+    // SDK 35 needs 17, for now avoid trying to run on
+    // multiple robolectric versions, since device tests
+    // do that
+    if (testJavaVersion >= 17) {
+      withHostTest {
+        isIncludeAndroidResources = true
+      }
     }
   }
 
@@ -157,17 +179,19 @@ kotlin {
       }
     }
 
-    val androidUnitTest by getting {
-      dependencies {
-        implementation(libs.assertk)
-        implementation(libs.kotlin.test.annotations)
-        implementation(libs.kotlin.test.common)
-        implementation(libs.androidx.junit)
+    if (testJavaVersion >= 17) {
+      val androidHostTest by getting {
+        dependencies {
+          implementation(libs.assertk)
+          implementation(libs.kotlin.test.annotations)
+          implementation(libs.kotlin.test.common)
+          implementation(libs.androidx.junit)
 
-        implementation(libs.junit.jupiter.engine)
-        implementation(libs.junit.vintage.engine)
+          implementation(libs.junit.jupiter.engine)
+          implementation(libs.junit.vintage.engine)
 
-        implementation(libs.robolectric)
+          implementation(libs.robolectric)
+        }
       }
     }
   }
@@ -186,30 +210,7 @@ if (platform == "jdk8alpn") {
   }
 }
 
-android {
-  compileSdk = 35
 
-  namespace = "okhttp.okhttp3"
-
-  defaultConfig {
-    minSdk = 21
-
-    consumerProguardFiles("okhttp3.pro")
-  }
-
-  testOptions {
-    unitTests {
-      isIncludeAndroidResources = true
-    }
-  }
-
-  sourceSets {
-    named("main") {
-      manifest.srcFile("src/androidMain/AndroidManifest.xml")
-      assets.srcDir("src/androidMain/assets")
-    }
-  }
-}
 
 // From https://github.com/Kotlin/kotlinx-atomicfu/blob/master/atomicfu/build.gradle.kts
 val compileJavaModuleInfo by tasks.registering(JavaCompile::class) {
@@ -346,13 +347,6 @@ afterEvaluate {
       // https://cs.android.com/android-studio/platform/tools/base/+/mirror-goog-studio-main:build-system/gradle-core/src/main/java/com/android/build/gradle/tasks/factory/AndroidUnitTest.java;l=339
       allJvmArgs = allJvmArgs.filter { !it.startsWith("--add-opens") }
     }
-    if (name.matches("test.*UnitTest".toRegex()) && javaLauncher.get().metadata.languageVersion.asInt() < 17) {
-      // Work around robolectric requirements and limitations
-      // https://github.com/robolectric/robolectric/issues/10419
-      filter {
-        excludeTest("okhttp3.internal.publicsuffix.PublicSuffixDatabaseTest", null)
-      }
-    }
   }
 }
 
@@ -368,5 +362,5 @@ tasks.withType<KotlinCompile> {
 apply(plugin = "io.github.usefulness.maven-sympathy")
 
 mavenPublishing {
-  configure(KotlinMultiplatform(javadocJar = JavadocJar.Empty(), androidVariantsToPublish = listOf("release")))
+  configure(KotlinMultiplatform(javadocJar = JavadocJar.Empty()))
 }
diff --git a/okhttp/src/androidHostTest/kotlin/okhttp3/internal/publicsuffix/PublicSuffixTesting.android.kt b/okhttp/src/androidHostTest/kotlin/okhttp3/internal/publicsuffix/PublicSuffixTesting.android.kt
new file mode 100644
index 000000000..ff93f6c41
--- /dev/null
+++ b/okhttp/src/androidHostTest/kotlin/okhttp3/internal/publicsuffix/PublicSuffixTesting.android.kt
@@ -0,0 +1,26 @@
+/*
+ * Copyright (C) 2024 Block, Inc.
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *      http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+package okhttp3.internal.publicsuffix
+
+import androidx.test.core.app.ApplicationProvider
+import okhttp3.internal.platform.PlatformRegistry
+import org.robolectric.RobolectricTestRunner
+
+actual typealias PublicSuffixTestRunner = RobolectricTestRunner
+
+actual fun beforePublicSuffixTest() {
+  PlatformRegistry.applicationContext = ApplicationProvider.getApplicationContext()
+}
